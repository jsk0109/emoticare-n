<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒ‰ìƒ ê°ì • ì¼ê¸° - EmotiCare</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .journal-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem; /* ì „ì²´ ì»¨í…Œì´ë„ˆ íŒ¨ë”© ì¶•ì†Œ */
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
            background: white;
            padding: 1rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .month-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .month-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.4rem; /* ë²„íŠ¼ íŒ¨ë”© ì•½ê°„ ì¶•ì†Œ */
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .month-nav button:hover {
            background: #764ba2;
            transform: scale(1.1);
        }
        
        .current-month {
            font-size: 1.3rem; /* í°íŠ¸ í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
            font-weight: 600;
            color: #333;
        }
        
        .emotion-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap; /* ëª¨ë°”ì¼ì—ì„œ ì¤„ë°”ê¿ˆ ìœ ì§€ */
        }
        
        .emotion-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .emotion-color {
            width: 18px; /* í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
            height: 18px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .calendar {
            background: white;
            border-radius: 15px;
            padding: 1rem; /* íŒ¨ë”© ì¶•ì†Œ */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e1e8ed;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .calendar-day-header {
            background: #667eea;
            color: white;
            padding: 0.75rem; /* íŒ¨ë”© ì¶•ì†Œ */
            text-align: center;
            font-weight: 600;
        }
        
        .calendar-day {
            background: white;
            padding: 0.4rem; /* íŒ¨ë”© ì•½ê°„ ëŠ˜ë¦¼ */
            min-height: 90px; /* ìµœì†Œ ë†’ì´ë¥¼ ì¡°ê¸ˆ ë” í™•ë³´ */
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* ìš”ì†Œë“¤ì„ ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ ë°°ì¹˜ */
        }
        
        .calendar-day:hover {
            background: #f8f9ff;
        }
        
        .calendar-day.other-month {
            color: #ccc;
            background: #f8f9fa;
            pointer-events: none;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .calendar-day.has-emotion {
            border: 3px solid;
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 0.25rem; /* ë©”ëª¨ì™€ì˜ ê°„ê²© */
            z-index: 2; 
            position: relative; 
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem; /* ê°„ê²© ì¶•ì†Œ */
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .stats-card {
            background: white;
            padding: 1.5rem; /* .content-blockê³¼ ë™ì¼í•˜ê²Œ ì¡°ì • */
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stats-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem; /* ë§ˆì§„ ì¶•ì†Œ */
            color: #333;
        }
        
        .emotion-stats {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .emotion-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .emotion-bar {
            flex: 1;
            height: 10px;
            background: #e1e8ed;
            border-radius: 5px;
            margin: 0 1rem;
            overflow: hidden;
        }
        
        .emotion-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .prescription-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem; /* .content-blockê³¼ ë™ì¼í•˜ê²Œ ì¡°ì • */
            border-radius: 15px;
            text-align: center;
        }
        
        .prescription-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .prescription-text {
            font-size: 1.1rem;
            line-height: 1.6;
            white-space: pre-line; 
        }

        .intensity-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
            width: 90%; 
            margin-left: auto; 
            margin-right: auto; 
        }

        .modal-action-buttons {
            display: flex;
            gap: 1rem; 
        }
        .modal-action-buttons button {
            flex: 1; 
            width: auto; 
            padding: 0.8rem 1rem; 
            justify-content: center; 
        }

        .emotion-indicator {
            width: 18px; 
            height: 18px; 
            border-radius: 50%; 
            position: relative; /* ì¼ë°˜ íë¦„ì— í¬í•¨ */
            /* bottom, right ì†ì„± ì œê±° */
            border: 2px solid white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
            z-index: 1; /* z-index ì¡°ì • */
            align-self: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
            margin-top: auto; /* ê°€ëŠ¥í•œ ë§ì€ ê³µê°„ì„ ì°¨ì§€í•˜ë©° ì•„ë˜ë¡œ ë°€ë¦¼ (ë©”ëª¨ê°€ ìˆì„ ë•Œ íš¨ê³¼ì ) */
        }

        .emotion-note-preview {
            font-size: 0.75rem; 
            color: #555; 
            margin-top: 0.2rem;
            line-height: 1.3;
            max-height: 2.4em; /* ë‘ ì¤„ ì •ë„ë¡œ ì œí•œ */
            overflow: hidden; 
            text-overflow: ellipsis; 
            word-break: break-all; 
            z-index: 2; 
            position: relative; 
            margin-bottom: 0.25rem; /* ê°ì • í‘œì‹œê¸°ì™€ì˜ ê°„ê²© */
            min-height: 2.4em; /* ë©”ëª¨ê°€ ì—†ì–´ë„ ë‘ ì¤„ ë†’ì´ í™•ë³´ */
        }

        .year-in-pixels-view {
            background: white;
            border-radius: 15px;
            padding: 1rem; /* íŒ¨ë”© ì¶•ì†Œ */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
            /* display: none; ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬ */
        }

        .year-pixels-header {
            display: flex;
            justify-content: center; /* ë„¤ë¹„ê²Œì´ì…˜ ìš”ì†Œë¥¼ í—¤ë” ì¤‘ì•™ì— ë°°ì¹˜ */
            align-items: center;
            padding: 0 0.5rem; /* í—¤ë” íŒ¨ë”© ì¡°ì • */
            margin-bottom: 1rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }

        .year-pixels-nav { /* ì—°ë„ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
            display: flex;
            align-items: center; /* ë²„íŠ¼ê³¼ ì œëª©ì„ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            gap: 0.5rem; /* ë²„íŠ¼ê³¼ ì œëª© ì‚¬ì´ ê°„ê²© (ê¸°ì¡´ ë²„íŠ¼ ë§ˆì§„ìœ¼ë¡œë„ ê°€ëŠ¥) */
        }

        .year-pixels-header h2 {
            font-size: 1.3rem; /* í°íŠ¸ í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
            color: #333;
            margin: 0;
        }
        .year-pixels-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.4rem; /* ë²„íŠ¼ íŒ¨ë”© ì•½ê°„ ì¶•ì†Œ */
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease; /* ë²„íŠ¼ ì¢Œìš° ë§ˆì§„ì€ gapìœ¼ë¡œ ëŒ€ì²´í•˜ê±°ë‚˜ ìœ ì§€ ê°€ëŠ¥ */
            /* margin: 0 0.5rem; */ /* year-pixels-navì˜ gapìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥ */
        }
        .year-pixels-nav button:hover {
            background: #764ba2;
        }

        .pixels-grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* ëª…í™•í•˜ê²Œ 4ì—´ ê·¸ë¦¬ë“œ ì„¤ì • */
            gap: 0.75rem; /* ì›”ë³„ ê°„ê²© ì¶•ì†Œ */
            padding: 0.75rem; /* ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ íŒ¨ë”© ì¶•ì†Œ */
        }

        .pixel-month-wrapper {
            background: #f8f9fa; /* ê° ì›”ë³„ ë°°ê²½ìƒ‰ */
            border-radius: 10px;
            padding: 0.75rem; /* íŒ¨ë”© ì¶•ì†Œ */
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            /* margin-bottom: 1.5rem; */ /* gap ì†ì„±ìœ¼ë¡œ ëŒ€ì²´ */
        }

        .pixel-month-label {
            text-align: center; /* ì›” ì´ë¦„ ê°€ìš´ë° ì •ë ¬ */
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9em; /* ì›” ì´ë¦„ í°íŠ¸ í¬ê¸° ì¡°ì • */
            color: #333;
        }
        
        .pixels-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px; /* ë‚ ì§œ í”½ì…€ ê°„ê²© ì¡°ì • */
            /* max-width: 300px; ì œê±° ë˜ëŠ” ì¡°ì • */
        }
        .pixel-day {
            width: 100%;
            padding-bottom: 100%; /* ì •ì‚¬ê°í˜• ìœ ì§€ë¥¼ ìœ„í•´ */
            background-color: #efefef;
            border-radius: 2px; /* í”½ì…€ ëª¨ì„œë¦¬ ì•½ê°„ ë‘¥ê¸€ê²Œ */
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease;
        }
        .pixel-day:hover {
            transform: scale(1.1);
            outline: 2px solid #667eea;
            z-index: 10; /* í˜¸ë²„ ì‹œ ë‹¤ë¥¸ ìš”ì†Œ ìœ„ë¡œ ì˜¬ë¼ì˜¤ë„ë¡ */
        }

        /* ëª¨ë°”ì¼ í™”ë©´ì—ì„œ ì¶”ê°€ íŒ¨ë”© ì¡°ì • */
        @media (max-width: 768px) {
            .journal-container {
                padding: 0.75rem;
            }
            .calendar-header, .calendar, .year-in-pixels-view {
                padding: 0.75rem;
            }
            .stats-card, .prescription-card {
                padding: 1rem; /* .content-block ëª¨ë°”ì¼ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ */
            }
            .current-month, .year-pixels-header h2 {
                font-size: 1.1rem;
            }
            .month-nav button, .year-pixels-nav button {
                padding: 0.3rem;
            }
            .calendar-day-header {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">ìƒ‰ìƒ ê°ì • ì¼ê¸°</h1>
                <p class="page-subtitle">ë§¤ì¼ì˜ ê°ì •ì„ ìƒ‰ìƒìœ¼ë¡œ ê¸°ë¡í•˜ê³  ë‚˜ë§Œì˜ ê°ì •íŒ¨í„´ì„ í™•ì¸í•˜ì„¸ìš”</p>
            </div>
        </section>

                </section> <!-- page-header ë‹«ëŠ” íƒœê·¸ -->

        <!-- ì‚¬ìš©ë²• ìš”ì•½ ì„¹ì…˜ ì‹œì‘ -->
        <section class="quick-guide-section">
            <div class="container">
                <h2 class="quick-guide-main-title">
                    ğŸ¨ EmotiCare ìƒ‰ìƒ ê°ì • ì¼ê¸°: ë‚´ ë§ˆìŒì„ ìƒ‰ìƒìœ¼ë¡œ
                </h2>
                
                <div class="quick-guide-grid">
                    <div class="quick-guide-card">
                        <h3 class="quick-guide-card-title guide-title-usage">
                            <i class="fas fa-tasks"></i> ê°ì •ì¼ê¸° 3ë‹¨ê³„:
                        </h3>
                        <ol class="quick-guide-list">
                            <li><strong>ë§ˆìŒ ê¸°ë¡:</strong> ë‹¬ë ¥ì—ì„œ ë‚ ì§œë¥¼ ê³ ë¥´ê³ , ì˜¤ëŠ˜ì˜ ê°ì •(ìƒ‰ìƒ), ê°•ë„, ì§§ì€ ë©”ëª¨ë¥¼ ë‚¨ê²¨ ì €ì¥í•´ìš”.</li>
                            <li><strong>íŒ¨í„´ ë°œê²¬ & ì¡°ì–¸ ì–»ê¸°:</strong> ì›”ë³„ í†µê³„ë¡œ ë‚´ ê°ì • íë¦„ì„ ë³´ê³ , ë§ì¶¤ ë§ˆìŒ ì²˜ë°©ì „ë„ í™•ì¸í•´ìš”.</li>
                            <li><strong>í•œëˆˆì— ë³´ê¸°:</strong> 'ì˜¬í•´ì˜ ìƒ‰ê¹”ë“¤'ë¡œ 1ë…„ì¹˜ ê°ì • ë³€í™”ë¥¼ ì•„ë¦„ë‹¤ìš´ í”½ì…€ ì•„íŠ¸ë¡œ ê°ìƒí•´ìš”. (ê¸°ë¡ì´ ìˆì–´ì•¼ ë³´ì—¬ìš”!)</li>
                        </ol>
                    </div>
                    
                    <div class="quick-guide-card">
                        <h3 class="quick-guide-card-title guide-title-effects">
                            <i class="fas fa-bullseye"></i> ê¸°ëŒ€ íš¨ê³¼:
                        </h3>
                        <ul class="quick-guide-list">
                            <li><strong>ìê¸° ì´í•´ & ë§ˆìŒ ì„±ì¥:</strong> ë‚´ ê°ì •ì„ ê¾¸ì¤€íˆ ê¸°ë¡í•˜ë©´ íŒ¨í„´ì„ í™•ì¸í•˜ê³  ìŠ¤ìŠ¤ë¡œ ë§ˆìŒì˜ ê±´ê°•ì„ íš¨ê³¼ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ìš”.</li>
                            <li><strong>ë‹¤ì±„ë¡œìš´ ê°ì • ì—¬ì • ì‹œê°í™”:</strong> 1ë…„ì˜ ê°ì • ë³€í™”ë¥¼ ìƒ‰ìœ¼ë¡œ í•œëˆˆì— ë³´ë©° ë‚˜ì˜ ì„±ì¥ ê³¼ì •ì„ ì§ê´€ì ìœ¼ë¡œ ëŠê»´ë³´ì„¸ìš”.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        <!-- ì‚¬ìš©ë²• ìš”ì•½ ì„¹ì…˜ ë -->
        
        <section class="page-content">

        
        <section class="page-content">
            <div class="journal-container">
                <div id="monthViewContainer">
                    <div class="calendar-header">
                        <div class="month-nav">
                            <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span class="current-month" id="currentMonth"></span>
                            <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        
                        <div class="emotion-legend">
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #f39c12;"></div>
                                <span>ê¸°ì¨</span>
                            </div>
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #00a693;"></div>
                                <span>í‰ì˜¨</span>
                            </div>
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #8e44ad;"></div>
                                <span>ë¶ˆì•ˆ</span>
                            </div>
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #2980b9;"></div>
                                <span>ìŠ¬í””</span>
                            </div>
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #ee4801;"></div>
                                <span>í™”ë‚¨</span> 
                            </div>
                        </div>
                    </div>
                    
                    <div class="calendar" id="calendar">
                        <div class="calendar-grid" id="calendarGrid">
                        </div>
                    </div>
                    
                    <div class="stats-section">
                        <div class="stats-card">
                            <h3 class="stats-title">ì´ë²ˆ ë‹¬ ê°ì • í†µê³„</h3>
                            <div class="emotion-stats" id="emotionStats">
                            </div>
                        </div>
                        
                        <div class="stats-card">
                            <h3 class="stats-title">ë§ˆìŒ ì²˜ë°©ì „</h3>
                            <div class="prescription-card" id="prescriptionCard">
                                <div class="prescription-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="prescription-text" id="prescriptionText">ê°ì • ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë§ì¶¤ ì²˜ë°©ì „ì„ ì œê³µí•´ë“œë¦½ë‹ˆë‹¤.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="year-in-pixels-view" id="yearInPixelsView" style="display: none;">
                    <div class="year-pixels-header">
                        <div class="year-pixels-nav">
                            <button onclick="changePixelYear(-1)"><i class="fas fa-chevron-left"></i></button>
                            <h2 id="pixelYearDisplay"></h2>
                            <button onclick="changePixelYear(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="pixels-grid-container" id="pixelsGridContainer">
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <button id="toggleViewButton" class="btn-outline" onclick="toggleCalendarView()">
                        ì˜¬í•´ì˜ ìƒ‰ê¹”ë“¤ ë³´ê¸°
                    </button>
                </div>
            </div>
        </section>
    </main>
    
    <div id="emotionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalDate">ê°ì • ê¸°ë¡</h3>
                <button class="modal-close" onclick="closeEmotionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ì˜¤ëŠ˜ì˜ ê°ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”</label>
                    <div class="emotion-selector">
                         <button class="emotion-btn" data-emotion="happy" data-color="#f39c12">
                            <i class="fas fa-laugh"></i>
                            <span>ê¸°ì¨</span>
                        </button>
                        <button class="emotion-btn" data-emotion="calm" data-color="#00a693">
                            <i class="fas fa-smile"></i>
                            <span>í‰ì˜¨</span>
                        </button>
                         <button class="emotion-btn" data-emotion="anxious" data-color="#8e44ad">
                            <i class="fas fa-meh"></i>
                            <span>ë¶ˆì•ˆ</span>
                        </button>
                        <button class="emotion-btn" data-emotion="sad" data-color="#2980b9">
                            <i class="fas fa-sad-tear"></i>
                            <span>ìŠ¬í””</span>
                        </button>
                        <button class="emotion-btn" data-emotion="angry" data-color="#ff0606">
                            <i class="fas fa-angry"></i>
                            <span>í™”ë‚¨</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="emotionIntensity">ê°ì • ê°•ë„ <span style="font-weight:normal; font-size:0.9em;">(1: ì•½í•¨, 5: ê°•í•¨)</span></label>
                    <input type="range" id="emotionIntensity" min="1" max="5" value="3" step="1" style="width: 100%;">
                    <div class="intensity-labels">
                        <span>1</span>
                        <span>2</span>
                        <span>3</span>
                        <span>4</span>
                        <span>5</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="emotionNote">ì˜¤ëŠ˜ í•˜ë£¨ ì¼ê³¼ì™€ ê°ì •ì„ ê°„ë‹¨íˆ ê¸°ë¡í•´ë³´ì„¸ìš”</label>
                    <textarea id="emotionNote" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?"></textarea>
                </div>
                
                <div class="form-group modal-action-buttons">
                    <button class="btn-primary" onclick="saveEmotion()">ì €ì¥í•˜ê¸°</button>
                    <button class="btn-outline" onclick="deleteEmotion()">ì‚­ì œí•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let currentDate = new Date();
        let selectedDate = null;
        let emotionData = {};
        let currentPixelYear = new Date().getFullYear();
        let calendarViewMode = 'month';
        
        const emotions = {
            happy: { name: 'ê¸°ì¨', color: '#f39c12', icon: 'fas fa-laugh' },
            calm: { name: 'í‰ì˜¨', color: '#00a693', icon: 'fas fa-smile' },
            anxious: { name: 'ë¶ˆì•ˆ', color: '#8e44ad', icon: 'fas fa-meh' },
            sad: { name: 'ìŠ¬í””', color: '#2980b9', icon: 'fas fa-sad-tear' },
            angry: { name: 'í™”ë‚¨', color: '#ee4801', icon: 'fas fa-angry' }
        };
        
        const prescriptions = {
            happy: [
                { maxCount: 1, message: "ê¸°ì¨ì„ ì¡°ê¸ˆ ë” ëŠê»´ë³´ì„¸ìš”! ì‘ì€ ê²ƒì—ì„œ í–‰ë³µì„ ì°¾ëŠ” ì—°ìŠµì€ ì–´ë•Œìš”?" },
                { maxCount: 3, message: "ê¸°ë¶„ ì¢‹ì€ ìˆœê°„ë“¤ì´ ìˆì—ˆë„¤ìš”. ì´ ê¸°ì¨ì„ ì£¼ë³€ì— í•¨ê»˜ ë‚˜ëˆ ë³´ì„¸ìš”." },
                { maxCount: 5, message: "ê¸°ì¨ì„ ëŠë¼ëŠ” ë‚ ë“¤ì´ ê½¤ ìˆì—ˆêµ°ìš”! ê¸ì •ì ì¸ ë§ˆìŒì„ ìœ ì§€í•˜ëŠ” ëª¨ìŠµ ë³´ê¸° ì¢‹ì•„ìš”." },
                { maxCount: 7, message: "í–‰ë³µí•œ ì—ë„ˆì§€ê°€ ëŠê»´ì§€ëŠ” ë‹¬ì´ì—ìš”. ì´ ê¸ì • ê¸°ìš´ì„ ì˜ ìœ ì§€í•´ê°€ì„¸ìš”!" },
                { maxCount: 9, message: "ë§ì€ ë‚ ë“¤ì„ ê¸°ì˜ê²Œ ë³´ë‚´ì…¨ë„¤ìš”! ë‹¹ì‹ ì˜ ë°ì€ ì—ë„ˆì§€ê°€ ì£¼ë³€ì„ í™˜í•˜ê²Œ í•´ìš”." },
                { maxCount: 11, message: "ì •ë§ í–‰ë³µí•œ í•œ ë‹¬ì´ì—ˆêµ°ìš”! ì´ ê¸°ì¨ì„ ì¶©ë¶„íˆ ëˆ„ë¦¬ê³  ìœ ì§€í•˜ì„¸ìš”." },
                { maxCount: Infinity, message: "ë§¤ì¼ë§¤ì¼ì´ ê¸°ì¨ìœ¼ë¡œ ê°€ë“ ì°¬ í•œ ë‹¬ì´ì—ˆë„¤ìš”! ë‹¹ì‹ ì€ í–‰ë³µì„ ë§Œë“¤ì–´ê°€ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤." }
            ],
            calm: [
                { maxCount: 1, message: "í‰ì˜¨í•¨ì„ ë” ì°¾ì•„ë³´ëŠ” ê±´ ì–´ë•Œìš”? ì¡°ìš©í•œ ëª…ìƒì´ë‚˜ ì‚°ì±…ì´ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”." },
                { maxCount: 3, message: "ë§ˆìŒì´ í‰ì˜¨í–ˆë˜ ìˆœê°„ë“¤ì´ ìˆì—ˆë„¤ìš”. ê·¸ ëŠë‚Œì„ ë‹¤ì‹œ ë– ì˜¬ë ¤ë³´ì„¸ìš”." },
                { maxCount: 5, message: "ì•ˆì •ì ì¸ ë§ˆìŒ ìƒíƒœë¥¼ ì˜ ìœ ì§€í•˜ê³  ìˆì–´ìš”. ê¾¸ì¤€í•œ ìê¸° ëŒë´„ ë•ë¶„ì¼ ê±°ì˜ˆìš”." },
                { maxCount: 7, message: "ê½¤ í‰ì˜¨í•œ í•œ ë‹¬ì„ ë³´ë‚´ì…¨ë„¤ìš”. ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ë¥¼ ì˜ í•˜ê³  ê³„ì‹  ê²ƒ ê°™ì•„ìš”." },
                { maxCount: 9, message: "ë§¤ìš° í‰ì˜¨í•œ ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ê³„ì‹œëŠ”êµ°ìš”. ë‚´ë©´ì˜ ì•ˆì •ê°ì€ í° ê°•ì ì´ì—ìš”." },
                { maxCount: 11, message: "ëŒ€ë¶€ë¶„ì˜ ì‹œê°„ì„ í‰ì˜¨í•˜ê²Œ ë³´ë‚´ì…¨ë„¤ìš”. ë§ˆìŒì˜ ê· í˜•ì„ ì˜ ì¡ê³  ìˆì–´ìš”." },
                { maxCount: Infinity, message: "ì´ë²ˆ ë‹¬ ëŒ€ë¶€ë¶„ í‰ì˜¨í•¨ì„ ëŠë¼ì…¨êµ°ìš”! ì •ë§ ë©‹ì§„ ë§ˆìŒ ìƒíƒœì…ë‹ˆë‹¤. ì´ í‰ì˜¨í•¨ì„ ê³„ì† ìœ ì§€í•˜ì„¸ìš”." }
            ],
            anxious: [
                { maxCount: 0, message: "ì´ë²ˆ ë‹¬ì—ëŠ” ë¶ˆì•ˆê°ì„ ê±°ì˜ ëŠë¼ì§€ ì•Šìœ¼ì…¨ë„¤ìš”. ì•ˆì •ì ì¸ í•œ ë‹¬ì´ì—ˆë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤." },
                { maxCount: 2, message: "ê°€ë” ë¶ˆì•ˆê°ì„ ëŠë¼ëŠ”êµ°ìš”. ê·¸ëŸ´ ë• ì‹¬í˜¸í¡ì´ë‚˜ ì¢‹ì•„í•˜ëŠ” í™œë™ë“¤ë¡œ ì£¼ì˜ë¥¼ ëŒë ¤ë³´ì„¸ìš”." },
                { maxCount: 4, message: "ì¡°ê¸ˆì”© ë¶ˆì•ˆí•œ ë§ˆìŒì´ ìˆì—ˆë„¤ìš”. ì›ì¸ì„ íŒŒì•…í•˜ê³  ìŠ¤ìŠ¤ë¡œë¥¼ ì¹­ì°¬í•´ì£¼ê³  ë‹¤ë…ì—¬ì£¼ì„¸ìš”." },
                { maxCount: 6, message: "ë¶ˆì•ˆê°ì´ ìì£¼ ëŠê»´ì¡Œë‹¤ë©´, ê·œì¹™ì ì¸ ìƒí™œê³¼ ëª…ìƒì´ë‚˜ íœ´ì‹ì´ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”." },
                { maxCount: 8, message: "ë¶ˆì•ˆí•¨ì´ ê½¤ ëŠê»´ì§€ëŠ” ë‹¬ì´ì—ˆë„¤ìš”. ë§ˆìŒì±™ê¹€ ì—°ìŠµì´ë‚˜ ì´ì™„ ê¸°ë²•ì„ ì‹œë„í•´ë³´ì„¸ìš”." },
                { maxCount: 11, message: "ì§€ì†ì ì¸ ë¶ˆì•ˆì€ ì—ë„ˆì§€ë¥¼ ì†Œëª¨ì‹œì¼œìš”. ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ê³ ë ¤í•´ë³´ëŠ” ê²ƒë„ ì¢‹ì•„ìš”." },
                { maxCount: Infinity, message: "ë†’ì€ ìˆ˜ì¤€ì˜ ë¶ˆì•ˆì„ ê²½í—˜í•˜ê³  ìˆëŠ” ê²ƒ ê°™ì•„ìš”. í˜¼ì í˜ë“¤ì–´í•˜ì§€ ë§ˆì‹œê³  ê¼­ ì „ë¬¸ê°€ì™€ ìƒë‹´í•´ë³´ì„¸ìš”." }
            ],
            sad: [
                { maxCount: 0, message: "ì´ë²ˆ ë‹¬ì—ëŠ” ìŠ¬í””ì„ ê±°ì˜ ëŠë¼ì§€ ì•Šìœ¼ì…¨ë„¤ìš”. ë°ê³  ê¸ì •ì ì¸ í•œ ë‹¬ì´ì—ˆë˜ ê²ƒ ê°™ì•„ìš”." },
                { maxCount: 2, message: "ê°€ë” ìŠ¬í”ˆ ê°ì •ì´ ë“¤ì—ˆêµ°ìš”. ê·¸ ê°ì •ì„ ì¶©ë¶„íˆ ëŠë¼ê³  í˜ë ¤ë³´ë‚´ëŠ” ê²ƒì´ ì¤‘ìš”í•´ìš”." },
                { maxCount: 4, message: "ìŠ¬í””ì„ ëŠê¼ˆë˜ ë‚ ë“¤ì´ ìˆì—ˆë„¤ìš”. ìì‹ ì„ ìœ„ë¡œí•˜ê³  ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒë“¤ê³¼ ì‹œê°„ì„ ë³´ë‚´ì„¸ìš”." },
                { maxCount: 6, message: "ìŠ¬í”ˆ ê°ì •ì´ ìì£¼ ì°¾ì•„ì™”ë‹¤ë©´, ê¸°ë¶„ ì „í™˜ì„ ìœ„í•œ í™œë™ì´ë‚˜ ì·¨ë¯¸ë“¤ì„ ê°€ì ¸ë³´ì„¸ìš”." },
                { maxCount: 8, message: "ë§ˆìŒì´ ì•„íŒ ë˜ ë‚ ë“¤ì´ ê½¤ ìˆì—ˆë„¤ìš”. ìŠ¬í””ì„ í‘œí˜„í•˜ê³  ì£¼ë³€ì— ë„ì›€ì„ ìš”ì²­í•´ë„ ê´œì°®ì•„ìš”." },
                { maxCount: 11, message: "ì§€ì†ì ì¸ ìŠ¬í””ì€ ìš°ìš¸ê°ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”. ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì—¬ ë§ˆìŒì„ ëŒë³´ì„¸ìš”." },
                { maxCount: Infinity, message: "ê¹Šì€ ìŠ¬í””ì„ ê²½í—˜í•˜ê³  ê³„ì‹  ê²ƒ ê°™ìŠµë‹ˆë‹¤. í˜¼ì ê°ë‹¹í•˜ê¸° ì–´ë µë‹¤ë©´ ë°˜ë“œì‹œ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì„¸ìš”." }
            ],
            angry: [
                { maxCount: 0, message: "ì´ë²ˆ ë‹¬ì—ëŠ” í™”ë‚˜ëŠ” ì¼ì´ ê±°ì˜ ì—†ìœ¼ì…¨ë„¤ìš”! í‰ì˜¨í•œ í•œ ë‹¬ì„ ë³´ë‚´ì‹  ê²ƒ ê°™ì•„ìš”." },
                { maxCount: 2, message: "ê°€ë” í™”ê°€ ë‚¬ì—ˆêµ°ìš”. ê·¸ëŸ´ ë• ì ì‹œ ìˆ¨ì„ ê³ ë¥´ê³  ì›ì¸ì„ ìƒê°í•´ë³´ì„¸ìš”." },
                { maxCount: 4, message: "í™”ë‚˜ëŠ” ì¼ì´ ì¡°ê¸ˆ ìˆì—ˆë„¤ìš”. í™”ë¥¼ ê±´ê°•í•˜ê²Œ í‘œí˜„í•  ë‚˜ë§Œì˜ ë°©ë²•ì„ ì°¾ì•„ë³´ëŠ” ê±´ ì–´ë–¤ê°€ìš”?" },
                { maxCount: 6, message: "í™”ê°€ ìì£¼ ëŠê»´ì§„ë‹¤ë©´, ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸ì„ ì ê²€í•˜ê³  ê±´ì „í•˜ê²Œ í•´ì†Œí•  ë°©ë²•ì„ ì°¾ì•„ë³´ì„¸ìš”." },
                { maxCount: 8, message: "í™”ê°€ ê½¤ ìŒ“ì¸ ê²ƒ ê°™ì•„ìš”. ìš´ë™ì´ë‚˜ ëª…ìƒìœ¼ë¡œ ë§ˆìŒì„ ë‹¤ìŠ¤ë ¤ë³´ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”." },
                { maxCount: 11, message: "ì§€ì†ì ì¸ í™”ëŠ” ë§ˆìŒì„ ì§€ì¹˜ê²Œ í•  ìˆ˜ ìˆì–´ìš”. ì ê·¹ì ì¸ ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ê°€ í•„ìš”í•´ ë³´ì—¬ìš”." },
                { maxCount: Infinity, message: "ë§¤ìš° ë†’ì€ ë¹ˆë„ë¡œ í™”ë¥¼ ëŠë¼ê³  ìˆì–´ìš”. ê°ì • ì¡°ì ˆì— ì–´ë ¤ì›€ì´ ìˆë‹¤ë©´ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì—¬ ë„ì›€ì„ ë°›ëŠ” ê²ƒì´ ì¢‹ì•„ìš”." }
            ],
            default: "ê°ì •ì„ ê¾¸ì¤€íˆ ê¸°ë¡í•˜ê³  ìì‹ ì„ ë” ê¹Šì´ ì´í•´í•´ë³´ì„¸ìš”. ì–´ë–¤ ê°ì •ì´ë“  ê·¸ê²ƒë“¤ë„ ì†Œì¤‘í•œ ë‹¹ì‹ ì˜ ì¼ë¶€ì…ë‹ˆë‹¤."
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            setupEmotionSelector();
            applyEmotionIconColors(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•„ì´ì½˜ ìƒ‰ìƒ ì ìš©
            setupIntensitySlider(); // ê°ì • ê°•ë„ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ

            document.addEventListener('authStateReady', async function(e) {
                currentUser = e.detail.user;
                console.log('[AUTH STATE CHANGE] User:', currentUser ? currentUser.uid : 'Logged out');

                // 1. í•µì‹¬ ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™”
                currentDate = new Date(); // ë‹¬ë ¥ ê¸°ì¤€ ë‚ ì§œë¥¼ í˜„ì¬ë¡œ ì´ˆê¸°í™”
                emotionData = {};         // ë©”ëª¨ë¦¬ ë‚´ ê°ì • ë°ì´í„° ì´ˆê¸°í™”
                console.log('[AUTH STATE CHANGE] Initial emotionData reset:', JSON.parse(JSON.stringify(emotionData)));

                // 2. ì‚¬ìš©ì ìƒíƒœì— ë”°ë¥¸ ë°ì´í„° ë¡œë“œ
                if (currentUser) { // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ ê²½ìš°
                    console.log('[AUTH STATE CHANGE] Attempting to load data for user:', currentUser.uid);
                    await loadEmotionData(); // Firebaseì—ì„œ ìƒˆ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
                    console.log('[AUTH STATE CHANGE] Data loaded for user. emotionData:', JSON.parse(JSON.stringify(emotionData)));
                } else { // ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒí•œ ê²½ìš°
                    console.log('[AUTH STATE CHANGE] User logged out. emotionData is already reset to {}.');
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ëŠ” common.jsì˜ logout()ì—ì„œ ì‚­ì œë˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” emotionDataê°€ {} ìƒíƒœì„ì„ ì‹ ë¢°í•©ë‹ˆë‹¤.
                    // ë§Œì•½ ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ê³  ì‹¶ë‹¤ë©´, ì—¬ê¸°ì„œ loadFromLocalStorageë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìœ¼ë‚˜,
                    // í˜„ì¬ "ë¡œê·¸ì•„ì›ƒí•˜ë©´ ëª¨ë“ ê²Œ ì´ˆê¸°í™”ë˜ì•¼ í•˜ëŠ”ê±° ì•„ë‹ˆì•¼??" ì§ˆë¬¸ì— ë§ì¶°, ë©”ëª¨ë¦¬ ì´ˆê¸°í™” ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
                }

                // 3. UI ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì´ˆê¸°í™”ë˜ì—ˆê±°ë‚˜ ìƒˆë¡œ ë¡œë“œëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ)
                console.log('[AUTH STATE CHANGE] Preparing to re-render UI. Current view mode:', calendarViewMode);
                if (calendarViewMode === 'month') {
                    document.getElementById('monthViewContainer').style.display = 'block';
                    document.getElementById('yearInPixelsView').style.display = 'none';
                    renderCalendar();
                    updateStats();
                } else {
                    document.getElementById('monthViewContainer').style.display = 'none';
                    document.getElementById('yearInPixelsView').style.display = 'block';
                    currentPixelYear = currentDate.getFullYear(); // í”½ì…€ ë·° ì—°ë„ë„ í˜„ì¬ë¡œ ì´ˆê¸°í™”
                    renderYearInPixels(currentPixelYear);
                }
                console.log('[AUTH STATE CHANGE] UI re-render attempt complete.');
            });
        });
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                `${year}ë…„ ${month + 1}ì›”`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            const today = new Date();
            for (let i = 0; i < 42; i++) { 
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month');
                }
                
                if (cellDate.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                
                const dateKey = formatDate(cellDate); 
                const emotionRecord = emotionData[dateKey]; 
                
                if (emotionRecord) {
                    dayCell.classList.add('has-emotion');
                    const baseColor = emotions[emotionRecord.type]?.color || '#cccccc'; 
                    const intensity = emotionRecord.intensity || 3; 
                    
                    const lightnessMap = [0, 0.7, 0.5, 0.3, 0.1, 0]; 
                    const lightnessFactor = lightnessMap[intensity] !== undefined ? lightnessMap[intensity] : lightnessMap[3]; 
                    const displayColor = lightenHexColor(baseColor, lightnessFactor);
                    
                    dayCell.style.borderColor = displayColor;
                    
                    if (emotionRecord.note) {
                        const notePreview = document.createElement('div');
                        notePreview.className = 'emotion-note-preview';
                        notePreview.textContent = emotionRecord.note.substring(0, 25) + (emotionRecord.note.length > 25 ? '...' : '');
                        dayCell.appendChild(notePreview);
                    }

                    const indicator = document.createElement('div');
                    indicator.className = 'emotion-indicator'; 
                    indicator.style.background = displayColor;
                    dayCell.appendChild(indicator);
                }
                
                dayCell.addEventListener('click', () => {
                    // â˜…â˜…â˜… í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ë¡œê·¸ â˜…â˜…â˜…
                    console.log('[í´ë¦­] ë‚ ì§œ ì…€ í´ë¦­ë¨. cellDate:', cellDate.toDateString(), 'other-month:', dayCell.classList.contains('other-month'));

                    if (!currentUser) {
                        showMessage("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹œë©´ ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.", "info");
                        showLoginModal(); // common.jsì˜ ë¡œê·¸ì¸ ëª¨ë‹¬ í•¨ìˆ˜ í˜¸ì¶œ
                        return;
                    }
                    
                    if (!dayCell.classList.contains('other-month')) {
                        const today = new Date();
                        // ì‹œê°„ì„ ì œì™¸í•˜ê³  ë‚ ì§œë§Œ ë¹„êµí•˜ê¸° ìœ„í•´ ìì •ìœ¼ë¡œ ì„¤ì •
                        today.setHours(0, 0, 0, 0);
                        const clickedDate = new Date(cellDate); // cellDateëŠ” ì´ë¯¸ Date ê°ì²´ì¼ ìˆ˜ ìˆìœ¼ë‚˜, í™•ì‹¤íˆ í•˜ê¸° ìœ„í•´
                        clickedDate.setHours(0, 0, 0, 0);
                        // â˜…â˜…â˜… ë‚ ì§œ ë¹„êµ ë¡œê·¸ â˜…â˜…â˜…
                        console.log('[í´ë¦­] ë¹„êµ: clickedDate:', clickedDate.toISOString(), 'vs today:', today.toISOString());

                        if (clickedDate > today) {
                            showMessage('ë¯¸ë˜ì˜ ì¼ê¸°ëŠ” ì“°ì‹¤ ìˆ˜ ì—†ì–´ìš” ğŸ˜Š', 'info');
                            console.log('[í´ë¦­] ë¯¸ë˜ ë‚ ì§œ í´ë¦­ ë°©ì§€ë¨. Clicked:', clickedDate.toDateString(), 'Today:', today.toDateString());
                            return; 
                        }
                        console.log('[í´ë¦­] ê°ì • ê¸°ë¡ ëª¨ë‹¬ ì—´ê¸° ì‹œë„. ë‚ ì§œ:', cellDate.toDateString());
                        openEmotionModal(cellDate); // ê³¼ê±° ë˜ëŠ” ì˜¤ëŠ˜ ë‚ ì§œì¸ ê²½ìš°ì—ë§Œ ëª¨ë‹¬ ì—´ê¸°
                    }
                });
                calendarGrid.appendChild(dayCell);
            }
        }
        
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
            updateStats();
        }
        
        function openEmotionModal(date) {
            selectedDate = date;
            const dateKey = formatDate(date);
            const emotion = emotionData[dateKey];
            
            document.getElementById('modalDate').textContent = 
                `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
            
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('selected'));
            if (emotion && emotions[emotion.type]) {
                const selectedBtn = document.querySelector(`.emotion-btn[data-emotion="${emotion.type}"]`);
                if (selectedBtn) selectedBtn.classList.add('selected');
                document.getElementById('emotionNote').value = emotion.note || '';
                document.getElementById('emotionIntensity').value = emotion.intensity || 3; 
            } else {
                document.getElementById('emotionNote').value = '';
                document.getElementById('emotionIntensity').value = 3; 
            }
            
            document.getElementById('emotionModal').style.display = 'block';
        }
        
        function closeEmotionModal() {
            document.getElementById('emotionModal').style.display = 'none';
            selectedDate = null;
        }
        
        function setupEmotionSelector() {
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.emotion-btn').forEach(b => 
                        b.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        function applyEmotionIconColors() {
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                const color = btn.dataset.color;
                const icon = btn.querySelector('i');
                if (icon && color) icon.style.color = color;
            });
        }

        function setupIntensitySlider() {
            const intensitySlider = document.getElementById('emotionIntensity');
            if (!intensitySlider) return;

            function updateSliderBackground() {
                const value = intensitySlider.value;
                const min = intensitySlider.min;
                const max = intensitySlider.max;
                const percentage = ((value - min) / (max - min)) * 100;
                // ì±„ì›Œì§„ ë¶€ë¶„ì€ #667eea, ì•ˆ ì±„ì›Œì§„ ë¶€ë¶„ì€ #e1e8ed
                intensitySlider.style.background = `linear-gradient(to right, #667eea ${percentage}%, #e1e8ed ${percentage}%)`;
            }

            // ì´ˆê¸° ë°°ê²½ ì„¤ì •
            updateSliderBackground();
            // ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ ë°°ê²½ ì—…ë°ì´íŠ¸
            intensitySlider.addEventListener('input', updateSliderBackground);
        }
        
        async function saveEmotion() {
            if (!currentUser) {
                showMessage("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹œë©´ ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.", "info");
                showLoginModal();
                return;
            }

            if (!selectedDate) return;
            
            const selectedBtn = document.querySelector('.emotion-btn.selected');
            if (!selectedBtn) {
                showMessage('ê°ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const emotionType = selectedBtn.dataset.emotion;
            const note = document.getElementById('emotionNote').value;
            const intensity = parseInt(document.getElementById('emotionIntensity').value, 10); 
            const dateKey = formatDate(selectedDate);
            
            const emotionRecord = {
                type: emotionType,
                note: note,
                date: dateKey,
                intensity: intensity, 
                timestamp: new Date().toISOString()
            };
            
            emotionData[dateKey] = emotionRecord;
            saveToLocalStorage('emotionData', emotionData);
            
            saveToFirestore(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.ìƒ‰ìƒì¼ê¸°, dateKey, emotionRecord); // saveToFirestore ë‚´ë¶€ì—ì„œ currentUser ì²´í¬í•¨
            
            closeEmotionModal();
            if (calendarViewMode === 'month') {
                renderCalendar();
                updateStats();
            } else {
                renderYearInPixels(currentPixelYear);
            }
            showMessage('ê°ì •ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        async function deleteEmotion() {
            if (!selectedDate) return;
            
            const dateKey = formatDate(selectedDate);
            delete emotionData[dateKey];
            saveToLocalStorage('emotionData', emotionData);
            
            if (currentUser) {
                try {
                    await db.collection('emotions').doc(dateKey).delete();
                } catch (error) {
                    console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
                }
            }
            
            closeEmotionModal();
            if (calendarViewMode === 'month') {
                renderCalendar();
                updateStats();
            } else {
                renderYearInPixels(currentPixelYear);
            }
            showMessage('ê°ì • ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        function updateStats() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthData = Object.values(emotionData).filter(emotion => {
                if (!emotion || !emotion.date) return false;
                const emotionDate = new Date(emotion.date);
                return emotionDate.getFullYear() === year && 
                       emotionDate.getMonth() === month;
            });
            
            const emotionCounts = {};
            Object.keys(emotions).forEach(key => {
                emotionCounts[key] = 0;
            });
            
            monthData.forEach(emotion => {
                if (emotion && emotions[emotion.type]) {
                    emotionCounts[emotion.type]++;
                }
            });
            
            const total = monthData.length;
            const statsContainer = document.getElementById('emotionStats');
            statsContainer.innerHTML = '';
            
            Object.entries(emotionCounts).forEach(([type, count]) => {
                const percentage = total > 0 ? (count / total) * 100 : 0;
                
                const statDiv = document.createElement('div');
                statDiv.className = 'emotion-stat';
                statDiv.innerHTML = `
                    <span>${emotions[type]?.name || type}</span>
                    <div class="emotion-bar">
                        <div class="emotion-bar-fill" 
                             style="width: ${percentage}%; background: ${emotions[type]?.color || '#cccccc'};">
                        </div>
                    </div>
                    <span>${count}íšŒ</span>
                `;
                statsContainer.appendChild(statDiv);
            });
            
            updatePrescription(emotionCounts, total);
        }
        
        function updatePrescription(emotionCounts, total) {
            const prescriptionTextElement = document.getElementById('prescriptionText');
            if (total === 0) {
                prescriptionTextElement.textContent = 'ì´ë²ˆ ë‹¬ ê°ì • ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê°ì •ì„ ê¸°ë¡í•˜ì‹œë©´ ë§ì¶¤ ì²˜ë°©ì „ì„ ì œê³µí•´ë“œë¦½ë‹ˆë‹¤.';
                return;
            }

            let sortedEmotions = Object.entries(emotionCounts)
                .filter(([type, count]) => emotions[type] && count > 0) 
                .sort(([, countA], [, countB]) => countB - countA);

            let primaryMessage = prescriptions.default;
            let secondaryMessage = "";

            if (sortedEmotions.length > 0) {
                const [dominantType, dominantCount] = sortedEmotions[0];
                if (prescriptions[dominantType]) {
                    const prescriptionLevels = prescriptions[dominantType];
                    for (const level of prescriptionLevels) {
                        if (dominantCount <= level.maxCount) {
                            primaryMessage = level.message;
                            break;
                        }
                    }
                }
            }

            if (sortedEmotions.length > 1) {
                const [secondType, secondCount] = sortedEmotions[1];
                const secondEmotionName = emotions[secondType]?.name || secondType;
                secondaryMessage += `\n\në˜í•œ ${secondEmotionName} ê°ì •ì„ ${secondCount}íšŒ ëŠë¼ì…¨êµ°ìš”. `;

                switch (secondType) {
                    case 'happy':
                    case 'calm':
                        secondaryMessage += `${secondEmotionName} ê°ì •ì„ ì˜ ëŠë¼ê³  ê³„ì‹œë„¤ìš”! ê¸ì •ì ì¸ ë§ˆìŒì„ ìœ ì§€í•˜ëŠ” ë‹¹ì‹ ì„ ì‘ì›í•©ë‹ˆë‹¤.`;
                        break;
                    case 'anxious':
                        secondaryMessage += `ë¶ˆì•ˆí•œ ë§ˆìŒì´ ë“¤ ë•ŒëŠ” ì‹¬í˜¸í¡ì´ë‚˜ ì§§ì€ ìŠ¤íŠ¸ë ˆì¹­ìœ¼ë¡œ ê¸´ì¥ì„ í’€ì–´ë³´ì„¸ìš”.`;
                        break;
                    case 'sad':
                        secondaryMessage += `ìŠ¬í”ˆ ë§ˆìŒì´ ë“¤ ë•ŒëŠ” ìì‹ ì—ê²Œ ë”°ëœ»í•œ ìœ„ë¡œë¥¼ ê±´ë„¤ê±°ë‚˜ ì¢‹ì•„í•˜ëŠ” í™œë™ì— ì§‘ì¤‘í•´ë³´ì„¸ìš”.`;
                        break;
                    case 'angry':
                        secondaryMessage += `í™”ë‚˜ëŠ” ë§ˆìŒì´ ë“¤ ë•ŒëŠ” ì ì‹œ ìƒí™©ì—ì„œ ë²—ì–´ë‚˜ ê°ì •ì„ ê°€ë¼ì•‰íˆëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”.`;
                        break;
                    default:
                        secondaryMessage += `ì´ ê°ì •ì— ëŒ€í•´ì„œë„ ì£¼ì˜ë¥¼ ê¸°ìš¸ì—¬ë³´ì„¸ìš”.`;
                }
            }
            
            if (typeof primaryMessage === 'string') {
                prescriptionTextElement.textContent = primaryMessage + secondaryMessage;
            } else {
                prescriptionTextElement.textContent = "ì²˜ë°©ì „ ë¡œë“œ ì˜¤ë¥˜: ë©”ì‹œì§€ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            }
        }
        
        async function loadEmotionData() {
            // emotionDataëŠ” authStateReadyì—ì„œ ì´ë¯¸ ì´ˆê¸°í™”ë¨
            if (currentUser) {
                try {
                    const snapshot = await db.collection('emotions')
                        .where('userId', '==', currentUser.uid)
                        .get();
                    
                    const firebaseData = {};
                    snapshot.forEach(doc => {
                        firebaseData[doc.id] = doc.data();
                    });
                    
                    emotionData = firebaseData; // ë¡œì»¬ ë°ì´í„°ì™€ ë³‘í•©í•˜ì§€ ì•Šê³  Firebase ë°ì´í„°ë§Œ ì‚¬ìš©
                    saveToLocalStorage('emotionData', emotionData);
                } catch (error) {
                    console.error('Firebase ê°ì • ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    emotionData = {}; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ë°ì´í„°ë¡œ ì‹œì‘
                }
            } else {
                const localData = loadFromLocalStorage('emotionData');
                emotionData = localData || {};
            }
        }

        function renderYearInPixels(year) {
            document.getElementById('pixelYearDisplay').textContent = `${year}ë…„ ê°ì • ì§€ë„`;
            const gridContainer = document.getElementById('pixelsGridContainer');
            gridContainer.innerHTML = ''; 

            const monthNames = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];

            for (let month = 0; month < 12; month++) {
                const monthWrapper = document.createElement('div');
                monthWrapper.className = 'pixel-month-wrapper';

                const monthLabel = document.createElement('div');
                monthLabel.className = 'pixel-month-label';
                monthLabel.textContent = monthNames[month];
                monthWrapper.appendChild(monthLabel);

                const monthGrid = document.createElement('div');
                monthGrid.className = 'pixels-grid';

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, month, 1).getDay(); 

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyPixel = document.createElement('div');
                    emptyPixel.style.visibility = 'hidden'; 
                    monthGrid.appendChild(emptyPixel);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const cellDate = new Date(year, month, day);
                    const dateKey = formatDate(cellDate);
                    const emotionRecord = emotionData[dateKey];
                    
                    const pixel = document.createElement('div');
                    pixel.className = 'pixel-day';
                    pixel.title = `${dateKey} - ${emotionRecord && emotions[emotionRecord.type] ? emotions[emotionRecord.type].name : 'ê¸°ë¡ ì—†ìŒ'}`;
                    
                    if (emotionRecord && emotions[emotionRecord.type]) {
                        const baseColor = emotions[emotionRecord.type].color;
                        const intensity = emotionRecord.intensity || 3;
                        const lightnessMap = [0, 0.7, 0.5, 0.3, 0.1, 0];
                        const lightnessFactor = lightnessMap[intensity] !== undefined ? lightnessMap[intensity] : lightnessMap[3];
                        pixel.style.backgroundColor = lightenHexColor(baseColor, lightnessFactor);
                    } else {
                        pixel.style.backgroundColor = '#efefef'; 
                    }
                    
                    pixel.addEventListener('click', () => {
                        openEmotionModal(cellDate);
                    });
                    monthGrid.appendChild(pixel);
                }
                monthWrapper.appendChild(monthGrid);
                gridContainer.appendChild(monthWrapper);
            }
        }

        function changePixelYear(direction) {
            currentPixelYear += direction;
            renderYearInPixels(currentPixelYear);
        }

        function toggleCalendarView() {
            // const monthViewContainer = document.getElementById('monthViewContainer'); // ì›”ë³„ ë‹¬ë ¥ì€ í•­ìƒ í‘œì‹œë˜ë¯€ë¡œ ì§ì ‘ ì œì–´ X
            const yearViewElement = document.getElementById('yearInPixelsView');
            const toggleButton = document.getElementById('toggleViewButton');

            if (!yearViewElement || !toggleButton) {
                console.error("ë·° ì „í™˜ì— í•„ìš”í•œ HTML ìš”ì†Œ ì¤‘ ì¼ë¶€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                showMessage("í™”ë©´ ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                return;
            }

            // í”½ì…€ ë·°ë¥¼ ì—´ë ¤ê³  í•  ë•Œ
            if (yearViewElement.style.display === 'none' || calendarViewMode === 'month') {
                // ê°ì • ê¸°ë¡ì´ ìˆëŠ”ì§€ í™•ì¸
                if (Object.keys(emotionData).length === 0) {
                    showMessage('ìƒ‰ìƒì¼ê¸° ê¸°ë¡ì´ ì—†ì–´ìš”. ê°ì •ì¼ê¸°ë¥¼ ê¸°ë¡í•˜ë©´ í”½ì…€ë·°ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”', 'info');
                    return; // í”½ì…€ ë·°ë¥¼ ì—´ì§€ ì•Šê³  í•¨ìˆ˜ ì¢…ë£Œ
                }
                
                yearViewElement.style.display = 'block';
                currentPixelYear = currentDate.getFullYear(); 
                renderYearInPixels(currentPixelYear);
                toggleButton.textContent = 'í”½ì…€ ë·° ë‹«ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                calendarViewMode = 'year';
            } else { // í”½ì…€ ë·°ë¥¼ ë‹«ìœ¼ë ¤ê³  í•  ë•Œ
                yearViewElement.style.display = 'none';
                toggleButton.textContent = 'ì›”ë³„ ê°ì •ì§€ë„ í”½ì…€ë·°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì›ë˜ëŒ€ë¡œ
                calendarViewMode = 'month';
            }
        }
        
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        function lightenHexColor(hex, factor) {
            if (!hex || typeof hex !== 'string' || hex.charAt(0) !== '#') return '#cccccc'; 
            
            let r = parseInt(hex.slice(1, 3), 16);
            let g = parseInt(hex.slice(3, 5), 16);
            let b = parseInt(hex.slice(5, 7), 16);

            r = Math.round(r + (255 - r) * factor);
            g = Math.round(g + (255 - g) * factor);
            b = Math.round(b + (255 - b) * factor);

            r = Math.min(255, Math.max(0, r));
            g = Math.min(255, Math.max(0, g));
            b = Math.min(255, Math.max(0, b));

            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('emotionModal');
            if (event.target === modal) {
                closeEmotionModal();
            }
        });
    </script>
    
    <style>
        .emotion-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem; /* ê°„ê²© ì¶•ì†Œ */
            margin-bottom: 1rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .emotion-btn {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            padding: 0.75rem; /* íŒ¨ë”© ì¶•ì†Œ */
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .emotion-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .emotion-btn.selected {
            border-color: #667eea;
            background: #f8f9ff;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .emotion-btn i {
            font-size: 1.5rem; /* ì•„ì´ì½˜ í¬ê¸° ì¶•ì†Œ */
            color: #667eea;
        }
        
        .emotion-btn span {
            font-weight: 500;
            color: #333;
        }
        /* ê°ì • ë²„íŠ¼ ì•„ì´ì½˜ ìƒ‰ìƒ ì¼ì¹˜ */
        .emotion-btn[data-emotion="happy"] i {
            color: #f39c12 !important;
        }
        .emotion-btn[data-emotion="calm"] i {
            color: #00a693 !important;
        }
        .emotion-btn[data-emotion="anxious"] i {
            color: #8e44ad !important;
        }
        .emotion-btn[data-emotion="sad"] i {
            color: #2980b9 !important;
        }
        .emotion-btn[data-emotion="angry"] i {
            color: #ee4801 !important; /* í™”ë‚¨ ìƒ‰ìƒ ë³€ê²½ */
        }
        .emotion-btn.selected i { /* ì„ íƒ ì‹œ ì•„ì´ì½˜ ìƒ‰ìƒë„ ìœ ì§€ ë˜ëŠ” ë³€ê²½ */
            /* color: white; */ /* ë§Œì•½ ì„ íƒ ì‹œ ë°°ê²½ìƒ‰ì´ ì•„ì´ì½˜ ìƒ‰ê³¼ ê°™ì•„ì ¸ì„œ ì•ˆë³´ì¸ë‹¤ë©´ í°ìƒ‰ ë“±ìœ¼ë¡œ ë³€ê²½ */
            /* í˜„ì¬ .selected ë°°ê²½ìƒ‰ì´ ë°ì•„ì„œ ì•„ì´ì½˜ ìƒ‰ìƒì´ ì˜ ë³´ì´ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬ ìœ ì§€ */
        }

        /* ëª¨ë°”ì¼ì—ì„œ ê°ì • ì„ íƒ ë²„íŠ¼ ì¶”ê°€ ì¡°ì • */
        @media (max-width: 768px) {
            .emotion-selector {
                gap: 0.5rem;
            }
            .emotion-btn {
                padding: 0.5rem;
                gap: 0.3rem;
            }
            .emotion-btn i { font-size: 1.3rem; }
            .emotion-btn span { font-size: 0.85rem; }
        }
    </style>
</body>
</html>
