<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>색상 감정 일기 - EmotiCare</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .journal-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .month-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .month-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .month-nav button:hover {
            background: #764ba2;
            transform: scale(1.1);
        }
        
        .current-month {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .emotion-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .emotion-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .emotion-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .calendar {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e1e8ed;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .calendar-day-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }
        
        .calendar-day {
            background: white;
            padding: 1rem;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .calendar-day:hover {
            background: #f8f9ff;
        }
        
        .calendar-day.other-month {
            color: #ccc;
            background: #f8f9fa;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .calendar-day.has-emotion {
            border: 3px solid;
        }
        
        .day-number {
            font-weight: 600;
        }
        
        .emotion-indicator {
            width: 100%;
            height: 20px;
            border-radius: 10px;
            margin-top: 0.5rem;
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stats-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .emotion-stats {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .emotion-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .emotion-bar {
            flex: 1;
            height: 10px;
            background: #e1e8ed;
            border-radius: 5px;
            margin: 0 1rem;
            overflow: hidden;
        }
        
        .emotion-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .prescription-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
        }
        
        .prescription-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .prescription-text {
            font-size: 1.1rem;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">색상 감정 일기</h1>
                <p class="page-subtitle">매일의 감정을 색상으로 기록하고 나만의 패턴을 발견해보세요</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="journal-container">
                <div class="calendar-header">
                    <div class="month-nav">
                        <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <span class="current-month" id="currentMonth"></span>
                        <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    
                    <div class="emotion-legend">
                        <div class="emotion-item">
                            <div class="emotion-color" style="background: #ff6b6b;"></div>
                            <span>화남</span>
                        </div>
                        <div class="emotion-item">
                            <div class="emotion-color" style="background: #4ecdc4;"></div>
                            <span>평온</span>
                        </div>
                        <div class="emotion-item">
                            <div class="emotion-color" style="background: #45b7d1;"></div>
                            <span>슬픔</span>
                        </div>
                        <div class="emotion-item">
                            <div class="emotion-color" style="background: #f9ca24;"></div>
                            <span>기쁨</span>
                        </div>
                        <div class="emotion-item">
                            <div class="emotion-color" style="background: #6c5ce7;"></div>
                            <span>불안</span>
                        </div>
                    </div>
                </div>
                
                <div class="calendar">
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- 달력이 여기에 생성됩니다 -->
                    </div>
                </div>
                
                <div class="stats-section">
                    <div class="stats-card">
                        <h3 class="stats-title">이번 달 감정 통계</h3>
                        <div class="emotion-stats" id="emotionStats">
                            <!-- 통계가 여기에 생성됩니다 -->
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <h3 class="stats-title">마음 처방전</h3>
                        <div class="prescription-card" id="prescriptionCard">
                            <div class="prescription-icon">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="prescription-text" id="prescriptionText">
                                감정 데이터를 분석하여 맞춤 처방전을 제공해드립니다.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- 감정 기록 모달 -->
    <div id="emotionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalDate">감정 기록</h3>
                <button class="modal-close" onclick="closeEmotionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>오늘의 감정을 선택해주세요</label>
                    <div class="emotion-selector">
                        <button class="emotion-btn" data-emotion="angry" data-color="#ff6b6b">
                            <i class="fas fa-angry"></i>
                            <span>화남</span>
                        </button>
                        <button class="emotion-btn" data-emotion="calm" data-color="#4ecdc4">
                            <i class="fas fa-smile"></i>
                            <span>평온</span>
                        </button>
                        <button class="emotion-btn" data-emotion="sad" data-color="#45b7d1">
                            <i class="fas fa-sad-tear"></i>
                            <span>슬픔</span>
                        </button>
                        <button class="emotion-btn" data-emotion="happy" data-color="#f9ca24">
                            <i class="fas fa-laugh"></i>
                            <span>기쁨</span>
                        </button>
                        <button class="emotion-btn" data-emotion="anxious" data-color="#6c5ce7">
                            <i class="fas fa-meh"></i>
                            <span>불안</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="emotionNote">오늘의 기분에 대해 간단히 적어보세요</label>
                    <textarea id="emotionNote" placeholder="오늘 하루는 어떠셨나요?"></textarea>
                </div>
                
                <div class="form-group">
                    <button class="btn-primary" onclick="saveEmotion()">저장하기</button>
                    <button class="btn-outline" onclick="deleteEmotion()">삭제하기</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let currentDate = new Date();
        let selectedDate = null;
        let emotionData = {};
        
        const emotions = {
            angry: { name: '화남', color: '#ff6b6b', icon: 'fas fa-angry' },
            calm: { name: '평온', color: '#4ecdc4', icon: 'fas fa-smile' },
            sad: { name: '슬픔', color: '#45b7d1', icon: 'fas fa-sad-tear' },
            happy: { name: '기쁨', color: '#f9ca24', icon: 'fas fa-laugh' },
            anxious: { name: '불안', color: '#6c5ce7', icon: 'fas fa-meh' }
        };
        
        const prescriptions = {
            angry: "화가 날 때는 깊게 숨을 들이마시고 천천히 내쉬어보세요. 잠시 그 자리를 떠나 산책을 하거나 좋아하는 음악을 들어보세요.",
            calm: "평온한 마음 상태를 잘 유지하고 계시네요! 이 순간을 소중히 여기고 감사한 마음을 가져보세요.",
            sad: "슬픈 감정도 자연스러운 것입니다. 자신을 다독이며 따뜻한 차 한 잔과 함께 좋은 추억을 떠올려보세요.",
            happy: "기쁜 마음이 느껴지네요! 이 행복한 순간을 기억하고 주변 사람들과 나누어보세요.",
            anxious: "불안할 때는 현재에 집중해보세요. 5-4-3-2-1 기법을 사용해 주변의 것들을 관찰해보세요."
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            loadEmotionData();
            renderCalendar();
            updateStats();
            setupEmotionSelector();
        });
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                `${year}년 ${month + 1}월`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // 요일 헤더
            const dayHeaders = ['일', '월', '화', '수', '목', '금', '토'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // 날짜 셀
            const today = new Date();
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month');
                }
                
                if (cellDate.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }
                
                const dateKey = formatDate(cellDate);
                const emotion = emotionData[dateKey];
                
                if (emotion) {
                    dayCell.classList.add('has-emotion');
                    dayCell.style.borderColor = emotions[emotion.type].color;
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'emotion-indicator';
                    indicator.style.background = emotions[emotion.type].color;
                    dayCell.appendChild(indicator);
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                
                dayCell.addEventListener('click', () => openEmotionModal(cellDate));
                calendarGrid.appendChild(dayCell);
            }
        }
        
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
            updateStats();
        }
        
        function openEmotionModal(date) {
            selectedDate = date;
            const dateKey = formatDate(date);
            const emotion = emotionData[dateKey];
            
            document.getElementById('modalDate').textContent = 
                `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
            
            // 기존 데이터 로드
            if (emotion) {
                document.querySelector(`[data-emotion="${emotion.type}"]`).classList.add('selected');
                document.getElementById('emotionNote').value = emotion.note || '';
            } else {
                document.querySelectorAll('.emotion-btn').forEach(btn => 
                    btn.classList.remove('selected'));
                document.getElementById('emotionNote').value = '';
            }
            
            document.getElementById('emotionModal').style.display = 'block';
        }
        
        function closeEmotionModal() {
            document.getElementById('emotionModal').style.display = 'none';
            selectedDate = null;
        }
        
        function setupEmotionSelector() {
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.emotion-btn').forEach(b => 
                        b.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }
        
        async function saveEmotion() {
            if (!selectedDate) return;
            
            const selectedBtn = document.querySelector('.emotion-btn.selected');
            if (!selectedBtn) {
                showMessage('감정을 선택해주세요.', 'error');
                return;
            }
            
            const emotionType = selectedBtn.dataset.emotion;
            const note = document.getElementById('emotionNote').value;
            const dateKey = formatDate(selectedDate);
            
            const emotionRecord = {
                type: emotionType,
                note: note,
                date: dateKey,
                timestamp: new Date().toISOString()
            };
            
            // 로컬 저장
            emotionData[dateKey] = emotionRecord;
            saveToLocalStorage('emotionData', emotionData);
            
            // Firebase 저장 (로그인된 경우)
            if (currentUser) {
                await saveToFirestore('emotions', dateKey, emotionRecord);
            }
            
            closeEmotionModal();
            renderCalendar();
            updateStats();
            showMessage('감정이 기록되었습니다.', 'success');
        }
        
        async function deleteEmotion() {
            if (!selectedDate) return;
            
            const dateKey = formatDate(selectedDate);
            delete emotionData[dateKey];
            saveToLocalStorage('emotionData', emotionData);
            
            // Firebase에서도 삭제 (로그인된 경우)
            if (currentUser) {
                try {
                    await db.collection('emotions').doc(dateKey).delete();
                } catch (error) {
                    console.error('Firebase 삭제 실패:', error);
                }
            }
            
            closeEmotionModal();
            renderCalendar();
            updateStats();
            showMessage('감정 기록이 삭제되었습니다.', 'success');
        }
        
        function updateStats() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthData = Object.values(emotionData).filter(emotion => {
                const emotionDate = new Date(emotion.date);
                return emotionDate.getFullYear() === year && 
                       emotionDate.getMonth() === month;
            });
            
            const emotionCounts = {};
            Object.keys(emotions).forEach(key => {
                emotionCounts[key] = 0;
            });
            
            monthData.forEach(emotion => {
                emotionCounts[emotion.type]++;
            });
            
            const total = monthData.length;
            const statsContainer = document.getElementById('emotionStats');
            statsContainer.innerHTML = '';
            
            Object.entries(emotionCounts).forEach(([type, count]) => {
                const percentage = total > 0 ? (count / total) * 100 : 0;
                
                const statDiv = document.createElement('div');
                statDiv.className = 'emotion-stat';
                statDiv.innerHTML = `
                    <span>${emotions[type].name}</span>
                    <div class="emotion-bar">
                        <div class="emotion-bar-fill" 
                             style="width: ${percentage}%; background: ${emotions[type].color};">
                        </div>
                    </div>
                    <span>${count}회</span>
                `;
                statsContainer.appendChild(statDiv);
            });
            
            // 처방전 업데이트
            updatePrescription(emotionCounts, total);
        }
        
        function updatePrescription(emotionCounts, total) {
            if (total === 0) {
                document.getElementById('prescriptionText').textContent = 
                    '감정을 기록하시면 맞춤 처방전을 제공해드립니다.';
                return;
            }
            
            const dominantEmotion = Object.entries(emotionCounts)
                .reduce((a, b) => emotionCounts[a[0]] > emotionCounts[b[0]] ? a : b)[0];
            
            document.getElementById('prescriptionText').textContent = 
                prescriptions[dominantEmotion];
        }
        
        async function loadEmotionData() {
            // 로컬 스토리지에서 로드
            const localData = loadFromLocalStorage('emotionData');
            if (localData) {
                emotionData = localData;
            }
            
            // Firebase에서 로드 (로그인된 경우)
            if (currentUser) {
                try {
                    const snapshot = await db.collection('emotions')
                        .where('userId', '==', currentUser.uid)
                        .get();
                    
                    snapshot.forEach(doc => {
                        emotionData[doc.id] = doc.data();
                    });
                    
                    saveToLocalStorage('emotionData', emotionData);
                } catch (error) {
                    console.error('Firebase 로드 실패:', error);
                }
            }
        }
        
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        // 모달 외부 클릭 시 닫기
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('emotionModal');
            if (event.target === modal) {
                closeEmotionModal();
            }
        });
    </script>
    
    <style>
        .emotion-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .emotion-btn {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .emotion-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .emotion-btn.selected {
            border-color: #667eea;
            background: #f8f9ff;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .emotion-btn i {
            font-size: 2rem;
            color: #667eea;
        }
        
        .emotion-btn span {
            font-weight: 500;
            color: #333;
        }
    </style>
</body>
</html>
