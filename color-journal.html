<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>색상 감정 일기 - EmotiCare</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .journal-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .month-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .month-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .month-nav button:hover {
            background: #764ba2;
            transform: scale(1.1);
        }
        
        .current-month {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .emotion-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .emotion-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .emotion-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .calendar {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e1e8ed;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .calendar-day-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }
        
        .calendar-day {
            background: white;
            padding: 0.5rem; 
            min-height: 100px; 
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
        }
        
        .calendar-day:hover {
            background: #f8f9ff;
        }
        
        .calendar-day.other-month {
            color: #ccc;
            background: #f8f9fa;
            pointer-events: none;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .calendar-day.has-emotion {
            border: 3px solid;
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 0.3rem; 
            z-index: 2; 
            position: relative; 
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stats-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .emotion-stats {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .emotion-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .emotion-bar {
            flex: 1;
            height: 10px;
            background: #e1e8ed;
            border-radius: 5px;
            margin: 0 1rem;
            overflow: hidden;
        }
        
        .emotion-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .prescription-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
        }
        
        .prescription-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .prescription-text {
            font-size: 1.1rem;
            line-height: 1.6;
            white-space: pre-line; 
        }

        .intensity-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
            width: 90%; 
            margin-left: auto; 
            margin-right: auto; 
        }

        .modal-action-buttons {
            display: flex;
            gap: 1rem; 
        }
        .modal-action-buttons button {
            flex: 1; 
            width: auto; 
            padding: 0.8rem 1rem; 
            justify-content: center; 
        }

        .emotion-indicator {
            width: 18px; 
            height: 18px; 
            border-radius: 50%; 
            position: absolute; 
            bottom: 5px; 
            right: 5px; 
            border: 2px solid white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
            z-index: 1; 
        }

        .emotion-note-preview {
            font-size: 0.75rem; 
            color: #555; 
            margin-top: 0.2rem;
            line-height: 1.3;
            max-height: 2.6em; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            word-break: break-all; 
            z-index: 2; 
            position: relative; 
        }

        .year-in-pixels-view {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            /* display: none; 기본적으로 숨김 처리 */
        }

        .year-pixels-header {
            display: flex;
            justify-content: center; /* 네비게이션 요소를 헤더 중앙에 배치 */
            align-items: center;
            padding: 0 0.5rem; /* 헤더 패딩 조정 */
            margin-bottom: 1.5rem;
        }

        .year-pixels-nav { /* 연도 네비게이션 스타일 추가 */
            display: flex;
            align-items: center; /* 버튼과 제목을 세로 중앙 정렬 */
            gap: 0.5rem; /* 버튼과 제목 사이 간격 (기존 버튼 마진으로도 가능) */
        }

        .year-pixels-header h2 {
            font-size: 1.5rem;
            color: #333;
            margin: 0;
        }
        .year-pixels-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease; /* 버튼 좌우 마진은 gap으로 대체하거나 유지 가능 */
            /* margin: 0 0.5rem; */ /* year-pixels-nav의 gap으로 대체 가능 */
        }
        .year-pixels-nav button:hover {
            background: #764ba2;
        }

        .pixels-grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 명확하게 4열 그리드 설정 */
            gap: 1rem; /* 월별 간격 */
            padding: 1rem; /* 그리드 컨테이너 자체에 패딩 추가 */
        }

        .pixel-month-wrapper {
            background: #f8f9fa; /* 각 월별 배경색 */
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            /* margin-bottom: 1.5rem; */ /* gap 속성으로 대체 */
        }

        .pixel-month-label {
            text-align: center; /* 월 이름 가운데 정렬 */
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9em; /* 월 이름 폰트 크기 조정 */
            color: #333;
        }
        
        .pixels-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px; /* 날짜 픽셀 간격 조정 */
            /* max-width: 300px; 제거 또는 조정 */
        }
        .pixel-day {
            width: 100%;
            padding-bottom: 100%; /* 정사각형 유지를 위해 */
            background-color: #efefef;
            border-radius: 2px; /* 픽셀 모서리 약간 둥글게 */
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease;
        }
        .pixel-day:hover {
            transform: scale(1.1);
            outline: 2px solid #667eea;
            z-index: 10; /* 호버 시 다른 요소 위로 올라오도록 */
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">색상 감정 일기</h1>
                <p class="page-subtitle">매일의 감정을 색상으로 기록하고 나만의 패턴을 발견해보세요</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="journal-container">
                <div id="monthViewContainer">
                    <div class="calendar-header">
                        <div class="month-nav">
                            <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span class="current-month" id="currentMonth"></span>
                            <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        
                        <div class="emotion-legend">
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #f39c12;"></div>
                                <span>기쁨</span>
                            </div>
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #00a693;"></div>
                                <span>평온</span>
                            </div>
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #8e44ad;"></div>
                                <span>불안</span>
                            </div>
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #2980b9;"></div>
                                <span>슬픔</span>
                            </div>
                            <div class="emotion-item">
                                <div class="emotion-color" style="background: #ff0606;"></div>
                                <span>화남</span> 
                            </div>
                        </div>
                    </div>
                    
                    <div class="calendar" id="calendar">
                        <div class="calendar-grid" id="calendarGrid">
                        </div>
                    </div>
                    
                    <div class="stats-section">
                        <div class="stats-card">
                            <h3 class="stats-title">이번 달 감정 통계</h3>
                            <div class="emotion-stats" id="emotionStats">
                            </div>
                        </div>
                        
                        <div class="stats-card">
                            <h3 class="stats-title">마음 처방전</h3>
                            <div class="prescription-card" id="prescriptionCard">
                                <div class="prescription-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="prescription-text" id="prescriptionText">감정 데이터를 분석하여 맞춤 처방전을 제공해드립니다.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="year-in-pixels-view" id="yearInPixelsView" style="display: none;">
                    <div class="year-pixels-header">
                        <div class="year-pixels-nav">
                            <button onclick="changePixelYear(-1)"><i class="fas fa-chevron-left"></i></button>
                            <h2 id="pixelYearDisplay"></h2>
                            <button onclick="changePixelYear(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="pixels-grid-container" id="pixelsGridContainer">
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <button id="toggleViewButton" class="btn-outline" onclick="toggleCalendarView()">
                        올해의 색깔들 보기
                    </button>
                </div>
            </div>
        </section>
    </main>
    
    <div id="emotionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalDate">감정 기록</h3>
                <button class="modal-close" onclick="closeEmotionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>오늘의 감정을 선택해주세요</label>
                    <div class="emotion-selector">
                         <button class="emotion-btn" data-emotion="happy" data-color="#f39c12">
                            <i class="fas fa-laugh"></i>
                            <span>기쁨</span>
                        </button>
                        <button class="emotion-btn" data-emotion="calm" data-color="#00a693">
                            <i class="fas fa-smile"></i>
                            <span>평온</span>
                        </button>
                         <button class="emotion-btn" data-emotion="anxious" data-color="#8e44ad">
                            <i class="fas fa-meh"></i>
                            <span>불안</span>
                        </button>
                        <button class="emotion-btn" data-emotion="sad" data-color="#2980b9">
                            <i class="fas fa-sad-tear"></i>
                            <span>슬픔</span>
                        </button>
                        <button class="emotion-btn" data-emotion="angry" data-color="#ff0606">
                            <i class="fas fa-angry"></i>
                            <span>화남</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="emotionIntensity">감정 강도 <span style="font-weight:normal; font-size:0.9em;">(1: 약함, 5: 강함)</span></label>
                    <input type="range" id="emotionIntensity" min="1" max="5" value="3" step="1" style="width: 100%;">
                    <div class="intensity-labels">
                        <span>1</span>
                        <span>2</span>
                        <span>3</span>
                        <span>4</span>
                        <span>5</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="emotionNote">오늘 하루 일과와 감정을 간단히 기록해보세요</label>
                    <textarea id="emotionNote" placeholder="오늘 하루는 어땠나요?"></textarea>
                </div>
                
                <div class="form-group modal-action-buttons">
                    <button class="btn-primary" onclick="saveEmotion()">저장하기</button>
                    <button class="btn-outline" onclick="deleteEmotion()">삭제하기</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let currentDate = new Date();
        let selectedDate = null;
        let emotionData = {};
        let currentPixelYear = new Date().getFullYear();
        let calendarViewMode = 'month';
        
        const emotions = {
            happy: { name: '기쁨', color: '#f39c12', icon: 'fas fa-laugh' },
            calm: { name: '평온', color: '#00a693', icon: 'fas fa-smile' },
            anxious: { name: '불안', color: '#8e44ad', icon: 'fas fa-meh' },
            sad: { name: '슬픔', color: '#2980b9', icon: 'fas fa-sad-tear' },
            angry: { name: '화남', color: '#ff0606', icon: 'fas fa-angry' }
        };
        
        const prescriptions = {
            happy: [
                { maxCount: 1, message: "기쁨을 조금 더 느껴보세요! 작은 것에서 행복을 찾는 연습은 어때요?" },
                { maxCount: 3, message: "기분 좋은 순간들이 있었네요. 이 기쁨을 주변에 나눠보세요." },
                { maxCount: 5, message: "기쁨을 느끼는 날들이 꽤 있었군요! 긍정적인 마음이 보기 좋아요." },
                { maxCount: 7, message: "행복한 에너지가 느껴지는 달이에요. 이 기운을 잘 유지해보세요!" },
                { maxCount: 9, message: "많은 날들을 기쁘게 보내셨네요! 당신의 밝은 에너지가 주변을 환하게 해요." },
                { maxCount: 11, message: "정말 행복한 한 달이었군요! 이 기쁨을 충분히 누리세요." },
                { maxCount: Infinity, message: "매일매일이 기쁨으로 가득 찬 한 달이었군요! 당신은 행복을 만들어가는 사람입니다." }
            ],
            calm: [
                { maxCount: 1, message: "평온함을 찾아보는 건 어때요? 조용한 명상이나 산책이 도움이 될 수 있어요." },
                { maxCount: 3, message: "마음이 평온했던 순간들이 있었네요. 그 느낌을 기억해보세요." },
                { maxCount: 5, message: "안정적인 마음 상태를 잘 유지하고 있어요. 꾸준한 자기 돌봄 덕분일 거예요." },
                { maxCount: 7, message: "꽤 평온한 한 달을 보내셨네요. 스트레스 관리를 잘 하고 계신 것 같아요." },
                { maxCount: 9, message: "매우 평온한 상태를 유지하고 계시는군요. 내면의 안정감이 큰 강점이에요." },
                { maxCount: 11, message: "대부분의 시간을 평온하게 보내셨네요. 마음의 균형을 잘 잡고 계십니다." },
                { maxCount: Infinity, message: "이번 달 대부분 평온함을 느끼셨군요! 정말 멋진 마음 상태입니다. 이 평화를 계속 유지하세요." }
            ],
            anxious: [
                { maxCount: 0, message: "이번 달에는 불안감을 거의 느끼지 않으셨네요. 안정적인 한 달이었던 것 같습니다." },
                { maxCount: 2, message: "가끔 불안감을 느꼈군요. 그럴 땐 심호흡이나 좋아하는 활동으로 주의를 돌려보세요." },
                { maxCount: 4, message: "불안한 마음이 조금씩 있었네요. 원인을 파악하고 스스로를 다독여주세요." },
                { maxCount: 6, message: "불안감이 자주 느껴졌다면, 규칙적인 생활과 휴식이 도움이 될 수 있어요." },
                { maxCount: 8, message: "불안함이 꽤 느껴지는 달이었네요. 마음챙김 연습이나 이완 기법을 시도해보세요." },
                { maxCount: 11, message: "지속적인 불안은 에너지를 소모시켜요. 전문가의 도움을 고려해보는 것도 좋아요." },
                { maxCount: Infinity, message: "높은 수준의 불안을 경험하고 계신 것 같습니다. 혼자 힘들어하지 마시고 꼭 전문가와 상담해보세요." }
            ],
            sad: [
                { maxCount: 0, message: "이번 달에는 슬픔을 거의 느끼지 않으셨네요. 밝고 긍정적인 한 달이었던 것 같습니다." },
                { maxCount: 2, message: "가끔 슬픈 감정이 들었군요. 그 감정을 충분히 느끼고 흘려보내는 것이 중요해요." },
                { maxCount: 4, message: "슬픔을 느꼈던 날들이 있었네요. 자신을 위로하고 좋아하는 사람들과 시간을 보내세요." },
                { maxCount: 6, message: "슬픈 감정이 자주 찾아왔다면, 기분 전환을 위한 활동이나 취미를 가져보세요." },
                { maxCount: 8, message: "마음이 아팠던 날들이 꽤 있었네요. 슬픔을 표현하고 도움을 요청해도 괜찮아요." },
                { maxCount: 11, message: "지속적인 슬픔은 우울감으로 이어질 수 있어요. 전문가와 상담하여 마음을 돌보세요." },
                { maxCount: Infinity, message: "깊은 슬픔을 경험하고 계신 것 같습니다. 혼자 감당하기 어렵다면 반드시 전문가의 도움을 받으세요." }
            ],
            angry: [
                { maxCount: 0, message: "이번 달에는 화나는 일이 거의 없으셨네요! 평온한 한 달을 보내신 것 같아요." },
                { maxCount: 2, message: "가끔 화가 났었군요. 그럴 땐 잠시 숨을 고르고 원인을 생각해보세요." },
                { maxCount: 4, message: "화나는 일이 조금 있었네요. 화를 건강하게 표현하는 방법을 찾아보는 건 어때요?" },
                { maxCount: 6, message: "화가 자주 느껴졌다면, 스트레스 요인을 점검하고 해소할 방법을 찾아보세요." },
                { maxCount: 8, message: "화가 꽤 쌓인 것 같아요. 운동이나 명상으로 마음을 다스려보는 것을 고려해보세요." },
                { maxCount: 11, message: "지속적인 화는 마음을 지치게 할 수 있어요. 적극적인 스트레스 관리가 필요해 보여요." },
                { maxCount: Infinity, message: "매우 높은 빈도로 화를 느끼고 계십니다. 감정 조절에 어려움이 있다면 전문가와 상담하여 도움을 받는 것이 좋습니다." }
            ],
            default: "감정을 꾸준히 기록하고 자신을 더 깊이 이해해보세요. 어떤 감정이든 소중한 당신의 일부입니다."
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            setupEmotionSelector();
            applyEmotionIconColors(); // 페이지 로드 시 아이콘 색상 적용
            setupIntensitySlider(); // 감정 강도 슬라이더 초기화 함수 호출

            document.addEventListener('authStateReady', async function(e) {
                if (e.detail.user) { 
                    await loadEmotionData();
                } else { 
                    const localData = loadFromLocalStorage('emotionData');
                    if (localData) {
                        emotionData = localData;
                    } else {
                        emotionData = {};
                    }
                    showMessage("로그인 후 이용하시면 데이터가 안전하게 보관됩니다.", "info");
                }

                if (calendarViewMode === 'month') {
                    document.getElementById('monthViewContainer').style.display = 'block';
                    document.getElementById('yearInPixelsView').style.display = 'none';
                    renderCalendar();
                    updateStats();
                } else {
                    document.getElementById('monthViewContainer').style.display = 'none';
                    document.getElementById('yearInPixelsView').style.display = 'block';
                    currentPixelYear = currentDate.getFullYear();
                    renderYearInPixels(currentPixelYear);
                }
            });
        });
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                `${year}년 ${month + 1}월`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            const dayHeaders = ['일', '월', '화', '수', '목', '금', '토'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            const today = new Date();
            for (let i = 0; i < 42; i++) { 
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month');
                }
                
                if (cellDate.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                
                const dateKey = formatDate(cellDate); 
                const emotionRecord = emotionData[dateKey]; 
                
                if (emotionRecord) {
                    dayCell.classList.add('has-emotion');
                    const baseColor = emotions[emotionRecord.type]?.color || '#cccccc'; 
                    const intensity = emotionRecord.intensity || 3; 
                    
                    const lightnessMap = [0, 0.7, 0.5, 0.3, 0.1, 0]; 
                    const lightnessFactor = lightnessMap[intensity] !== undefined ? lightnessMap[intensity] : lightnessMap[3]; 
                    const displayColor = lightenHexColor(baseColor, lightnessFactor);
                    
                    dayCell.style.borderColor = displayColor;
                    
                    if (emotionRecord.note) {
                        const notePreview = document.createElement('div');
                        notePreview.className = 'emotion-note-preview';
                        notePreview.textContent = emotionRecord.note.substring(0, 25) + (emotionRecord.note.length > 25 ? '...' : '');
                        dayCell.appendChild(notePreview);
                    }

                    const indicator = document.createElement('div');
                    indicator.className = 'emotion-indicator'; 
                    indicator.style.background = displayColor;
                    dayCell.appendChild(indicator);
                }
                
                dayCell.addEventListener('click', () => {
                    if (!dayCell.classList.contains('other-month')) {
                        const today = new Date();
                        // 시간을 제외하고 날짜만 비교하기 위해 자정으로 설정
                        today.setHours(0, 0, 0, 0);
                        const clickedDate = new Date(cellDate); // cellDate는 이미 Date 객체일 수 있으나, 확실히 하기 위해
                        clickedDate.setHours(0, 0, 0, 0);

                        if (clickedDate > today) {
                            showMessage('미래의 일기는 쓰실 수 없어요 😊', 'info');
                            return; 
                        }
                        openEmotionModal(cellDate); // 과거 또는 오늘 날짜인 경우에만 모달 열기
                    }
                });
                calendarGrid.appendChild(dayCell);
            }
        }
        
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
            updateStats();
        }
        
        function openEmotionModal(date) {
            selectedDate = date;
            const dateKey = formatDate(date);
            const emotion = emotionData[dateKey];
            
            document.getElementById('modalDate').textContent = 
                `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
            
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('selected'));
            if (emotion && emotions[emotion.type]) {
                const selectedBtn = document.querySelector(`.emotion-btn[data-emotion="${emotion.type}"]`);
                if (selectedBtn) selectedBtn.classList.add('selected');
                document.getElementById('emotionNote').value = emotion.note || '';
                document.getElementById('emotionIntensity').value = emotion.intensity || 3; 
            } else {
                document.getElementById('emotionNote').value = '';
                document.getElementById('emotionIntensity').value = 3; 
            }
            
            document.getElementById('emotionModal').style.display = 'block';
        }
        
        function closeEmotionModal() {
            document.getElementById('emotionModal').style.display = 'none';
            selectedDate = null;
        }
        
        function setupEmotionSelector() {
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.emotion-btn').forEach(b => 
                        b.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        function applyEmotionIconColors() {
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                const color = btn.dataset.color;
                const icon = btn.querySelector('i');
                if (icon && color) icon.style.color = color;
            });
        }

        function setupIntensitySlider() {
            const intensitySlider = document.getElementById('emotionIntensity');
            if (!intensitySlider) return;

            function updateSliderBackground() {
                const value = intensitySlider.value;
                const min = intensitySlider.min;
                const max = intensitySlider.max;
                const percentage = ((value - min) / (max - min)) * 100;
                // 채워진 부분은 #667eea, 안 채워진 부분은 #e1e8ed
                intensitySlider.style.background = `linear-gradient(to right, #667eea ${percentage}%, #e1e8ed ${percentage}%)`;
            }

            // 초기 배경 설정
            updateSliderBackground();
            // 슬라이더 값 변경 시 배경 업데이트
            intensitySlider.addEventListener('input', updateSliderBackground);
        }
        
        async function saveEmotion() {
            if (!selectedDate) return;
            
            const selectedBtn = document.querySelector('.emotion-btn.selected');
            if (!selectedBtn) {
                showMessage('감정을 선택해주세요.', 'error');
                return;
            }
            
            const emotionType = selectedBtn.dataset.emotion;
            const note = document.getElementById('emotionNote').value;
            const intensity = parseInt(document.getElementById('emotionIntensity').value, 10); 
            const dateKey = formatDate(selectedDate);
            
            const emotionRecord = {
                type: emotionType,
                note: note,
                date: dateKey,
                intensity: intensity, 
                timestamp: new Date().toISOString()
            };
            
            emotionData[dateKey] = emotionRecord;
            saveToLocalStorage('emotionData', emotionData);
            
            if (currentUser) {
                saveToFirestore('emotions', dateKey, emotionRecord);
            }
            
            closeEmotionModal();
            if (calendarViewMode === 'month') {
                renderCalendar();
                updateStats();
            } else {
                renderYearInPixels(currentPixelYear);
            }
            showMessage('감정이 기록되었습니다.', 'success');
        }
        
        async function deleteEmotion() {
            if (!selectedDate) return;
            
            const dateKey = formatDate(selectedDate);
            delete emotionData[dateKey];
            saveToLocalStorage('emotionData', emotionData);
            
            if (currentUser) {
                try {
                    await db.collection('emotions').doc(dateKey).delete();
                } catch (error) {
                    console.error('Firebase 삭제 실패:', error);
                }
            }
            
            closeEmotionModal();
            if (calendarViewMode === 'month') {
                renderCalendar();
                updateStats();
            } else {
                renderYearInPixels(currentPixelYear);
            }
            showMessage('감정 기록이 삭제되었습니다.', 'success');
        }
        
        function updateStats() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthData = Object.values(emotionData).filter(emotion => {
                if (!emotion || !emotion.date) return false;
                const emotionDate = new Date(emotion.date);
                return emotionDate.getFullYear() === year && 
                       emotionDate.getMonth() === month;
            });
            
            const emotionCounts = {};
            Object.keys(emotions).forEach(key => {
                emotionCounts[key] = 0;
            });
            
            monthData.forEach(emotion => {
                if (emotion && emotions[emotion.type]) {
                    emotionCounts[emotion.type]++;
                }
            });
            
            const total = monthData.length;
            const statsContainer = document.getElementById('emotionStats');
            statsContainer.innerHTML = '';
            
            Object.entries(emotionCounts).forEach(([type, count]) => {
                const percentage = total > 0 ? (count / total) * 100 : 0;
                
                const statDiv = document.createElement('div');
                statDiv.className = 'emotion-stat';
                statDiv.innerHTML = `
                    <span>${emotions[type]?.name || type}</span>
                    <div class="emotion-bar">
                        <div class="emotion-bar-fill" 
                             style="width: ${percentage}%; background: ${emotions[type]?.color || '#cccccc'};">
                        </div>
                    </div>
                    <span>${count}회</span>
                `;
                statsContainer.appendChild(statDiv);
            });
            
            updatePrescription(emotionCounts, total);
        }
        
        function updatePrescription(emotionCounts, total) {
            const prescriptionTextElement = document.getElementById('prescriptionText');
            if (total === 0) {
                prescriptionTextElement.textContent = '이번 달 감정 기록이 없습니다. 감정을 기록하시면 맞춤 처방전을 제공해드립니다.';
                return;
            }

            let sortedEmotions = Object.entries(emotionCounts)
                .filter(([type, count]) => emotions[type] && count > 0) 
                .sort(([, countA], [, countB]) => countB - countA);

            let primaryMessage = prescriptions.default;
            let secondaryMessage = "";

            if (sortedEmotions.length > 0) {
                const [dominantType, dominantCount] = sortedEmotions[0];
                if (prescriptions[dominantType]) {
                    const prescriptionLevels = prescriptions[dominantType];
                    for (const level of prescriptionLevels) {
                        if (dominantCount <= level.maxCount) {
                            primaryMessage = level.message;
                            break;
                        }
                    }
                }
            }

            if (sortedEmotions.length > 1) {
                const [secondType, secondCount] = sortedEmotions[1];
                const secondEmotionName = emotions[secondType]?.name || secondType;
                secondaryMessage += `\n\n또한 ${secondEmotionName} 감정을 ${secondCount}회 느끼셨군요. `;

                switch (secondType) {
                    case 'happy':
                    case 'calm':
                        secondaryMessage += `${secondEmotionName} 감정을 잘 느끼고 계시네요! 긍정적인 마음을 유지하는 당신을 응원합니다.`;
                        break;
                    case 'anxious':
                        secondaryMessage += `불안한 마음이 들 때는 심호흡이나 짧은 스트레칭으로 긴장을 풀어보세요.`;
                        break;
                    case 'sad':
                        secondaryMessage += `슬픈 마음이 들 때는 자신에게 따뜻한 위로를 건네거나 좋아하는 활동에 집중해보세요.`;
                        break;
                    case 'angry':
                        secondaryMessage += `화나는 마음이 들 때는 잠시 상황에서 벗어나 감정을 가라앉히는 시간을 가져보세요.`;
                        break;
                    default:
                        secondaryMessage += `이 감정에 대해서도 주의를 기울여보세요.`;
                }
            }
            
            if (typeof primaryMessage === 'string') {
                prescriptionTextElement.textContent = primaryMessage + secondaryMessage;
            } else {
                prescriptionTextElement.textContent = "처방전 로드 오류: 메시지 형식이 올바르지 않습니다.";
            }
        }
        
        async function loadEmotionData() {
            const localData = loadFromLocalStorage('emotionData');
            if (localData) {
                emotionData = localData;
            }
            
            if (currentUser) {
                try {
                    const snapshot = await db.collection('emotions')
                        .where('userId', '==', currentUser.uid)
                        .get();
                    
                    const firebaseData = {};
                    snapshot.forEach(doc => {
                        firebaseData[doc.id] = doc.data();
                    });
                    
                    emotionData = { ...localData, ...firebaseData };
                    saveToLocalStorage('emotionData', emotionData);
                } catch (error) {
                    console.error('Firebase 감정 데이터 로드 실패:', error);
                }
            }
        }

        function renderYearInPixels(year) {
            document.getElementById('pixelYearDisplay').textContent = `${year}년 감정 지도`;
            const gridContainer = document.getElementById('pixelsGridContainer');
            gridContainer.innerHTML = ''; 

            const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"];

            for (let month = 0; month < 12; month++) {
                const monthWrapper = document.createElement('div');
                monthWrapper.className = 'pixel-month-wrapper';

                const monthLabel = document.createElement('div');
                monthLabel.className = 'pixel-month-label';
                monthLabel.textContent = monthNames[month];
                monthWrapper.appendChild(monthLabel);

                const monthGrid = document.createElement('div');
                monthGrid.className = 'pixels-grid';

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, month, 1).getDay(); 

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyPixel = document.createElement('div');
                    emptyPixel.style.visibility = 'hidden'; 
                    monthGrid.appendChild(emptyPixel);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const cellDate = new Date(year, month, day);
                    const dateKey = formatDate(cellDate);
                    const emotionRecord = emotionData[dateKey];
                    
                    const pixel = document.createElement('div');
                    pixel.className = 'pixel-day';
                    pixel.title = `${dateKey} - ${emotionRecord && emotions[emotionRecord.type] ? emotions[emotionRecord.type].name : '기록 없음'}`;
                    
                    if (emotionRecord && emotions[emotionRecord.type]) {
                        const baseColor = emotions[emotionRecord.type].color;
                        const intensity = emotionRecord.intensity || 3;
                        const lightnessMap = [0, 0.7, 0.5, 0.3, 0.1, 0];
                        const lightnessFactor = lightnessMap[intensity] !== undefined ? lightnessMap[intensity] : lightnessMap[3];
                        pixel.style.backgroundColor = lightenHexColor(baseColor, lightnessFactor);
                    } else {
                        pixel.style.backgroundColor = '#efefef'; 
                    }
                    
                    pixel.addEventListener('click', () => {
                        openEmotionModal(cellDate);
                    });
                    monthGrid.appendChild(pixel);
                }
                monthWrapper.appendChild(monthGrid);
                gridContainer.appendChild(monthWrapper);
            }
        }

        function changePixelYear(direction) {
            currentPixelYear += direction;
            renderYearInPixels(currentPixelYear);
        }

        function toggleCalendarView() {
            // const monthViewContainer = document.getElementById('monthViewContainer'); // 월별 달력은 항상 표시되므로 직접 제어 X
            const yearViewElement = document.getElementById('yearInPixelsView');
            const toggleButton = document.getElementById('toggleViewButton');

            if (!yearViewElement || !toggleButton) {
                console.error("뷰 전환에 필요한 HTML 요소 중 일부를 찾을 수 없습니다.");
                showMessage("화면 전환 중 오류가 발생했습니다.", "error");
                return;
            }

            // 픽셀 뷰를 열려고 할 때
            if (yearViewElement.style.display === 'none' || calendarViewMode === 'month') {
                // 감정 기록이 있는지 확인
                if (Object.keys(emotionData).length === 0) {
                    showMessage('색상일기 기록이 없어요. 감정일기를 기록하면 픽셀뷰를 볼 수 있어요', 'info');
                    return; // 픽셀 뷰를 열지 않고 함수 종료
                }
                
                yearViewElement.style.display = 'block';
                currentPixelYear = currentDate.getFullYear(); 
                renderYearInPixels(currentPixelYear);
                toggleButton.textContent = '픽셀 뷰 닫기'; // 버튼 텍스트 변경
                calendarViewMode = 'year';
            } else { // 픽셀 뷰를 닫으려고 할 때
                yearViewElement.style.display = 'none';
                toggleButton.textContent = '년도별 감정보기 픽셀뷰'; // 버튼 텍스트 원래대로
                calendarViewMode = 'month';
            }
        }
        
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        function lightenHexColor(hex, factor) {
            if (!hex || typeof hex !== 'string' || hex.charAt(0) !== '#') return '#cccccc'; 
            
            let r = parseInt(hex.slice(1, 3), 16);
            let g = parseInt(hex.slice(3, 5), 16);
            let b = parseInt(hex.slice(5, 7), 16);

            r = Math.round(r + (255 - r) * factor);
            g = Math.round(g + (255 - g) * factor);
            b = Math.round(b + (255 - b) * factor);

            r = Math.min(255, Math.max(0, r));
            g = Math.min(255, Math.max(0, g));
            b = Math.min(255, Math.max(0, b));

            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('emotionModal');
            if (event.target === modal) {
                closeEmotionModal();
            }
        });
    </script>
    
    <style>
        .emotion-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .emotion-btn {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .emotion-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .emotion-btn.selected {
            border-color: #667eea;
            background: #f8f9ff;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .emotion-btn i {
            font-size: 2rem;
            color: #667eea;
        }
        
        .emotion-btn span {
            font-weight: 500;
            color: #333;
        }
        /* 감정 버튼 아이콘 색상 일치 */
        .emotion-btn[data-emotion="happy"] i {
            color: #f39c12 !important;
        }
        .emotion-btn[data-emotion="calm"] i {
            color: #00a693 !important;
        }
        .emotion-btn[data-emotion="anxious"] i {
            color: #8e44ad !important;
        }
        .emotion-btn[data-emotion="sad"] i {
            color: #2980b9 !important;
        }
        .emotion-btn[data-emotion="angry"] i {
            color: #c0392b !important;
            color: #e74c3c !important; /* 화남 색상 변경 */
        }
        .emotion-btn.selected i { /* 선택 시 아이콘 색상도 유지 또는 변경 */
            /* color: white; */ /* 만약 선택 시 배경색이 아이콘 색과 같아져서 안보인다면 흰색 등으로 변경 */
            /* 현재 .selected 배경색이 밝아서 아이콘 색상이 잘 보이므로 주석 처리 유지 */
        }
    </style>
</body>
</html>
