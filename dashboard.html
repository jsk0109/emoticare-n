<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 마음 정원 - EmotiCare</title>
    <link rel="stylesheet" href="styles.css?v=20240701b"> <!-- 스타일시트 버전 업데이트 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* 반응형 그리드 조정 */
            gap: 1.5rem;
        }
        .dashboard-card {
            /* .content-block 스타일을 기본으로 사용 */
            display: flex;
            flex-direction: column;
            min-height: 200px; /* 카드 최소 높이 */
        }
        .dashboard-card-title {
            font-size: 1.3rem; /* 제목 크기 조정 */
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #667eea; /* 강조선 변경 */
            padding-bottom: 0.75rem; /* 패딩 조정 */
            display: flex;
            align-items: center;
        }
        .dashboard-card-title i {
            margin-right: 0.75rem;
            color: #667eea;
        }
        .welcome-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem; /* 패딩 조정 */
            border-radius: 15px;
            margin-bottom: 2rem; /* 마진 조정 */
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.25);
        }
        .welcome-message h2 {
            font-size: 1.8rem; /* 제목 크기 조정 */
            margin-bottom: 0.5rem;
        }
        .welcome-message p {
            font-size: 1rem; /* 부제목 크기 조정 */
            opacity: 0.9;
        }
        .quick-links ul {
            list-style: none;
            padding: 0;
        }
        .quick-links li {
            margin-bottom: 0.5rem;
        }
        .quick-links a {
            display: inline-block; /* 전체 너비 대신 내용만큼 */
            padding: 0.5rem 0;
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s, transform 0.2s ease;
            font-weight: 500;
        }
        .quick-links a:hover {
            color: #764ba2;
            transform: translateX(3px);
        }
        .dashboard-card-content {
            flex-grow: 1; /* 내용이 카드를 채우도록 */
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .dashboard-card-content p {
            margin-bottom: 0.75rem;
        }
        .dashboard-card-content .data-highlight {
            font-weight: bold;
            color: #555;
        }
        .dashboard-card .btn-outline { /* 카드 내 버튼 스타일 조정 */
            margin-top: auto; /* 버튼을 카드 하단으로 밀기 */
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            align-self: flex-start; /* 버튼 왼쪽 정렬 */
        }
         .no-data-message {
            color: #777;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .welcome-message { padding: 1.5rem; margin-bottom: 1.5rem; }
            .welcome-message h2 { font-size: 1.5rem; }
            .welcome-message p { font-size: 0.9rem; }
            .dashboard-card-title { font-size: 1.15rem; }
            .dashboard-card-content { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>

    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">나의 마음 정원</h1>
                <p class="page-subtitle">오늘 하루, 당신의 마음 상태를 한눈에 살펴보세요.</p>
            </div>
        </section>

        <section class="page-content style="padding-top: 3rem;">
            <div class="page-inner-container dashboard-container">
                <div class="welcome-message">
                    <h2 id="dashboardWelcomeText">OOO님, 안녕하세요!</h2>
                    <p>오늘도 마음챙김 여정을 함께 해주셔서 감사합니다.</p>
                    <button class="btn-secondary" style="margin-top: 1rem; background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3);" onclick="openProfileSettings()">
                        <i class="fas fa-user-edit"></i> 프로필 변경
                    </button>
                </div>

                <div class="dashboard-grid" style="margin-bottom: 8rem; gap: rem;">
                    <div class="content-block dashboard-card" id="todayEmotionCard">
                        <h3 class="dashboard-card-title"><i class="fas fa-palette"></i> 오늘의 감정</h3>
                        <div class="dashboard-card-content">
                            <p class="no-data-message">오늘의 감정이 아직 기록되지 않았어요.</p>
                        </div>
                        <a href="color-journal.html" class="btn-outline">감정일기 쓰러가기 <i class="fas fa-arrow-right fa-xs"></i></a>
                    </div>

                    <div class="content-block dashboard-card" id="recentLetterCard">
                        <h3 class="dashboard-card-title"><i class="fas fa-envelope-open-text"></i> 최근 감정 편지</h3>
                        <div class="dashboard-card-content">
                            <p class="no-data-message">최근 작성한 편지가 없어요.</p>
                        </div>
                        <a href="emotion-letters.html" class="btn-outline">편지 쓰러가기 <i class="fas fa-arrow-right fa-xs"></i></a>
                    </div>

                    <div class="content-block dashboard-card" id="recentMoodRoutineCard">
                        <h3 class="dashboard-card-title"><i class="fas fa-calendar-check"></i> 최근 하루 기록</h3>
                        <div class="dashboard-card-content">
                            <p class="no-data-message">최근 하루 기록이 없어요.</p>
                        </div>
                        <a href="mood-routine.html" class="btn-outline">하루 기록하기 <i class="fas fa-arrow-right fa-xs"></i></a>
                    </div>
                    
                    <div class="content-block dashboard-card" id="quickAccessCard">
                        <h3 class="dashboard-card-title"><i class="fas fa-rocket"></i> 빠른 시작</h3>
                        <div class="dashboard-card-content quick-links">
                            <ul>
                                <li><a href="healing-cards.html"><i class="fas fa-hand-holding-heart fa-fw"></i> 오늘의 힐링 카드 뽑기</a></li>
                                <li><a href="quotes.html"><i class="fas fa-quote-left fa-fw"></i> 치유 명언 보기</a></li>
                                <li><a href="reflection-questions.html"><i class="fas fa-question-circle fa-fw"></i> 성찰 질문 보기</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-container"></div>

    <!-- 프로필 변경 모달 시작 -->
    <div id="profileSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>프로필 변경</h3>
                <button class="modal-close" onclick="closeProfileSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileSettingsForm">
                    <div class="form-group">
                        <label for="displayNameInput">닉네임</label>
                        <input type="text" id="displayNameInput" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="emailDisplay" style="font-weight: normal; color: #666;">이메일 (변경 불가)</label>
                        <input type="email" id="emailDisplay" class="form-input" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem; justify-content: center;">저장하기</button>
                </form>
            </div>
        </div>
    </div>
    <!-- 프로필 변경 모달 끝 -->

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        // color-journal.html의 emotions 객체와 유사하게 정의 (대시보드용)
        const emotionsMapForDashboard = {
            happy: { name: '기쁨', color: '#f39c12', icon: 'fas fa-laugh' },
            calm: { name: '평온', color: '#00a693', icon: 'fas fa-smile' },
            anxious: { name: '불안', color: '#8e44ad', icon: 'fas fa-meh' },
            sad: { name: '슬픔', color: '#2980b9', icon: 'fas fa-sad-tear' },
            angry: { name: '화남', color: '#ee4801', icon: 'fas fa-angry' }
        };
        // mood-routine.html의 moodEmojis 객체와 유사하게 정의 (대시보드용)
        const moodEmojisForDashboard = {
            "행복": "😄", "기쁨": "😊", "설렘": "🤩", "평온": "😌", "감사": "🙏",
            "보통": "😐", "피곤": "😩", "슬픔": "😢", "화남": "😠", "불안": "😟"
        };


        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('authStateReady', function(e) {
                currentUser = e.detail.user; 
                updateWelcomeMessage();
                loadDashboardContent();
            });
        });

        function updateWelcomeMessage() {
            const welcomeTextElement = document.getElementById('dashboardWelcomeText');
            if (currentUser) {
                welcomeTextElement.textContent = `${currentUser.displayName || currentUser.email}님, 안녕하세요!`;
            } else {
                welcomeTextElement.textContent = '로그인이 필요합니다.';
            }
        }

        async function loadDashboardContent() {
            if (currentUser) {
                console.log('[Dashboard] Current user detected:', currentUser.uid, '. Loading content...');
                await loadTodayEmotionSummary();
                await loadRecentEmotionLetter();
                await loadRecentMoodRoutine();
            } else {
                console.log('[Dashboard] No current user. Displaying login prompts.');
                document.getElementById('todayEmotionCard').querySelector('.dashboard-card-content').innerHTML = `<p class="no-data-message">로그인 후 이용해주세요. <a href="#" onclick="showLoginModal(); return false;">로그인</a></p>`;
                document.getElementById('recentLetterCard').querySelector('.dashboard-card-content').innerHTML = `<p class="no-data-message">로그인 후 이용해주세요. <a href="#" onclick="showLoginModal(); return false;">로그인</a></p>`;
                document.getElementById('recentMoodRoutineCard').querySelector('.dashboard-card-content').innerHTML = `<p class="no-data-message">로그인 후 이용해주세요. <a href="#" onclick="showLoginModal(); return false;">로그인</a></p>`;
            }
        }

        async function loadTodayEmotionSummary() {
            const cardContent = document.getElementById('todayEmotionCard').querySelector('.dashboard-card-content');
            if (!currentUser) {
                console.log('[Dashboard] loadTodayEmotionSummary: No currentUser. Aborting.');
                return;
            }

            const todayDateKey = formatDate(new Date()); 
            console.log('[Dashboard] loadTodayEmotionSummary: Attempting to load for dateKey:', todayDateKey, 'User:', currentUser.uid);

            try {
                // color-journal.html에서는 문서 ID로 dateKey (YYYY-MM-DD)를 사용하고,
                // 문서 내에 userId 필드를 저장합니다.
                const querySnapshot = await db.collection(컬렉션_이름_맵.색상일기)
                                          .where(firebase.firestore.FieldPath.documentId(), '==', todayDateKey) // 문서 ID로 직접 조회
                                          .where('userId', '==', currentUser.uid) // userId 필드로 필터링
                                          .limit(1) 
                                          .get();

                console.log('[Dashboard] Today Emotion Snapshot: Fetched', querySnapshot.size, 'docs for ID:', todayDateKey, 'and user:', currentUser.uid);

                if (!querySnapshot.empty) {
                    const docSnap = querySnapshot.docs[0];
                    const emotionRecord = docSnap.data();
                    console.log('[Dashboard] Today Emotion Data FOUND:', emotionRecord);
                    const emotionInfo = emotionsMapForDashboard[emotionRecord.type] || { name: emotionRecord.type, color: '#777', icon: 'fas fa-question-circle' }; 

                    cardContent.innerHTML = `
                        <p>오늘 당신의 주된 감정은 <span style="color:${emotionInfo.color}; font-weight:bold;">
                            <i class="${emotionInfo.icon}"></i> ${emotionInfo.name}</span> 입니다.
                        </p>
                        <p>감정 강도: <span class="data-highlight">${emotionRecord.intensity || '미지정'}</span></p>
                        ${emotionRecord.note ? `<p style="font-size:0.9em; color:#555; margin-top:0.3rem;"><em>"${emotionRecord.note.substring(0,50)}${emotionRecord.note.length > 50 ? '...' : ''}"</em></p>` : ''}
                    `;
                } else {
                    console.log('[Dashboard] No today emotion record found for user and dateKey.');
                    cardContent.innerHTML = `<p class="no-data-message">오늘의 감정이 아직 기록되지 않았어요.</p>`;
                }
            } catch (error) {
                console.error("오늘의 감정 요약 로드 실패:", error);
                cardContent.innerHTML = `<p class="no-data-message">감정 정보를 불러오는 데 실패했습니다.</p>`;
            }
        }

        async function loadRecentEmotionLetter() {
            const cardContent = document.getElementById('recentLetterCard').querySelector('.dashboard-card-content');
            if (!currentUser) {
                console.log('[Dashboard] loadRecentEmotionLetter: No currentUser. Aborting.');
                return;
            }
            console.log('[Dashboard] loadRecentEmotionLetter: Attempting to load for user:', currentUser.uid);

            try {
                const snapshot = await db.collection(컬렉션_이름_맵.감정편지)
                                       .where('userId', '==', currentUser.uid)
                                       .orderBy('date', 'desc')
                                       .limit(1)
                                       .get();
                console.log('[Dashboard] Recent Emotion Letter Snapshot: Fetched', snapshot.size, 'docs.');
                if (!snapshot.empty) {
                    const letter = snapshot.docs[0].data();
                    console.log('[Dashboard] Recent Emotion Letter Data FOUND:', letter);
                    const letterDate = new Date(letter.date);
                    cardContent.innerHTML = `
                        <p><span class="data-highlight">${letterDate.toLocaleDateString('ko-KR')}</span>에 작성한 편지:</p>
                        <p style="font-size:0.9em; color:#555;"><em>"${letter.preview || letter.content.substring(0,70)}${letter.content.length > 70 ? '...' : ''}"</em></p>
                    `;
                } else {
                    console.log('[Dashboard] No recent emotion letter found for user.');
                    cardContent.innerHTML = `<p class="no-data-message">최근 작성한 편지가 없어요.</p>`;
                }
            } catch (error) {
                console.error("최근 감정 편지 로드 실패:", error);
                cardContent.innerHTML = `<p class="no-data-message">편지 정보를 불러오는 데 실패했습니다.</p>`;
            }
        }

        async function loadRecentMoodRoutine() {
            const cardContent = document.getElementById('recentMoodRoutineCard').querySelector('.dashboard-card-content');
            if (!currentUser) {
                console.log('[Dashboard] loadRecentMoodRoutine: No currentUser. Aborting.');
                return;
            }
            console.log('[Dashboard] loadRecentMoodRoutine: Attempting to load for user:', currentUser.uid);

            try {
                const snapshot = await db.collection(컬렉션_이름_맵.하루기분기록)
                                       .where('userId', '==', currentUser.uid)
                                       .orderBy('dateString', 'desc') // dateString (YYYY-MM-DD)으로 정렬
                                       .limit(1)
                                       .get();
                console.log('[Dashboard] Recent Mood Routine Snapshot: Fetched', snapshot.size, 'docs.');
                if (!snapshot.empty) {
                    const routine = snapshot.docs[0].data();
                    console.log('[Dashboard] Recent Mood Routine Data FOUND:', routine);
                    const moodEmoji = moodEmojisForDashboard[routine.mood] || routine.mood;
                    cardContent.innerHTML = `
                        <p><span class="data-highlight">${routine.dateString}</span> 기록:</p>
                        <p>기분: <span class="data-highlight">${moodEmoji} ${routine.mood}</span></p>
                        ${routine.gratitude ? `<p style="font-size:0.9em; color:#555;">감사: <em>${routine.gratitude.substring(0,50)}${routine.gratitude.length > 50 ? '...' : ''}</em></p>` : ''}
                        ${routine.routine ? `<p style="font-size:0.9em; color:#555;">루틴: <em>${routine.routine.substring(0,50)}${routine.routine.length > 50 ? '...' : ''}</em></p>` : ''}
                    `;
                } else {
                    console.log('[Dashboard] No recent mood routine found for user.');
                    cardContent.innerHTML = `<p class="no-data-message">최근 하루 기록이 없어요.</p>`;
                }
            } catch (error) {
                console.error("최근 하루 기록 로드 실패:", error);
                cardContent.innerHTML = `<p class="no-data-message">하루 기록 정보를 불러오는 데 실패했습니다.</p>`;
            }
        }


        function openProfileSettings() {
            if (!currentUser) {
                showMessage('로그인이 필요합니다.', 'error');
                showLoginModal();
                return;
            }
            const modal = document.getElementById('profileSettingsModal');
            if (!modal) {
                console.error("프로필 변경 모달 요소를 찾을 수 없습니다.");
                showMessage('프로필 변경 창을 여는 데 필요한 구성 요소를 찾을 수 없습니다.', 'error');
                return;
            }

            const displayNameInput = document.getElementById('displayNameInput');
            const emailDisplay = document.getElementById('emailDisplay');
            if (!displayNameInput || !emailDisplay) {
                console.error("프로필 변경 모달 내부 필드를 찾을 수 없습니다.");
                showMessage('프로필 변경 창의 내부 구성 요소를 찾을 수 없습니다.', 'error');
                return;
            }

            displayNameInput.value = currentUser.displayName || '';
            emailDisplay.value = currentUser.email || '';
            
            modal.style.display = 'block';

            const form = document.getElementById('profileSettingsForm');
            if (!form) {
                console.error("프로필 설정 폼 요소를 찾을 수 없습니다.");
                return;
            }
            // 기존 이벤트 리스너 제거 후 새로 추가 (중복 방지)
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            newForm.addEventListener('submit', handleProfileUpdate);
        }

        function closeProfileSettingsModal() {
            const modal = document.getElementById('profileSettingsModal');
            if (modal) modal.style.display = 'none';
        }

        async function handleProfileUpdate(event) {
            event.preventDefault();
            if (!currentUser) return;

            const newDisplayName = document.getElementById('displayNameInput').value.trim();
            if (!newDisplayName) {
                showMessage('닉네임을 입력해주세요.', 'error');
                return;
            }

            try {
                await currentUser.updateProfile({
                    displayName: newDisplayName
                });
                
                showMessage('프로필이 성공적으로 변경되었습니다.', 'success');
                updateWelcomeMessage(); 
                updateAuthUI(currentUser); 
                closeProfileSettingsModal();
            } catch (error) {
                console.error("프로필 업데이트 실패:", error);
                showMessage(`프로필 변경에 실패했습니다: ${error.message}`, 'error');
            }
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('profileSettingsModal');
            if (event.target === modal) {
                closeProfileSettingsModal();
            }
        });
    </script>
</body>
</html>
