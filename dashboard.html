<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ë§ˆìŒ ì •ì› - EmotiCare</title>
    <link rel="stylesheet" href="styles.css?v=20240701b"> <!-- ìŠ¤íƒ€ì¼ì‹œíŠ¸ ë²„ì „ ì—…ë°ì´íŠ¸ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ ì¡°ì • */
            gap: 1.5rem;
        }
        .dashboard-card {
            /* .content-block ìŠ¤íƒ€ì¼ì„ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš© */
            display: flex;
            flex-direction: column;
            min-height: 200px; /* ì¹´ë“œ ìµœì†Œ ë†’ì´ */
        }
        .dashboard-card-title {
            font-size: 1.3rem; /* ì œëª© í¬ê¸° ì¡°ì • */
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #667eea; /* ê°•ì¡°ì„  ë³€ê²½ */
            padding-bottom: 0.75rem; /* íŒ¨ë”© ì¡°ì • */
            display: flex;
            align-items: center;
        }
        .dashboard-card-title i {
            margin-right: 0.75rem;
            color: #667eea;
        }
        .welcome-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem; /* íŒ¨ë”© ì¡°ì • */
            border-radius: 15px;
            margin-bottom: 2rem; /* ë§ˆì§„ ì¡°ì • */
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.25);
        }
        .welcome-message h2 {
            font-size: 1.8rem; /* ì œëª© í¬ê¸° ì¡°ì • */
            margin-bottom: 0.5rem;
        }
        .welcome-message p {
            font-size: 1rem; /* ë¶€ì œëª© í¬ê¸° ì¡°ì • */
            opacity: 0.9;
        }
        .quick-links ul {
            list-style: none;
            padding: 0;
        }
        .quick-links li {
            margin-bottom: 0.5rem;
        }
        .quick-links a {
            display: inline-block; /* ì „ì²´ ë„ˆë¹„ ëŒ€ì‹  ë‚´ìš©ë§Œí¼ */
            padding: 0.5rem 0;
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s, transform 0.2s ease;
            font-weight: 500;
        }
        .quick-links a:hover {
            color: #764ba2;
            transform: translateX(3px);
        }
        .dashboard-card-content {
            flex-grow: 1; /* ë‚´ìš©ì´ ì¹´ë“œë¥¼ ì±„ìš°ë„ë¡ */
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .dashboard-card-content p {
            margin-bottom: 0.75rem;
        }
        .dashboard-card-content .data-highlight {
            font-weight: bold;
            color: #555;
        }
        .dashboard-card .btn-outline { /* ì¹´ë“œ ë‚´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¡°ì • */
            margin-top: auto; /* ë²„íŠ¼ì„ ì¹´ë“œ í•˜ë‹¨ìœ¼ë¡œ ë°€ê¸° */
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            align-self: flex-start; /* ë²„íŠ¼ ì™¼ìª½ ì •ë ¬ */
        }
         .no-data-message {
            color: #777;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .welcome-message { padding: 1.5rem; margin-bottom: 1.5rem; }
            .welcome-message h2 { font-size: 1.5rem; }
            .welcome-message p { font-size: 0.9rem; }
            .dashboard-card-title { font-size: 1.15rem; }
            .dashboard-card-content { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>

    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">ë‚˜ì˜ ë§ˆìŒ ì •ì›</h1>
                <p class="page-subtitle">ì˜¤ëŠ˜ í•˜ë£¨, ë‹¹ì‹ ì˜ ë§ˆìŒ ìƒíƒœë¥¼ í•œëˆˆì— ì‚´í´ë³´ì„¸ìš”.</p>
            </div>
        </section>

        <section class="page-content style="padding-top: 3rem;">
            <div class="page-inner-container dashboard-container">
                <div class="welcome-message">
                    <h2 id="dashboardWelcomeText">OOOë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</h2>
                    <p>ì˜¤ëŠ˜ë„ ë§ˆìŒì±™ê¹€ ì—¬ì •ì„ í•¨ê»˜ í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
                    <button class="btn-secondary" style="margin-top: 1rem; background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3);" onclick="openProfileSettings()">
                        <i class="fas fa-user-edit"></i> í”„ë¡œí•„ ë³€ê²½
                    </button>
                </div>

                <div class="dashboard-grid" style="margin-bottom: 8rem; gap: rem;">
                    <div class="content-block dashboard-card" id="todayEmotionCard">
                        <h3 class="dashboard-card-title"><i class="fas fa-palette"></i> ì˜¤ëŠ˜ì˜ ê°ì •</h3>
                        <div class="dashboard-card-content">
                            <p class="no-data-message">ì˜¤ëŠ˜ì˜ ê°ì •ì´ ì•„ì§ ê¸°ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”.</p>
                        </div>
                        <a href="color-journal.html" class="btn-outline">ê°ì •ì¼ê¸° ì“°ëŸ¬ê°€ê¸° <i class="fas fa-arrow-right fa-xs"></i></a>
                    </div>

                    <div class="content-block dashboard-card" id="recentLetterCard">
                        <h3 class="dashboard-card-title"><i class="fas fa-envelope-open-text"></i> ìµœê·¼ ê°ì • í¸ì§€</h3>
                        <div class="dashboard-card-content">
                            <p class="no-data-message">ìµœê·¼ ì‘ì„±í•œ í¸ì§€ê°€ ì—†ì–´ìš”.</p>
                        </div>
                        <a href="emotion-letters.html" class="btn-outline">í¸ì§€ ì“°ëŸ¬ê°€ê¸° <i class="fas fa-arrow-right fa-xs"></i></a>
                    </div>

                    <div class="content-block dashboard-card" id="recentMoodRoutineCard">
                        <h3 class="dashboard-card-title"><i class="fas fa-calendar-check"></i> ìµœê·¼ í•˜ë£¨ ê¸°ë¡</h3>
                        <div class="dashboard-card-content">
                            <p class="no-data-message">ìµœê·¼ í•˜ë£¨ ê¸°ë¡ì´ ì—†ì–´ìš”.</p>
                        </div>
                        <a href="mood-routine.html" class="btn-outline">í•˜ë£¨ ê¸°ë¡í•˜ê¸° <i class="fas fa-arrow-right fa-xs"></i></a>
                    </div>
                    
                    <div class="content-block dashboard-card" id="quickAccessCard">
                        <h3 class="dashboard-card-title"><i class="fas fa-rocket"></i> ë¹ ë¥¸ ì‹œì‘</h3>
                        <div class="dashboard-card-content quick-links">
                            <ul>
                                <li><a href="healing-cards.html"><i class="fas fa-hand-holding-heart fa-fw"></i> ì˜¤ëŠ˜ì˜ íë§ ì¹´ë“œ ë½‘ê¸°</a></li>
                                <li><a href="quotes.html"><i class="fas fa-quote-left fa-fw"></i> ì¹˜ìœ  ëª…ì–¸ ë³´ê¸°</a></li>
                                <li><a href="reflection-questions.html"><i class="fas fa-question-circle fa-fw"></i> ì„±ì°° ì§ˆë¬¸ ë³´ê¸°</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer-container"></div>

    <!-- í”„ë¡œí•„ ë³€ê²½ ëª¨ë‹¬ ì‹œì‘ -->
    <div id="profileSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>í”„ë¡œí•„ ë³€ê²½</h3>
                <button class="modal-close" onclick="closeProfileSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileSettingsForm">
                    <div class="form-group">
                        <label for="displayNameInput">ë‹‰ë„¤ì„</label>
                        <input type="text" id="displayNameInput" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="emailDisplay" style="font-weight: normal; color: #666;">ì´ë©”ì¼ (ë³€ê²½ ë¶ˆê°€)</label>
                        <input type="email" id="emailDisplay" class="form-input" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem; justify-content: center;">ì €ì¥í•˜ê¸°</button>
                </form>
            </div>
        </div>
    </div>
    <!-- í”„ë¡œí•„ ë³€ê²½ ëª¨ë‹¬ ë -->

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        // color-journal.htmlì˜ emotions ê°ì²´ì™€ ìœ ì‚¬í•˜ê²Œ ì •ì˜ (ëŒ€ì‹œë³´ë“œìš©)
        const emotionsMapForDashboard = {
            happy: { name: 'ê¸°ì¨', color: '#f39c12', icon: 'fas fa-laugh' },
            calm: { name: 'í‰ì˜¨', color: '#00a693', icon: 'fas fa-smile' },
            anxious: { name: 'ë¶ˆì•ˆ', color: '#8e44ad', icon: 'fas fa-meh' },
            sad: { name: 'ìŠ¬í””', color: '#2980b9', icon: 'fas fa-sad-tear' },
            angry: { name: 'í™”ë‚¨', color: '#ee4801', icon: 'fas fa-angry' }
        };
        // mood-routine.htmlì˜ moodEmojis ê°ì²´ì™€ ìœ ì‚¬í•˜ê²Œ ì •ì˜ (ëŒ€ì‹œë³´ë“œìš©)
        const moodEmojisForDashboard = {
            "í–‰ë³µ": "ğŸ˜„", "ê¸°ì¨": "ğŸ˜Š", "ì„¤ë ˜": "ğŸ¤©", "í‰ì˜¨": "ğŸ˜Œ", "ê°ì‚¬": "ğŸ™",
            "ë³´í†µ": "ğŸ˜", "í”¼ê³¤": "ğŸ˜©", "ìŠ¬í””": "ğŸ˜¢", "í™”ë‚¨": "ğŸ˜ ", "ë¶ˆì•ˆ": "ğŸ˜Ÿ"
        };


        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('authStateReady', function(e) {
                currentUser = e.detail.user; 
                updateWelcomeMessage();
                loadDashboardContent();
            });
        });

        function updateWelcomeMessage() {
            const welcomeTextElement = document.getElementById('dashboardWelcomeText');
            if (currentUser) {
                welcomeTextElement.textContent = `${currentUser.displayName || currentUser.email}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!`;
            } else {
                welcomeTextElement.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
            }
        }

        async function loadDashboardContent() {
            if (currentUser) {
                console.log('[Dashboard] Current user detected:', currentUser.uid, '. Loading content...');
                await loadTodayEmotionSummary();
                await loadRecentEmotionLetter();
                await loadRecentMoodRoutine();
            } else {
                console.log('[Dashboard] No current user. Displaying login prompts.');
                document.getElementById('todayEmotionCard').querySelector('.dashboard-card-content').innerHTML = `<p class="no-data-message">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”. <a href="#" onclick="showLoginModal(); return false;">ë¡œê·¸ì¸</a></p>`;
                document.getElementById('recentLetterCard').querySelector('.dashboard-card-content').innerHTML = `<p class="no-data-message">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”. <a href="#" onclick="showLoginModal(); return false;">ë¡œê·¸ì¸</a></p>`;
                document.getElementById('recentMoodRoutineCard').querySelector('.dashboard-card-content').innerHTML = `<p class="no-data-message">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”. <a href="#" onclick="showLoginModal(); return false;">ë¡œê·¸ì¸</a></p>`;
            }
        }

        async function loadTodayEmotionSummary() {
            const cardContent = document.getElementById('todayEmotionCard').querySelector('.dashboard-card-content');
            if (!currentUser) {
                console.log('[Dashboard] loadTodayEmotionSummary: No currentUser. Aborting.');
                return;
            }

            const todayDateKey = formatDate(new Date()); 
            console.log('[Dashboard] loadTodayEmotionSummary: Attempting to load for dateKey:', todayDateKey, 'User:', currentUser.uid);

            try {
                // color-journal.htmlì—ì„œëŠ” ë¬¸ì„œ IDë¡œ dateKey (YYYY-MM-DD)ë¥¼ ì‚¬ìš©í•˜ê³ ,
                // ë¬¸ì„œ ë‚´ì— userId í•„ë“œë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
                const querySnapshot = await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.ìƒ‰ìƒì¼ê¸°)
                                          .where(firebase.firestore.FieldPath.documentId(), '==', todayDateKey) // ë¬¸ì„œ IDë¡œ ì§ì ‘ ì¡°íšŒ
                                          .where('userId', '==', currentUser.uid) // userId í•„ë“œë¡œ í•„í„°ë§
                                          .limit(1) 
                                          .get();

                console.log('[Dashboard] Today Emotion Snapshot: Fetched', querySnapshot.size, 'docs for ID:', todayDateKey, 'and user:', currentUser.uid);

                if (!querySnapshot.empty) {
                    const docSnap = querySnapshot.docs[0];
                    const emotionRecord = docSnap.data();
                    console.log('[Dashboard] Today Emotion Data FOUND:', emotionRecord);
                    const emotionInfo = emotionsMapForDashboard[emotionRecord.type] || { name: emotionRecord.type, color: '#777', icon: 'fas fa-question-circle' }; 

                    cardContent.innerHTML = `
                        <p>ì˜¤ëŠ˜ ë‹¹ì‹ ì˜ ì£¼ëœ ê°ì •ì€ <span style="color:${emotionInfo.color}; font-weight:bold;">
                            <i class="${emotionInfo.icon}"></i> ${emotionInfo.name}</span> ì…ë‹ˆë‹¤.
                        </p>
                        <p>ê°ì • ê°•ë„: <span class="data-highlight">${emotionRecord.intensity || 'ë¯¸ì§€ì •'}</span></p>
                        ${emotionRecord.note ? `<p style="font-size:0.9em; color:#555; margin-top:0.3rem;"><em>"${emotionRecord.note.substring(0,50)}${emotionRecord.note.length > 50 ? '...' : ''}"</em></p>` : ''}
                    `;
                } else {
                    console.log('[Dashboard] No today emotion record found for user and dateKey.');
                    cardContent.innerHTML = `<p class="no-data-message">ì˜¤ëŠ˜ì˜ ê°ì •ì´ ì•„ì§ ê¸°ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”.</p>`;
                }
            } catch (error) {
                console.error("ì˜¤ëŠ˜ì˜ ê°ì • ìš”ì•½ ë¡œë“œ ì‹¤íŒ¨:", error);
                cardContent.innerHTML = `<p class="no-data-message">ê°ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        }

        async function loadRecentEmotionLetter() {
            const cardContent = document.getElementById('recentLetterCard').querySelector('.dashboard-card-content');
            if (!currentUser) {
                console.log('[Dashboard] loadRecentEmotionLetter: No currentUser. Aborting.');
                return;
            }
            console.log('[Dashboard] loadRecentEmotionLetter: Attempting to load for user:', currentUser.uid);

            try {
                const snapshot = await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.ê°ì •í¸ì§€)
                                       .where('userId', '==', currentUser.uid)
                                       .orderBy('date', 'desc')
                                       .limit(1)
                                       .get();
                console.log('[Dashboard] Recent Emotion Letter Snapshot: Fetched', snapshot.size, 'docs.');
                if (!snapshot.empty) {
                    const letter = snapshot.docs[0].data();
                    console.log('[Dashboard] Recent Emotion Letter Data FOUND:', letter);
                    const letterDate = new Date(letter.date);
                    cardContent.innerHTML = `
                        <p><span class="data-highlight">${letterDate.toLocaleDateString('ko-KR')}</span>ì— ì‘ì„±í•œ í¸ì§€:</p>
                        <p style="font-size:0.9em; color:#555;"><em>"${letter.preview || letter.content.substring(0,70)}${letter.content.length > 70 ? '...' : ''}"</em></p>
                    `;
                } else {
                    console.log('[Dashboard] No recent emotion letter found for user.');
                    cardContent.innerHTML = `<p class="no-data-message">ìµœê·¼ ì‘ì„±í•œ í¸ì§€ê°€ ì—†ì–´ìš”.</p>`;
                }
            } catch (error) {
                console.error("ìµœê·¼ ê°ì • í¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", error);
                cardContent.innerHTML = `<p class="no-data-message">í¸ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        }

        async function loadRecentMoodRoutine() {
            const cardContent = document.getElementById('recentMoodRoutineCard').querySelector('.dashboard-card-content');
            if (!currentUser) {
                console.log('[Dashboard] loadRecentMoodRoutine: No currentUser. Aborting.');
                return;
            }
            console.log('[Dashboard] loadRecentMoodRoutine: Attempting to load for user:', currentUser.uid);

            try {
                const snapshot = await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.í•˜ë£¨ê¸°ë¶„ê¸°ë¡)
                                       .where('userId', '==', currentUser.uid)
                                       .orderBy('dateString', 'desc') // dateString (YYYY-MM-DD)ìœ¼ë¡œ ì •ë ¬
                                       .limit(1)
                                       .get();
                console.log('[Dashboard] Recent Mood Routine Snapshot: Fetched', snapshot.size, 'docs.');
                if (!snapshot.empty) {
                    const routine = snapshot.docs[0].data();
                    console.log('[Dashboard] Recent Mood Routine Data FOUND:', routine);
                    const moodEmoji = moodEmojisForDashboard[routine.mood] || routine.mood;
                    cardContent.innerHTML = `
                        <p><span class="data-highlight">${routine.dateString}</span> ê¸°ë¡:</p>
                        <p>ê¸°ë¶„: <span class="data-highlight">${moodEmoji} ${routine.mood}</span></p>
                        ${routine.gratitude ? `<p style="font-size:0.9em; color:#555;">ê°ì‚¬: <em>${routine.gratitude.substring(0,50)}${routine.gratitude.length > 50 ? '...' : ''}</em></p>` : ''}
                        ${routine.routine ? `<p style="font-size:0.9em; color:#555;">ë£¨í‹´: <em>${routine.routine.substring(0,50)}${routine.routine.length > 50 ? '...' : ''}</em></p>` : ''}
                    `;
                } else {
                    console.log('[Dashboard] No recent mood routine found for user.');
                    cardContent.innerHTML = `<p class="no-data-message">ìµœê·¼ í•˜ë£¨ ê¸°ë¡ì´ ì—†ì–´ìš”.</p>`;
                }
            } catch (error) {
                console.error("ìµœê·¼ í•˜ë£¨ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:", error);
                cardContent.innerHTML = `<p class="no-data-message">í•˜ë£¨ ê¸°ë¡ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        }


        function openProfileSettings() {
            if (!currentUser) {
                showMessage('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                showLoginModal();
                return;
            }
            const modal = document.getElementById('profileSettingsModal');
            if (!modal) {
                console.error("í”„ë¡œí•„ ë³€ê²½ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                showMessage('í”„ë¡œí•„ ë³€ê²½ ì°½ì„ ì—¬ëŠ” ë° í•„ìš”í•œ êµ¬ì„± ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const displayNameInput = document.getElementById('displayNameInput');
            const emailDisplay = document.getElementById('emailDisplay');
            if (!displayNameInput || !emailDisplay) {
                console.error("í”„ë¡œí•„ ë³€ê²½ ëª¨ë‹¬ ë‚´ë¶€ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                showMessage('í”„ë¡œí•„ ë³€ê²½ ì°½ì˜ ë‚´ë¶€ êµ¬ì„± ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            displayNameInput.value = currentUser.displayName || '';
            emailDisplay.value = currentUser.email || '';
            
            modal.style.display = 'block';

            const form = document.getElementById('profileSettingsForm');
            if (!form) {
                console.error("í”„ë¡œí•„ ì„¤ì • í¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            newForm.addEventListener('submit', handleProfileUpdate);
        }

        function closeProfileSettingsModal() {
            const modal = document.getElementById('profileSettingsModal');
            if (modal) modal.style.display = 'none';
        }

        async function handleProfileUpdate(event) {
            event.preventDefault();
            if (!currentUser) return;

            const newDisplayName = document.getElementById('displayNameInput').value.trim();
            if (!newDisplayName) {
                showMessage('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                await currentUser.updateProfile({
                    displayName: newDisplayName
                });
                
                showMessage('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                updateWelcomeMessage(); 
                updateAuthUI(currentUser); 
                closeProfileSettingsModal();
            } catch (error) {
                console.error("í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
                showMessage(`í”„ë¡œí•„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
            }
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('profileSettingsModal');
            if (event.target === modal) {
                closeProfileSettingsModal();
            }
        });
    </script>
</body>
</html>
