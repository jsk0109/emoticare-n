<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ì°° ì§ˆë¬¸ - EmotiCare</title>
    <link rel="stylesheet" href="styles.css?v=20240701a">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* .reflection-container íŒ¨ë”©ì€ .page-inner-container ë¡œ ëŒ€ì²´ */
        
        .intro-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            padding: 2rem; /* íŒ¨ë”© ì¶•ì†Œ */
            margin-bottom: 2rem; /* ë§ˆì§„ ì¶•ì†Œ */
            text-align: center;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
        }
        
        .intro-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .intro-text {
            font-size: 1.1rem;
            line-height: 1.6;
            opacity: 0.9;
        }
        
        .categories-grid {
            display: grid;
            gap: 1.5rem; /* ê°„ê²© ì¶•ì†Œ */
        }
        
        .category-section {
            /* .content-block ìœ¼ë¡œ ëŒ€ì²´ */
            /* padding: 1.5rem; */ /* content-block ê¸°ë³¸ íŒ¨ë”© ì‚¬ìš© */
            transition: all 0.3s ease;
        }
        
        .category-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.15);
        }
        
        .category-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
            cursor: pointer;
        }
        
        .category-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
        }
        
        .category-icon.self-understanding {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .category-icon.emotions {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        .category-icon.relationships {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }
        
        .category-icon.growth {
            background: linear-gradient(135deg, #f9ca24, #f0932b);
        }
        
        .category-icon.stress {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        }
        
        .category-icon.mindfulness {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
        }
        
        .category-info {
            flex: 1;
        }
        
        .category-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .category-description {
            color: #666;
            font-size: 1rem;
        }
        
        .category-toggle {
            color: #667eea;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        
        .category-toggle.expanded {
            transform: rotate(180deg);
        }
        
        .questions-list {
            display: none;
            padding-top: 1rem;
        }
        
        .questions-list.expanded {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .question-item {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 1rem; /* íŒ¨ë”© ì¶•ì†Œ */
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .question-item:hover {
            background: #e8f0ff;
            transform: translateX(5px);
        }
        
        .reflection-content-inline {
            display: none; 
            padding: 1rem;
            background-color: #e8f0ff; 
            border-radius: 10px;
            margin-top: 1rem;
        }
        .reflection-content-inline .modal-actions button,
        .reflection-content-inline .btn-outline,
        .reflection-content-inline .btn-danger,
        .reflection-content-inline .btn-primary {
            padding: 0.5rem 1rem !important; /* ë‹¤ë¥¸ ë²„íŠ¼ë“¤ê³¼ ìœ ì‚¬í•œ íŒ¨ë”©, !importantë¡œ ìš°ì„ ìˆœìœ„ ë†’ì„ */
            font-size: 0.9rem !important;   /* ë‹¤ë¥¸ ë²„íŠ¼ë“¤ê³¼ ìœ ì‚¬í•œ í°íŠ¸ í¬ê¸°, !importantë¡œ ìš°ì„ ìˆœìœ„ ë†’ì„ */
        }
        
        .question-text {
            font-size: 1.1rem;
            color: #333;
            line-height: 1.5;
            margin-bottom: 0.75rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .question-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .reflect-btn, .save-btn {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 0.4rem 0.8rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .reflect-btn:hover, .save-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .random-question {
            /* .content-block ìœ¼ë¡œ ëŒ€ì²´ */
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
            text-align: center;
        }
        
        .random-question-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .random-question-text {
            font-size: 1.2rem;
            color: #667eea;
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
            line-height: 1.6;
            font-weight: 500;
        }
        
        .new-question-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.8rem 1.8rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .new-question-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .reflection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .reflection-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .reflection-question {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 1rem; /* ë§ˆì§„ ì¶•ì†Œ */
            line-height: 1.6;
            font-weight: 500;
        }
        
        .reflection-textarea {
            width: 100%;
            min-height: 200px;
            padding: 0.8rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 1.5rem;
        }
        
        .reflection-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .my-reflections-section {
            /* .content-block ìœ¼ë¡œ ëŒ€ì²´ */
            margin-top: 2rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }

        .my-reflections-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
            color: #333;
            text-align: center;
        }

        .saved-reflection-item {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 1rem; /* íŒ¨ë”© ì¶•ì†Œ */
            margin-bottom: 1rem;
            border-left: 4px solid #764ba2;
        }

        .saved-reflection-question {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .saved-reflection-text {
            color: #555;
            line-height: 1.6;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }

        .saved-reflection-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .reflection-item-actions button {
            margin-left: 0.5rem;
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .intro-section { padding: 1.5rem; margin-bottom: 1.5rem; }
            .intro-title { font-size: 1.5rem; }
            .intro-text { font-size: 1rem; }
            .random-question-title { font-size: 1.2rem; margin-bottom: 1rem; }
            .random-question-text { font-size: 1.1rem; margin-bottom: 1rem; }
            .new-question-btn { padding: 0.7rem 1.5rem; }
            .category-icon { width: 50px; height: 50px; font-size: 1.5rem; }
            .category-title { font-size: 1.2rem; }
            .category-description { font-size: 0.9rem; }
            .question-item { padding: 0.8rem; }
            .question-text { font-size: 1rem; }
            .reflection-modal-content { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">ì„±ì°° ì§ˆë¬¸</h1>
                <p class="page-subtitle">ê¹Šì´ ìˆëŠ” ì§ˆë¬¸ë“¤ë¡œ ìì‹ ì„ ë” ì˜ ì´í•´í•˜ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="page-inner-container reflection-container">
                <div class="intro-section">
                    <h2 class="intro-title">ğŸ¤” ìê¸° ì„±ì°°ì˜ ì‹œê°„</h2>
                    <p class="intro-text">
                        ë³µì¡í•œ ì¼ìƒ ì†, ë‚˜ë¥¼ ìœ„í•œ íŠ¹ë³„í•œ ì‹œê°„ì„ ì„ ë¬¼í•˜ì„¸ìš”.<br>
                        ì„±ì°°ì€ ìˆ¨ê²¨ì§„ ê°€ëŠ¥ì„±ì„ ë°œê²¬í•˜ê³  ì‚¶ì˜ ì§€í˜œë¥¼ ì–»ëŠ” ì—¬ì •ì…ë‹ˆë‹¤.<br><br>
                        ê° ì§ˆë¬¸ì— ë‹´ê¸´ ì˜ë¯¸ë¥¼ ê³±ì”¹ìœ¼ë©°, ì§„ì •í•œ ë‹¹ì‹ ì„ ì°¾ì•„ê°€ì„¸ìš”.
                    </p>
                </div>
                
                <div class="content-block random-question">
                    <h3 class="random-question-title">ğŸ’¡ ì˜¤ëŠ˜ì˜ ì„±ì°° ì§ˆë¬¸</h3>
                    <div class="random-question-text" id="randomQuestionText">ë¡œë”© ì¤‘...</div>
                    <button class="new-question-btn" onclick="loadRandomQuestion()">
                        <i class="fas fa-sync-alt"></i> ìƒˆë¡œìš´ ì§ˆë¬¸
                    </button>
                </div>
                
                <div class="categories-grid">
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('self-understanding')">
                            <div class="category-icon self-understanding">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">ìê¸° ì´í•´</h3>
                                <p class="category-description">ë‚˜ëŠ” ëˆ„êµ¬ì¸ê°€? ë‚´ ê°€ì¹˜ê´€ê³¼ ì‹ ë…ì€ ë¬´ì—‡ì¸ê°€?</p>
                            </div>
                            <div class="category-toggle" id="toggle-self-understanding">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-self-understanding">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('emotions')">
                            <div class="category-icon emotions">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">ê°ì • ë‹¤ë£¨ê¸°</h3>
                                <p class="category-description">ë‚´ ê°ì •ì„ ì–´ë–»ê²Œ ì´í•´í•˜ê³  í‘œí˜„í•  ê²ƒì¸ê°€?</p>
                            </div>
                            <div class="category-toggle" id="toggle-emotions">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-emotions">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('relationships')">
                            <div class="category-icon relationships">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">ê´€ê³„</h3>
                                <p class="category-description">íƒ€ì¸ê³¼ì˜ ê´€ê³„ì—ì„œ ë‚˜ëŠ” ì–´ë–¤ ëª¨ìŠµì¸ê°€?</p>
                            </div>
                            <div class="category-toggle" id="toggle-relationships">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-relationships">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('growth')">
                            <div class="category-icon growth">
                                <i class="fas fa-seedling"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">ì„±ì¥</h3>
                                <p class="category-description">ì–´ë–»ê²Œ ë” ë‚˜ì€ ì‚¬ëŒì´ ë  ìˆ˜ ìˆì„ê¹Œ?</p>
                            </div>
                            <div class="category-toggle" id="toggle-growth">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-growth">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('stress')">
                            <div class="category-icon stress">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬</h3>
                                <p class="category-description">ìŠ¤íŠ¸ë ˆìŠ¤ì™€ ì–´ë ¤ì›€ì„ ì–´ë–»ê²Œ ê·¹ë³µí•  ê²ƒì¸ê°€?</p>
                            </div>
                            <div class="category-toggle" id="toggle-stress">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-stress">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('mindfulness')">
                            <div class="category-icon mindfulness">
                                <i class="fas fa-spa"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">ë§ˆìŒì±™ê¹€</h3>
                                <p class="category-description">í˜„ì¬ ìˆœê°„ì— ì§‘ì¤‘í•˜ê³  í‰ì•ˆì„ ì°¾ëŠ” ë°©ë²•ì€?</p>
                            </div>
                            <div class="category-toggle" id="toggle-mindfulness">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-mindfulness">
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <div class="reflection-modal" id="reflectionModal">
        <div class="reflection-modal-content">
            <div class="modal-header">
                <h3>ì„±ì°°í•˜ê¸°</h3>
                <button class="modal-close" onclick="closeReflectionModal()">&times;</button>
            </div>
            <div class="reflection-question" id="modalQuestion"></div>
            <textarea 
                class="reflection-textarea" 
                id="reflectionTextarea"
                placeholder="ì´ ì§ˆë¬¸ì— ëŒ€í•´ ììœ ë¡­ê²Œ ìƒê°ì„ ì ì–´ë³´ì„¸ìš”..."
            ></textarea>
            <div class="modal-actions">
                <button class="btn-outline" onclick="closeReflectionModal()">ë‹«ê¸°</button>
                <button class="btn-primary" onclick="saveReflection()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        const reflectionQuestions = {
            'self-understanding': [
                "ë‚˜ëŠ” ì–´ë–¤ ì‚¬ëŒì¸ê°€? ë‚˜ë¥¼ ê°€ì¥ ì˜ í‘œí˜„í•˜ëŠ” ì„¸ ê°€ì§€ ë‹¨ì–´ëŠ” ë¬´ì—‡ì¸ê°€?",
                "ë‚´ê°€ ê°€ì¥ ì†Œì¤‘í•˜ê²Œ ì—¬ê¸°ëŠ” ê°€ì¹˜ëŠ” ë¬´ì—‡ì¸ê°€?",
                "ë‚˜ì˜ ê°•ì ê³¼ ì•½ì ì€ ë¬´ì—‡ì¸ê°€? ì´ë¥¼ ì–´ë–»ê²Œ í™œìš©í•˜ê³  ê°œì„ í•  ìˆ˜ ìˆì„ê¹Œ?",
                "10ë…„ í›„ ë‚˜ëŠ” ì–´ë–¤ ëª¨ìŠµì´ê³  ì‹¶ì€ê°€?",
                "ë‚˜ë¥¼ ê°€ì¥ í–‰ë³µí•˜ê²Œ ë§Œë“œëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€?",
                "ë‚´ê°€ ê°€ì¥ ìë‘ìŠ¤ëŸ¬ì›Œí•˜ëŠ” ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜?",
                "ë‚˜ëŠ” ì–´ë–¤ ìƒí™©ì—ì„œ ê°€ì¥ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ëŠ”ê°€?",
                "ë‚´ ì¸ìƒì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ë¬´ì—‡ì¸ê°€?"
            ],
            'emotions': [
                "ì§€ê¸ˆ ë‚´ê°€ ëŠë¼ëŠ” ê°ì •ì€ ë¬´ì—‡ì¸ê°€? ì´ ê°ì •ì˜ ì›ì¸ì€ ë¬´ì—‡ì¼ê¹Œ?",
                "ë‚˜ëŠ” ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ê°ì •ì„ í‘œí˜„í•˜ëŠ”ê°€?",
                "ë¶€ì •ì ì¸ ê°ì •ì„ ëŠë‚„ ë•Œ ë‚˜ëŠ” ì–´ë–»ê²Œ ëŒ€ì²˜í•˜ëŠ”ê°€?",
                "ë‚´ê°€ ê°€ì¥ ìì£¼ ëŠë¼ëŠ” ê°ì •ì€ ë¬´ì—‡ì¸ê°€?",
                "ê°ì •ì„ ì–µëˆ„ë¥´ì§€ ì•Šê³  ê±´ê°•í•˜ê²Œ í‘œí˜„í•˜ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì¼ê¹Œ?",
                "ë‚˜ë¥¼ í™”ë‚˜ê²Œ ë§Œë“œëŠ” ê²ƒë“¤ì€ ë¬´ì—‡ì¸ê°€? ê·¸ ì´ìœ ëŠ”?",
                "ê¸°ì¨ì„ ëŠë‚„ ë•Œì™€ ìŠ¬í””ì„ ëŠë‚„ ë•Œì˜ ë‚˜ëŠ” ì–´ë–»ê²Œ ë‹¤ë¥¸ê°€?",
                "ê°ì •ì ìœ¼ë¡œ í˜ë“¤ ë•Œ ë‚˜ë¥¼ ìœ„ë¡œí•´ì£¼ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€?"
            ],
            'relationships': [
                "ë‚˜ëŠ” ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ì–´ë–»ê²Œ ê´€ê³„ë¥¼ ë§ºëŠ”ê°€?",
                "ë‚´ê°€ ì†Œì¤‘í•˜ê²Œ ì—¬ê¸°ëŠ” ì‚¬ëŒë“¤ì€ ëˆ„êµ¬ì¸ê°€? ê·¸ ì´ìœ ëŠ”?",
                "ê°ˆë“± ìƒí™©ì—ì„œ ë‚˜ëŠ” ì–´ë–»ê²Œ í–‰ë™í•˜ëŠ”ê°€?",
                "ë‚˜ëŠ” ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ì–´ë–¤ ì˜í–¥ì„ ì£¼ê³  ìˆì„ê¹Œ?",
                "ê±´ê°•í•œ ê´€ê³„ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ë‚´ê°€ í•  ìˆ˜ ìˆëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€?",
                "ë‚˜ëŠ” ì–¸ì œ ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ê°€ì¥ í¸ì•ˆí•¨ì„ ëŠë¼ëŠ”ê°€?",
                "ë‚´ê°€ ë°›ê³  ì‹¶ì€ ì‚¬ë‘ì˜ ë°©ì‹ì€ ë¬´ì—‡ì¸ê°€?",
                "ë‹¤ë¥¸ ì‚¬ëŒì„ ì´í•´í•˜ê¸° ìœ„í•´ ë‚´ê°€ ë…¸ë ¥í•˜ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€?"
            ],
            'growth': [
                "ì§€ë‚œ 1ë…„ ë™ì•ˆ ë‚´ê°€ ê°€ì¥ ì„±ì¥í•œ ë¶€ë¶„ì€ ë¬´ì—‡ì¸ê°€?",
                "ë‚´ê°€ ê·¹ë³µí•˜ê³  ì‹¶ì€ ìŠµê´€ì´ë‚˜ íŒ¨í„´ì€ ë¬´ì—‡ì¸ê°€?",
                "ìƒˆë¡œìš´ ê²ƒì„ ë°°ìš¸ ë•Œ ë‚˜ëŠ” ì–´ë–¤ ë°©ì‹ì„ ì„ í˜¸í•˜ëŠ”ê°€?",
                "ì‹¤íŒ¨ì—ì„œ ë°°ìš´ ê°€ì¥ ì†Œì¤‘í•œ êµí›ˆì€ ë¬´ì—‡ì¸ê°€?",
                "ë‚´ê°€ ë„ì „í•˜ê³  ì‹¶ì€ ìƒˆë¡œìš´ ê²ƒì€ ë¬´ì—‡ì¸ê°€?",
                "ì„±ì¥ì„ ìœ„í•´ ë‚´ê°€ í¬ê¸°í•´ì•¼ í•  ê²ƒì€ ë¬´ì—‡ì¸ê°€?",
                "ë‚˜ì˜ ë©˜í† ë‚˜ ë¡¤ëª¨ë¸ì€ ëˆ„êµ¬ì¸ê°€? ê·¸ë“¤ì—ê²Œì„œ ë¬´ì—‡ì„ ë°°ìš°ê³  ì‹¶ì€ê°€?",
                "í¸ì•ˆí•œ ì˜ì—­ì„ ë²—ì–´ë‚˜ê¸° ìœ„í•´ ë‚´ê°€ í•  ìˆ˜ ìˆëŠ” ì‘ì€ í–‰ë™ì€ ë¬´ì—‡ì¸ê°€?"
            ],
            'stress': [
                "ë‚˜ëŠ” ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì–´ë–»ê²Œ ì¸ì‹í•˜ê³  ìˆëŠ”ê°€?",
                "ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì„ ë•Œ ë‚˜íƒ€ë‚˜ëŠ” ì‹ ì²´ì , ì •ì‹ ì  ì‹ í˜¸ëŠ” ë¬´ì—‡ì¸ê°€?",
                "ë‚˜ë§Œì˜ ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œ ë°©ë²•ì€ ë¬´ì—‡ì¸ê°€?",
                "ìŠ¤íŠ¸ë ˆìŠ¤ì˜ ê·¼ë³¸ ì›ì¸ì„ ì œê±°í•˜ê¸° ìœ„í•´ ë¬´ì—‡ì„ í•  ìˆ˜ ìˆì„ê¹Œ?",
                "ì••ë°•ê°ì„ ëŠë‚„ ë•Œ ë‚˜ëŠ” ì–´ë–»ê²Œ ìš°ì„ ìˆœìœ„ë¥¼ ì •í•˜ëŠ”ê°€?",
                "íœ´ì‹ê³¼ ì¬ì¶©ì „ì„ ìœ„í•´ ë‚˜ëŠ” ë¬´ì—‡ì„ í•˜ëŠ”ê°€?",
                "ìŠ¤íŠ¸ë ˆìŠ¤ ìƒí™©ì—ì„œë„ ê¸ì •ì ì¸ ë©´ì„ ì°¾ì„ ìˆ˜ ìˆëŠ”ê°€?",
                "ë„ì›€ì´ í•„ìš”í•  ë•Œ ë‚˜ëŠ” ëˆ„êµ¬ì—ê²Œ ì˜ì§€í•˜ëŠ”ê°€?"
            ],
            'mindfulness': [
                "ì§€ê¸ˆ ì´ ìˆœê°„ ë‚˜ëŠ” ë¬´ì—‡ì„ ëŠë¼ê³  ìˆëŠ”ê°€?",
                "í˜„ì¬ì— ì§‘ì¤‘í•˜ê¸° ìœ„í•´ ë‚´ê°€ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì¸ê°€?",
                "ë§ˆìŒì´ í‰ì•ˆí•  ë•ŒëŠ” ì–¸ì œì¸ê°€?",
                "ì¼ìƒì—ì„œ ê°ì‚¬í•  ìˆ˜ ìˆëŠ” ì‘ì€ ê²ƒë“¤ì€ ë¬´ì—‡ì¸ê°€?",
                "ë‚˜ëŠ” ì–¼ë§ˆë‚˜ ìì£¼ ê³¼ê±°ë‚˜ ë¯¸ë˜ì— ëŒ€í•´ ê±±ì •í•˜ëŠ”ê°€?",
                "ëª…ìƒì´ë‚˜ ë§ˆìŒì±™ê¹€ ì—°ìŠµì´ ë‚˜ì—ê²Œ ì–´ë–¤ ë„ì›€ì´ ë˜ëŠ”ê°€?",
                "ìì—°ê³¼ í•¨ê»˜ ìˆì„ ë•Œ ë‚˜ëŠ” ì–´ë–¤ ê¸°ë¶„ì´ ë“œëŠ”ê°€?",
                "ë‚´ë©´ì˜ í‰í™”ë¥¼ ì°¾ê¸° ìœ„í•´ ë¬´ì—‡ì´ í•„ìš”í•œê°€?"
            ]
        };
        
        let allQuestions = [];
        let currentReflectionQuestion = '';
        let currentEditingReflectionId = null; 
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeQuestions();
            loadRandomQuestion();

            document.addEventListener('authStateReady', async function(e) {
                if (e.detail.user) { 
                    await loadSavedReflections();
                } else { 
                    document.getElementById('savedReflectionsList').innerHTML = 
                        '<p class="text-center" style="color:#666;">ë¡œê·¸ì¸ í›„ ì„±ì°° ê¸°ë¡ì„ í™•ì¸í•˜ê³  ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
                }
            });
        });
        
        function initializeQuestions() {
            Object.values(reflectionQuestions).forEach(categoryQuestions => {
                allQuestions = allQuestions.concat(categoryQuestions);
            });
            
            Object.entries(reflectionQuestions).forEach(([category, questions]) => {
                renderCategoryQuestions(category, questions);
            });
        }
        
        function renderCategoryQuestions(category, questions) {
            const container = document.getElementById(`questions-${category}`);
            container.innerHTML = questions.map((question, index) => {
                const questionId = `q-${category}-${index}`; 
                return `
                <div class="question-item" id="${questionId}-item">
                    <div class="question-text">${question}</div>
                    <div class="question-actions">
                        <button class="reflect-btn" id="btn-${questionId}" onclick="toggleInlineReflection('${questionId}', '${question}')">
                            <i class="fas fa-pen"></i> ì„±ì°°í•˜ê¸°
                        </button>
                    </div>
                    <div class="reflection-content-inline" id="content-${questionId}"></div>
                </div>
            `}).join('');
        }
        
        function toggleCategory(category) {
            const questionsList = document.getElementById(`questions-${category}`);
            const toggle = document.getElementById(`toggle-${category}`);
            
            if (questionsList.classList.contains('expanded')) {
                questionsList.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                document.querySelectorAll('.questions-list').forEach(list => {
                    list.classList.remove('expanded');
                });
                document.querySelectorAll('.category-toggle').forEach(t => {
                    t.classList.remove('expanded');
                });
                
                questionsList.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }
        
        function loadRandomQuestion() {
            const randomQuestion = getRandomItem(allQuestions);
            document.getElementById('randomQuestionText').textContent = randomQuestion;
        }
        
        function toggleInlineReflection(questionElementId, questionText) {
            const contentDiv = document.getElementById(`content-${questionElementId}`);
            const button = document.getElementById(`btn-${questionElementId}`);

            if (contentDiv.style.display === 'block' && button.dataset.mode === 'view') {
                contentDiv.style.display = 'none';
                return;
            }
            
            if (button.dataset.mode === 'view') {
                 contentDiv.style.display = 'block'; 
            } else {
                currentReflectionQuestion = questionText; 
                contentDiv.innerHTML = `
                    <textarea class="reflection-textarea" id="textarea-${questionElementId}" placeholder="ì´ ì§ˆë¬¸ì— ëŒ€í•´ ììœ ë¡­ê²Œ ìƒê°ì„ ì ì–´ë³´ì„¸ìš”..."></textarea>
                    <div class="modal-actions" style="margin-top:1rem;">
                        <button class="btn-outline" onclick="cancelInlineReflection('${questionElementId}')">ì·¨ì†Œ</button>
                        <button class="btn-primary" onclick="saveInlineReflection('${questionElementId}', '${questionText}')">ì €ì¥í•˜ê¸°</button>
                    </div>
                `;
                contentDiv.style.display = 'block';
                document.getElementById(`textarea-${questionElementId}`).focus();
            }
        }

        function cancelInlineReflection(questionElementId) {
            const contentDiv = document.getElementById(`content-${questionElementId}`);
            const button = document.getElementById(`btn-${questionElementId}`);
            contentDiv.style.display = 'none';
            contentDiv.innerHTML = ''; 
            if (button.dataset.mode !== 'view') {
                 button.innerHTML = '<i class="fas fa-pen"></i> ì„±ì°°í•˜ê¸°';
            }
        }

        async function saveInlineReflection(questionElementId, questionText) {
            const textarea = document.getElementById(`textarea-${questionElementId}`);
            const reflectionText = textarea.value.trim();

            if (!reflectionText) {
                showMessage('ì„±ì°° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!currentUser) {
                showMessage('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                showLoginModal();
                return;
            }

            const reflectionDocId = `${currentUser.uid}_${Date.now()}`; 
            const reflectionData = {
                id: reflectionDocId,
                question: questionText,
                reflection: reflectionText,
                date: new Date().toISOString(),
                userId: currentUser.uid,
                questionElementId: questionElementId 
            };

            const success = await saveToFirestore('reflections', reflectionDocId, reflectionData);

            if (success) {
                const contentDiv = document.getElementById(`content-${questionElementId}`);
                contentDiv.innerHTML = `<div class="saved-reflection-text">${reflectionText}</div>
                                        <button class="btn-outline" style="margin-top:1rem;" onclick="editInlineReflection('${questionElementId}', '${questionText}', '${reflectionDocId}', \`${reflectionText}\`)"><i class="fas fa-edit"></i> ìˆ˜ì •</button>
                                        <button class="btn-danger" style="margin-top:1rem; margin-left:0.5rem;" onclick="deleteInlineReflection('${questionElementId}', '${reflectionDocId}')"><i class="fas fa-trash"></i> ì‚­ì œ</button>`;
                
                const button = document.getElementById(`btn-${questionElementId}`);
                button.innerHTML = '<i class="fas fa-eye"></i> ì„±ì°° ë³´ê¸°';
                button.dataset.mode = 'view'; 
                button.classList.add('btn-outline'); // btn-secondary ëŒ€ì‹  btn-outline ì‚¬ìš©

                showMessage('ì„±ì°°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                await loadSavedReflections(); 
            } else {
                showMessage('ì„±ì°° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        function openReflectionModal(question) {
            currentReflectionQuestion = question;
            document.getElementById('modalQuestion').textContent = question;
            document.getElementById('reflectionTextarea').value = '';
            document.getElementById('reflectionModal').style.display = 'block';
        }
        
        function closeReflectionModal() {
            document.getElementById('reflectionModal').style.display = 'none';
            currentReflectionQuestion = '';
        }
        
        async function saveReflection() { 
            if (!currentUser) {
                showMessage('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                showLoginModal();
                return;
            }

            const reflection = document.getElementById('reflectionTextarea').value.trim();
            
            if (!reflection) {
                showMessage('ì„±ì°° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const reflectionDocId = Date.now().toString(); 
            const reflectionData = {
                id: reflectionDocId, 
                question: currentReflectionQuestion,
                reflection: reflection,
                date: new Date().toISOString(),
                userId: currentUser.uid
            };
            
            const success = await saveToFirestore('reflections', reflectionDocId, reflectionData);
            if (success) {
                closeReflectionModal();
                showMessage('ì„±ì°°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                await loadSavedReflections(); 
            } else {
                showMessage('ì„±ì°° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function editInlineReflection(questionElementId, questionText, reflectionDocId, currentReflectionText) {
            const contentDiv = document.getElementById(`content-${questionElementId}`);
            contentDiv.innerHTML = `
                <textarea class="reflection-textarea" id="textarea-edit-${questionElementId}">${currentReflectionText}</textarea>
                <div class="modal-actions" style="margin-top:1rem;">
                    <button class="btn-outline" onclick="cancelEditInlineReflection('${questionElementId}', '${reflectionDocId}', \`${currentReflectionText}\`, '${questionText}')">ì·¨ì†Œ</button>
                    <button class="btn-danger" onclick="deleteInlineReflection('${questionElementId}', '${reflectionDocId}')"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    <button class="btn-primary" onclick="saveEditedInlineReflection('${questionElementId}', '${reflectionDocId}')">ìˆ˜ì • ì €ì¥</button>
                </div>
            `;
            document.getElementById(`textarea-edit-${questionElementId}`).focus();
        }

        function cancelEditInlineReflection(questionElementId, reflectionDocId, originalText, questionText) {
            // questionText ì¸ì ì¶”ê°€ (editInlineReflection í˜¸ì¶œ ì‹œ í•„ìš”)
            const contentDiv = document.getElementById(`content-${questionElementId}`);
            contentDiv.innerHTML = `<div class="saved-reflection-text">${originalText}</div>
                                    <button class="btn-outline" style="margin-top:1rem;" onclick="editInlineReflection('${questionElementId}', '${questionText || document.getElementById(questionElementId + '-item').querySelector('.question-text').textContent}', '${reflectionDocId}', \`${originalText}\`)"><i class="fas fa-edit"></i> ìˆ˜ì •</button>
                                    <button class="btn-danger" style="margin-top:1rem; margin-left:0.5rem;" onclick="deleteInlineReflection('${questionElementId}', '${reflectionDocId}')"><i class="fas fa-trash"></i> ì‚­ì œ</button>`;
        }

        async function saveEditedInlineReflection(questionElementId, reflectionDocId) {
            const newReflectionText = document.getElementById(`textarea-edit-${questionElementId}`).value.trim();
            if (!newReflectionText) {
                showMessage('ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                await db.collection('reflections').doc(reflectionDocId).update({
                    reflection: newReflectionText,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showMessage('ì„±ì°° ë‚´ìš©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // ìˆ˜ì • í›„ ë³´ê¸° ëª¨ë“œë¡œ ì „í™˜ ì‹œ questionTextë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
                const questionText = document.getElementById(`${questionElementId}-item`).querySelector('.question-text').textContent;
                cancelEditInlineReflection(questionElementId, reflectionDocId, newReflectionText, questionText); 
                await loadSavedReflections(); 
            } catch (error) {
                 console.error("Error updating inline reflection: ", error);
                 showMessage('ì„±ì°° ë‚´ìš© ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function deleteInlineReflection(questionElementId, reflectionDocId) {
            if (!currentUser) return;

            if (confirm('ì´ ì„±ì°° ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)')) {
                try {
                    await db.collection('reflections').doc(reflectionDocId).delete();
                    
                    const contentDiv = document.getElementById(`content-${questionElementId}`);
                    contentDiv.style.display = 'none';
                    contentDiv.innerHTML = '';
                    
                    const button = document.getElementById(`btn-${questionElementId}`);
                    button.innerHTML = '<i class="fas fa-pen"></i> ì„±ì°°í•˜ê¸°';
                    button.dataset.mode = ''; // 'view' ëª¨ë“œ í•´ì œ                    
                    button.classList.add('reflect-btn');

                    showMessage('ì„±ì°° ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    await loadSavedReflections(); // í•˜ë‹¨ ëª©ë¡ë„ ì—…ë°ì´íŠ¸
                } catch (error) {
                    console.error("Error deleting inline reflection: ", error);
                    showMessage('ì„±ì°° ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        async function loadSavedReflections() {
            if (!currentUser) {
                document.getElementById('savedReflectionsList').innerHTML = 
                    '<p class="text-center" style="color:#666;">ë¡œê·¸ì¸ í›„ ì„±ì°° ê¸°ë¡ì„ í™•ì¸í•˜ê³  ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
                return;
            } else {
                 // ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ (ì„ íƒì , í˜„ì¬ëŠ” ì¸ë¼ì¸ í‘œì‹œì—ë§Œ ì‚¬ìš©)
                 // renderSavedReflections(loadFromLocalStorage('savedReflections') || []);
            }

            try {
                const snapshot = await db.collection('reflections')
                                        .where('userId', '==', currentUser.uid)
                                        // .orderBy('date', 'desc') // ì¸ë¼ì¸ í‘œì‹œëŠ” ìˆœì„œê°€ ì¤‘ìš”í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
                                        // .limit(20) // ëª¨ë“  ì§ˆë¬¸ì— ëŒ€í•œ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™€ì•¼ í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ limit ì œê±° ê³ ë ¤
                                        // ë˜ëŠ” í˜ì´ì§€ ë¡œë“œ ì‹œ ë„ˆë¬´ ë§ì€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ì•Šë„ë¡ í˜ì´ì§€ë„¤ì´ì…˜ì´ë‚˜ ë‹¤ë¥¸ ì „ëµ ê³ ë ¤
                                        .get();
                
                const reflections = [];
                snapshot.forEach(doc => {
                    reflections.push({ id: doc.id, ...doc.data() });
                });
                renderSavedReflections(reflections);
            } catch (error) {
                console.error("Error loading reflections: ", error);
                showMessage('ì„±ì°° ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                document.getElementById('savedReflectionsList').innerHTML = 
                    '<p class="text-center" style="color:red;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        function renderSavedReflections(reflections) {
            const listElement = document.getElementById('savedReflectionsList');
            // í˜ì´ì§€ í•˜ë‹¨ ëª©ë¡ ìƒì„± ë¡œì§ ì œê±°
            // if (!reflections || reflections.length === 0) {
            //     if(listElement) listElement.innerHTML = '<p class="text-center" style="color:#666;">ì•„ì§ ì €ì¥ëœ ì„±ì°° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            //     return;
            // }
            // if(listElement) listElement.innerHTML = ''; // Clear previous list if any

            reflections.forEach(item => {
                if (item.questionElementId) { 
                    const button = document.getElementById(`btn-${item.questionElementId}`);
                    const contentDiv = document.getElementById(`content-${item.questionElementId}`);
                    if (button && contentDiv) {
                        button.innerHTML = '<i class="fas fa-eye"></i> ì„±ì°° ë³´ê¸°';
                        button.dataset.mode = 'view';
                        button.classList.add('btn-outline'); // btn-secondary ëŒ€ì‹  btn-outline ì‚¬ìš©
                        contentDiv.innerHTML = `<div class="saved-reflection-text">${item.reflection}</div>
                                                <button class="btn-outline" style="margin-top:0.5rem;" onclick="editInlineReflection('${item.questionElementId}', '${item.question}', '${item.id}', \`${item.reflection}\`)"><i class="fas fa-edit"></i> ìˆ˜ì •</button>
                                                <button class="btn-danger" style="margin-top:0.5rem; margin-left:0.5rem;" onclick="deleteInlineReflection('${item.questionElementId}', '${item.id}')"><i class="fas fa-trash"></i> ì‚­ì œ</button>`;
                    }
                }
            });
        }

        window.addEventListener('click', function(event) {
            const reflectionModal = document.getElementById('reflectionModal');
            // editReflectionModal ê´€ë ¨ ë¡œì§ ì œê±°
            // const editReflectionModal = document.getElementById('editReflectionModal');
            if (event.target === reflectionModal) {
                closeReflectionModal();
            }
            // if (event.target === editReflectionModal) {
            //     closeEditReflectionModal();
            // }
        });
    </script>
</body>
</html>
