<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>성찰 질문 - EmotiCare</title>
    <link rel="stylesheet" href="styles.css?v=20240701a">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* .reflection-container 패딩은 .page-inner-container 로 대체 */
        
        .intro-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            padding: 2rem; /* 패딩 축소 */
            margin-bottom: 2rem; /* 마진 축소 */
            text-align: center;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
        }
        
        .intro-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .intro-text {
            font-size: 1.1rem;
            line-height: 1.6;
            opacity: 0.9;
        }
        
        .categories-grid {
            display: grid;
            gap: 1.5rem; /* 간격 축소 */
        }
        
        .category-section {
            /* .content-block 으로 대체 */
            /* padding: 1.5rem; */ /* content-block 기본 패딩 사용 */
            transition: all 0.3s ease;
        }
        
        .category-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.15);
        }
        
        .category-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem; /* 마진 축소 */
            cursor: pointer;
        }
        
        .category-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
        }
        
        .category-icon.self-understanding {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .category-icon.emotions {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        .category-icon.relationships {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }
        
        .category-icon.growth {
            background: linear-gradient(135deg, #f9ca24, #f0932b);
        }
        
        .category-icon.stress {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        }
        
        .category-icon.mindfulness {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
        }
        
        .category-info {
            flex: 1;
        }
        
        .category-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .category-description {
            color: #666;
            font-size: 1rem;
        }
        
        .category-toggle {
            color: #667eea;
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        
        .category-toggle.expanded {
            transform: rotate(180deg);
        }
        
        .questions-list {
            display: none;
            padding-top: 1rem;
        }
        
        .questions-list.expanded {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .question-item {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 1rem; /* 패딩 축소 */
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .question-item:hover {
            background: #e8f0ff;
            transform: translateX(5px);
        }
        
        .reflection-content-inline {
            display: none; 
            padding: 1rem;
            background-color: #e8f0ff; 
            border-radius: 10px;
            margin-top: 1rem;
        }
        .reflection-content-inline .modal-actions button,
        .reflection-content-inline .btn-outline,
        .reflection-content-inline .btn-danger,
        .reflection-content-inline .btn-primary {
            padding: 0.5rem 1rem !important; /* 다른 버튼들과 유사한 패딩, !important로 우선순위 높임 */
            font-size: 0.9rem !important;   /* 다른 버튼들과 유사한 폰트 크기, !important로 우선순위 높임 */
        }
        
        .question-text {
            font-size: 1.1rem;
            color: #333;
            line-height: 1.5;
            margin-bottom: 0.75rem; /* 마진 축소 */
        }
        
        .question-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .reflect-btn, .save-btn {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 0.4rem 0.8rem; /* 패딩 축소 */
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .reflect-btn:hover, .save-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .random-question {
            /* .content-block 으로 대체 */
            margin-bottom: 1.5rem; /* 마진 축소 */
            text-align: center;
        }
        
        .random-question-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .random-question-text {
            font-size: 1.2rem;
            color: #667eea;
            margin-bottom: 1.5rem; /* 마진 축소 */
            line-height: 1.6;
            font-weight: 500;
        }
        
        .new-question-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.8rem 1.8rem; /* 패딩 축소 */
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .new-question-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .reflection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .reflection-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem; /* 패딩 축소 */
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .reflection-question {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 1rem; /* 마진 축소 */
            line-height: 1.6;
            font-weight: 500;
        }
        
        .reflection-textarea {
            width: 100%;
            min-height: 200px;
            padding: 0.8rem; /* 패딩 축소 */
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 1.5rem;
        }
        
        .reflection-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .my-reflections-section {
            /* .content-block 으로 대체 */
            margin-top: 2rem; /* 마진 축소 */
        }

        .my-reflections-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem; /* 마진 축소 */
            color: #333;
            text-align: center;
        }

        .saved-reflection-item {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 1rem; /* 패딩 축소 */
            margin-bottom: 1rem;
            border-left: 4px solid #764ba2;
        }

        .saved-reflection-question {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .saved-reflection-text {
            color: #555;
            line-height: 1.6;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }

        .saved-reflection-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .reflection-item-actions button {
            margin-left: 0.5rem;
            padding: 0.3rem 0.8rem;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .intro-section { padding: 1.5rem; margin-bottom: 1.5rem; }
            .intro-title { font-size: 1.5rem; }
            .intro-text { font-size: 1rem; }
            .random-question-title { font-size: 1.2rem; margin-bottom: 1rem; }
            .random-question-text { font-size: 1.1rem; margin-bottom: 1rem; }
            .new-question-btn { padding: 0.7rem 1.5rem; }
            .category-icon { width: 50px; height: 50px; font-size: 1.5rem; }
            .category-title { font-size: 1.2rem; }
            .category-description { font-size: 0.9rem; }
            .question-item { padding: 0.8rem; }
            .question-text { font-size: 1rem; }
            .reflection-modal-content { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">성찰 질문</h1>
                <p class="page-subtitle">깊이 있는 질문들로 자신을 더 잘 이해하는 시간을 가져보세요</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="page-inner-container reflection-container">
                <div class="intro-section">
                    <h2 class="intro-title">🤔 자기 성찰의 시간</h2>
                    <p class="intro-text">
                        복잡한 일상 속, 나를 위한 특별한 시간을 선물하세요.<br>
                        성찰은 숨겨진 가능성을 발견하고 삶의 지혜를 얻는 여정입니다.<br><br>
                        각 질문에 담긴 의미를 곱씹으며, 진정한 당신을 찾아가세요.
                    </p>
                </div>
                
                <div class="content-block random-question">
                    <h3 class="random-question-title">💡 오늘의 성찰 질문</h3>
                    <div class="random-question-text" id="randomQuestionText">로딩 중...</div>
                    <button class="new-question-btn" onclick="loadRandomQuestion()">
                        <i class="fas fa-sync-alt"></i> 새로운 질문
                    </button>
                </div>
                
                <div class="categories-grid">
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('self-understanding')">
                            <div class="category-icon self-understanding">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">자기 이해</h3>
                                <p class="category-description">나는 누구인가? 내 가치관과 신념은 무엇인가?</p>
                            </div>
                            <div class="category-toggle" id="toggle-self-understanding">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-self-understanding">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('emotions')">
                            <div class="category-icon emotions">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">감정 다루기</h3>
                                <p class="category-description">내 감정을 어떻게 이해하고 표현할 것인가?</p>
                            </div>
                            <div class="category-toggle" id="toggle-emotions">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-emotions">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('relationships')">
                            <div class="category-icon relationships">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">관계</h3>
                                <p class="category-description">타인과의 관계에서 나는 어떤 모습인가?</p>
                            </div>
                            <div class="category-toggle" id="toggle-relationships">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-relationships">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('growth')">
                            <div class="category-icon growth">
                                <i class="fas fa-seedling"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">성장</h3>
                                <p class="category-description">어떻게 더 나은 사람이 될 수 있을까?</p>
                            </div>
                            <div class="category-toggle" id="toggle-growth">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-growth">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('stress')">
                            <div class="category-icon stress">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">스트레스 관리</h3>
                                <p class="category-description">스트레스와 어려움을 어떻게 극복할 것인가?</p>
                            </div>
                            <div class="category-toggle" id="toggle-stress">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-stress">
                        </div>
                    </div>
                    
                    <div class="content-block category-section">
                        <div class="category-header" onclick="toggleCategory('mindfulness')">
                            <div class="category-icon mindfulness">
                                <i class="fas fa-spa"></i>
                            </div>
                            <div class="category-info">
                                <h3 class="category-title">마음챙김</h3>
                                <p class="category-description">현재 순간에 집중하고 평안을 찾는 방법은?</p>
                            </div>
                            <div class="category-toggle" id="toggle-mindfulness">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="questions-list" id="questions-mindfulness">
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <div class="reflection-modal" id="reflectionModal">
        <div class="reflection-modal-content">
            <div class="modal-header">
                <h3>성찰하기</h3>
                <button class="modal-close" onclick="closeReflectionModal()">&times;</button>
            </div>
            <div class="reflection-question" id="modalQuestion"></div>
            <textarea 
                class="reflection-textarea" 
                id="reflectionTextarea"
                placeholder="이 질문에 대해 자유롭게 생각을 적어보세요..."
            ></textarea>
            <div class="modal-actions">
                <button class="btn-outline" onclick="closeReflectionModal()">닫기</button>
                <button class="btn-primary" onclick="saveReflection()">저장하기</button>
            </div>
        </div>
    </div>

    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        const reflectionQuestions = {
            'self-understanding': [
                "나는 어떤 사람인가? 나를 가장 잘 표현하는 세 가지 단어는 무엇인가?",
                "내가 가장 소중하게 여기는 가치는 무엇인가?",
                "나의 강점과 약점은 무엇인가? 이를 어떻게 활용하고 개선할 수 있을까?",
                "10년 후 나는 어떤 모습이고 싶은가?",
                "나를 가장 행복하게 만드는 것은 무엇인가?",
                "내가 가장 자랑스러워하는 순간은 언제였나?",
                "나는 어떤 상황에서 가장 스트레스를 받는가?",
                "내 인생에서 가장 중요한 것은 무엇인가?"
            ],
            'emotions': [
                "지금 내가 느끼는 감정은 무엇인가? 이 감정의 원인은 무엇일까?",
                "나는 어떤 방식으로 감정을 표현하는가?",
                "부정적인 감정을 느낄 때 나는 어떻게 대처하는가?",
                "내가 가장 자주 느끼는 감정은 무엇인가?",
                "감정을 억누르지 않고 건강하게 표현하는 방법은 무엇일까?",
                "나를 화나게 만드는 것들은 무엇인가? 그 이유는?",
                "기쁨을 느낄 때와 슬픔을 느낄 때의 나는 어떻게 다른가?",
                "감정적으로 힘들 때 나를 위로해주는 것은 무엇인가?"
            ],
            'relationships': [
                "나는 다른 사람들과 어떻게 관계를 맺는가?",
                "내가 소중하게 여기는 사람들은 누구인가? 그 이유는?",
                "갈등 상황에서 나는 어떻게 행동하는가?",
                "나는 다른 사람들에게 어떤 영향을 주고 있을까?",
                "건강한 관계를 유지하기 위해 내가 할 수 있는 것은 무엇인가?",
                "나는 언제 다른 사람들과 가장 편안함을 느끼는가?",
                "내가 받고 싶은 사랑의 방식은 무엇인가?",
                "다른 사람을 이해하기 위해 내가 노력하는 것은 무엇인가?"
            ],
            'growth': [
                "지난 1년 동안 내가 가장 성장한 부분은 무엇인가?",
                "내가 극복하고 싶은 습관이나 패턴은 무엇인가?",
                "새로운 것을 배울 때 나는 어떤 방식을 선호하는가?",
                "실패에서 배운 가장 소중한 교훈은 무엇인가?",
                "내가 도전하고 싶은 새로운 것은 무엇인가?",
                "성장을 위해 내가 포기해야 할 것은 무엇인가?",
                "나의 멘토나 롤모델은 누구인가? 그들에게서 무엇을 배우고 싶은가?",
                "편안한 영역을 벗어나기 위해 내가 할 수 있는 작은 행동은 무엇인가?"
            ],
            'stress': [
                "나는 스트레스를 어떻게 인식하고 있는가?",
                "스트레스를 받을 때 나타나는 신체적, 정신적 신호는 무엇인가?",
                "나만의 스트레스 해소 방법은 무엇인가?",
                "스트레스의 근본 원인을 제거하기 위해 무엇을 할 수 있을까?",
                "압박감을 느낄 때 나는 어떻게 우선순위를 정하는가?",
                "휴식과 재충전을 위해 나는 무엇을 하는가?",
                "스트레스 상황에서도 긍정적인 면을 찾을 수 있는가?",
                "도움이 필요할 때 나는 누구에게 의지하는가?"
            ],
            'mindfulness': [
                "지금 이 순간 나는 무엇을 느끼고 있는가?",
                "현재에 집중하기 위해 내가 사용하는 방법은 무엇인가?",
                "마음이 평안할 때는 언제인가?",
                "일상에서 감사할 수 있는 작은 것들은 무엇인가?",
                "나는 얼마나 자주 과거나 미래에 대해 걱정하는가?",
                "명상이나 마음챙김 연습이 나에게 어떤 도움이 되는가?",
                "자연과 함께 있을 때 나는 어떤 기분이 드는가?",
                "내면의 평화를 찾기 위해 무엇이 필요한가?"
            ]
        };
        
        let allQuestions = [];
        let currentReflectionQuestion = '';
        let currentEditingReflectionId = null; 
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeQuestions();
            loadRandomQuestion();

            document.addEventListener('authStateReady', async function(e) {
                if (e.detail.user) { 
                    await loadSavedReflections();
                } else { 
                    document.getElementById('savedReflectionsList').innerHTML = 
                        '<p class="text-center" style="color:#666;">로그인 후 성찰 기록을 확인하고 저장할 수 있습니다.</p>';
                }
            });
        });
        
        function initializeQuestions() {
            Object.values(reflectionQuestions).forEach(categoryQuestions => {
                allQuestions = allQuestions.concat(categoryQuestions);
            });
            
            Object.entries(reflectionQuestions).forEach(([category, questions]) => {
                renderCategoryQuestions(category, questions);
            });
        }
        
        function renderCategoryQuestions(category, questions) {
            const container = document.getElementById(`questions-${category}`);
            container.innerHTML = questions.map((question, index) => {
                const questionId = `q-${category}-${index}`; 
                return `
                <div class="question-item" id="${questionId}-item">
                    <div class="question-text">${question}</div>
                    <div class="question-actions">
                        <button class="reflect-btn" id="btn-${questionId}" onclick="toggleInlineReflection('${questionId}', '${question}')">
                            <i class="fas fa-pen"></i> 성찰하기
                        </button>
                    </div>
                    <div class="reflection-content-inline" id="content-${questionId}"></div>
                </div>
            `}).join('');
        }
        
        function toggleCategory(category) {
            const questionsList = document.getElementById(`questions-${category}`);
            const toggle = document.getElementById(`toggle-${category}`);
            
            if (questionsList.classList.contains('expanded')) {
                questionsList.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                document.querySelectorAll('.questions-list').forEach(list => {
                    list.classList.remove('expanded');
                });
                document.querySelectorAll('.category-toggle').forEach(t => {
                    t.classList.remove('expanded');
                });
                
                questionsList.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }
        
        function loadRandomQuestion() {
            const randomQuestion = getRandomItem(allQuestions);
            document.getElementById('randomQuestionText').textContent = randomQuestion;
        }
        
        function toggleInlineReflection(questionElementId, questionText) {
            const contentDiv = document.getElementById(`content-${questionElementId}`);
            const button = document.getElementById(`btn-${questionElementId}`);

            if (contentDiv.style.display === 'block' && button.dataset.mode === 'view') {
                contentDiv.style.display = 'none';
                return;
            }
            
            if (button.dataset.mode === 'view') {
                 contentDiv.style.display = 'block'; 
            } else {
                currentReflectionQuestion = questionText; 
                contentDiv.innerHTML = `
                    <textarea class="reflection-textarea" id="textarea-${questionElementId}" placeholder="이 질문에 대해 자유롭게 생각을 적어보세요..."></textarea>
                    <div class="modal-actions" style="margin-top:1rem;">
                        <button class="btn-outline" onclick="cancelInlineReflection('${questionElementId}')">취소</button>
                        <button class="btn-primary" onclick="saveInlineReflection('${questionElementId}', '${questionText}')">저장하기</button>
                    </div>
                `;
                contentDiv.style.display = 'block';
                document.getElementById(`textarea-${questionElementId}`).focus();
            }
        }

        function cancelInlineReflection(questionElementId) {
            const contentDiv = document.getElementById(`content-${questionElementId}`);
            const button = document.getElementById(`btn-${questionElementId}`);
            contentDiv.style.display = 'none';
            contentDiv.innerHTML = ''; 
            if (button.dataset.mode !== 'view') {
                 button.innerHTML = '<i class="fas fa-pen"></i> 성찰하기';
            }
        }

        async function saveInlineReflection(questionElementId, questionText) {
            const textarea = document.getElementById(`textarea-${questionElementId}`);
            const reflectionText = textarea.value.trim();

            if (!reflectionText) {
                showMessage('성찰 내용을 입력해주세요.', 'error');
                return;
            }

            if (!currentUser) {
                showMessage('로그인이 필요합니다.', 'error');
                showLoginModal();
                return;
            }

            const reflectionDocId = `${currentUser.uid}_${Date.now()}`; 
            const reflectionData = {
                id: reflectionDocId,
                question: questionText,
                reflection: reflectionText,
                date: new Date().toISOString(),
                userId: currentUser.uid,
                questionElementId: questionElementId 
            };

            const success = await saveToFirestore('reflections', reflectionDocId, reflectionData);

            if (success) {
                const contentDiv = document.getElementById(`content-${questionElementId}`);
                contentDiv.innerHTML = `<div class="saved-reflection-text">${reflectionText}</div>
                                        <button class="btn-outline" style="margin-top:1rem;" onclick="editInlineReflection('${questionElementId}', '${questionText}', '${reflectionDocId}', \`${reflectionText}\`)"><i class="fas fa-edit"></i> 수정</button>
                                        <button class="btn-danger" style="margin-top:1rem; margin-left:0.5rem;" onclick="deleteInlineReflection('${questionElementId}', '${reflectionDocId}')"><i class="fas fa-trash"></i> 삭제</button>`;
                
                const button = document.getElementById(`btn-${questionElementId}`);
                button.innerHTML = '<i class="fas fa-eye"></i> 성찰 보기';
                button.dataset.mode = 'view'; 
                button.classList.add('btn-outline'); // btn-secondary 대신 btn-outline 사용

                showMessage('성찰이 저장되었습니다.', 'success');
                await loadSavedReflections(); 
            } else {
                showMessage('성찰 저장에 실패했습니다.', 'error');
            }
        }
        
        function openReflectionModal(question) {
            currentReflectionQuestion = question;
            document.getElementById('modalQuestion').textContent = question;
            document.getElementById('reflectionTextarea').value = '';
            document.getElementById('reflectionModal').style.display = 'block';
        }
        
        function closeReflectionModal() {
            document.getElementById('reflectionModal').style.display = 'none';
            currentReflectionQuestion = '';
        }
        
        async function saveReflection() { 
            if (!currentUser) {
                showMessage('로그인이 필요합니다.', 'error');
                showLoginModal();
                return;
            }

            const reflection = document.getElementById('reflectionTextarea').value.trim();
            
            if (!reflection) {
                showMessage('성찰 내용을 입력해주세요.', 'error');
                return;
            }

            const reflectionDocId = Date.now().toString(); 
            const reflectionData = {
                id: reflectionDocId, 
                question: currentReflectionQuestion,
                reflection: reflection,
                date: new Date().toISOString(),
                userId: currentUser.uid
            };
            
            const success = await saveToFirestore('reflections', reflectionDocId, reflectionData);
            if (success) {
                closeReflectionModal();
                showMessage('성찰이 저장되었습니다.', 'success');
                await loadSavedReflections(); 
            } else {
                showMessage('성찰 저장에 실패했습니다.', 'error');
            }
        }

        function editInlineReflection(questionElementId, questionText, reflectionDocId, currentReflectionText) {
            const contentDiv = document.getElementById(`content-${questionElementId}`);
            contentDiv.innerHTML = `
                <textarea class="reflection-textarea" id="textarea-edit-${questionElementId}">${currentReflectionText}</textarea>
                <div class="modal-actions" style="margin-top:1rem;">
                    <button class="btn-outline" onclick="cancelEditInlineReflection('${questionElementId}', '${reflectionDocId}', \`${currentReflectionText}\`, '${questionText}')">취소</button>
                    <button class="btn-danger" onclick="deleteInlineReflection('${questionElementId}', '${reflectionDocId}')"><i class="fas fa-trash"></i> 삭제</button>
                    <button class="btn-primary" onclick="saveEditedInlineReflection('${questionElementId}', '${reflectionDocId}')">수정 저장</button>
                </div>
            `;
            document.getElementById(`textarea-edit-${questionElementId}`).focus();
        }

        function cancelEditInlineReflection(questionElementId, reflectionDocId, originalText, questionText) {
            // questionText 인자 추가 (editInlineReflection 호출 시 필요)
            const contentDiv = document.getElementById(`content-${questionElementId}`);
            contentDiv.innerHTML = `<div class="saved-reflection-text">${originalText}</div>
                                    <button class="btn-outline" style="margin-top:1rem;" onclick="editInlineReflection('${questionElementId}', '${questionText || document.getElementById(questionElementId + '-item').querySelector('.question-text').textContent}', '${reflectionDocId}', \`${originalText}\`)"><i class="fas fa-edit"></i> 수정</button>
                                    <button class="btn-danger" style="margin-top:1rem; margin-left:0.5rem;" onclick="deleteInlineReflection('${questionElementId}', '${reflectionDocId}')"><i class="fas fa-trash"></i> 삭제</button>`;
        }

        async function saveEditedInlineReflection(questionElementId, reflectionDocId) {
            const newReflectionText = document.getElementById(`textarea-edit-${questionElementId}`).value.trim();
            if (!newReflectionText) {
                showMessage('수정할 내용을 입력해주세요.', 'error');
                return;
            }
            
            try {
                await db.collection('reflections').doc(reflectionDocId).update({
                    reflection: newReflectionText,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showMessage('성찰 내용이 수정되었습니다.', 'success');
                // 수정 후 보기 모드로 전환 시 questionText를 가져와야 함
                const questionText = document.getElementById(`${questionElementId}-item`).querySelector('.question-text').textContent;
                cancelEditInlineReflection(questionElementId, reflectionDocId, newReflectionText, questionText); 
                await loadSavedReflections(); 
            } catch (error) {
                 console.error("Error updating inline reflection: ", error);
                 showMessage('성찰 내용 수정에 실패했습니다.', 'error');
            }
        }

        async function deleteInlineReflection(questionElementId, reflectionDocId) {
            if (!currentUser) return;

            if (confirm('이 성찰 기록을 삭제하시겠습니까? (이 작업은 되돌릴 수 없습니다)')) {
                try {
                    await db.collection('reflections').doc(reflectionDocId).delete();
                    
                    const contentDiv = document.getElementById(`content-${questionElementId}`);
                    contentDiv.style.display = 'none';
                    contentDiv.innerHTML = '';
                    
                    const button = document.getElementById(`btn-${questionElementId}`);
                    button.innerHTML = '<i class="fas fa-pen"></i> 성찰하기';
                    button.dataset.mode = ''; // 'view' 모드 해제                    
                    button.classList.add('reflect-btn');

                    showMessage('성찰 기록이 삭제되었습니다.', 'success');
                    await loadSavedReflections(); // 하단 목록도 업데이트
                } catch (error) {
                    console.error("Error deleting inline reflection: ", error);
                    showMessage('성찰 기록 삭제에 실패했습니다.', 'error');
                }
            }
        }

        async function loadSavedReflections() {
            if (!currentUser) {
                document.getElementById('savedReflectionsList').innerHTML = 
                    '<p class="text-center" style="color:#666;">로그인 후 성찰 기록을 확인하고 저장할 수 있습니다.</p>';
                return;
            } else {
                 // 비로그인 시 로컬 스토리지에서 로드 (선택적, 현재는 인라인 표시에만 사용)
                 // renderSavedReflections(loadFromLocalStorage('savedReflections') || []);
            }

            try {
                const snapshot = await db.collection('reflections')
                                        .where('userId', '==', currentUser.uid)
                                        // .orderBy('date', 'desc') // 인라인 표시는 순서가 중요하지 않을 수 있음
                                        // .limit(20) // 모든 질문에 대한 기록을 불러와야 할 수 있으므로 limit 제거 고려
                                        // 또는 페이지 로드 시 너무 많은 데이터를 가져오지 않도록 페이지네이션이나 다른 전략 고려
                                        .get();
                
                const reflections = [];
                snapshot.forEach(doc => {
                    reflections.push({ id: doc.id, ...doc.data() });
                });
                renderSavedReflections(reflections);
            } catch (error) {
                console.error("Error loading reflections: ", error);
                showMessage('성찰 기록을 불러오는 데 실패했습니다.', 'error');
                document.getElementById('savedReflectionsList').innerHTML = 
                    '<p class="text-center" style="color:red;">기록을 불러오는 중 오류가 발생했습니다.</p>';
            }
        }

        function renderSavedReflections(reflections) {
            const listElement = document.getElementById('savedReflectionsList');
            // 페이지 하단 목록 생성 로직 제거
            // if (!reflections || reflections.length === 0) {
            //     if(listElement) listElement.innerHTML = '<p class="text-center" style="color:#666;">아직 저장된 성찰 기록이 없습니다.</p>';
            //     return;
            // }
            // if(listElement) listElement.innerHTML = ''; // Clear previous list if any

            reflections.forEach(item => {
                if (item.questionElementId) { 
                    const button = document.getElementById(`btn-${item.questionElementId}`);
                    const contentDiv = document.getElementById(`content-${item.questionElementId}`);
                    if (button && contentDiv) {
                        button.innerHTML = '<i class="fas fa-eye"></i> 성찰 보기';
                        button.dataset.mode = 'view';
                        button.classList.add('btn-outline'); // btn-secondary 대신 btn-outline 사용
                        contentDiv.innerHTML = `<div class="saved-reflection-text">${item.reflection}</div>
                                                <button class="btn-outline" style="margin-top:0.5rem;" onclick="editInlineReflection('${item.questionElementId}', '${item.question}', '${item.id}', \`${item.reflection}\`)"><i class="fas fa-edit"></i> 수정</button>
                                                <button class="btn-danger" style="margin-top:0.5rem; margin-left:0.5rem;" onclick="deleteInlineReflection('${item.questionElementId}', '${item.id}')"><i class="fas fa-trash"></i> 삭제</button>`;
                    }
                }
            });
        }

        window.addEventListener('click', function(event) {
            const reflectionModal = document.getElementById('reflectionModal');
            // editReflectionModal 관련 로직 제거
            // const editReflectionModal = document.getElementById('editReflectionModal');
            if (event.target === reflectionModal) {
                closeReflectionModal();
            }
            // if (event.target === editReflectionModal) {
            //     closeEditReflectionModal();
            // }
        });
    </script>
</body>
</html>
