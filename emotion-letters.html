<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°ì • í¸ì§€ - EmotiCare</title>
    <link rel="stylesheet" href="styles.css?v=20240701a">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* .letters-container íŒ¨ë”©ì€ .page-inner-container ë¡œ ëŒ€ì²´ */
        
        .write-section {
            /* .content-block ìœ¼ë¡œ ëŒ€ì²´ */
            margin-bottom: 2rem; /* content-block ê¸°ë³¸ ë§ˆì§„ ì™¸ ì¶”ê°€ ë§ˆì§„ í•„ìš”ì‹œ */
        }
        
        .guidelines {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .guidelines h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .guidelines ul {
            list-style: none;
            padding: 0;
        }
        
        .guidelines li {
            margin-bottom: 0.8rem;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .guidelines li::before {
            content: 'âœ¨';
            position: absolute;
            left: 0;
        }
        
        .letter-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .letter-textarea {
            min-height: 300px;
            padding: 1rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
            /* transitionì€ styles.cssì˜ .form-input ë“±ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ */
        }
        
        .letter-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .letter-actions {
            display: flex;
            gap: 1rem;
            justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
        }
        
        .recent-letters {
            /* .content-block ìœ¼ë¡œ ëŒ€ì²´ */
            margin-bottom: 2rem; /* content-block ê¸°ë³¸ ë§ˆì§„ ì™¸ ì¶”ê°€ ë§ˆì§„ í•„ìš”ì‹œ */
        }
        
        .letters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .letters-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .letter-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 1rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .letter-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        
        .letter-meta {
            display: flex;
            justify-content: space-between;
            align-items: center; 
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .letter-preview {
            color: #333;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .char-counter {
            text-align: right;
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .delete-all-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .delete-all-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        /* í¸ì§€ ë‹¬ë ¥ ì„¹ì…˜ ìŠ¤íƒ€ì¼ (mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© ë° ì¶”ê°€) */
        .letter-calendar-section {
            /* .content-block ë˜ëŠ” .calendar-block ìœ¼ë¡œ ëŒ€ì²´ */
            margin-top: 2rem; /* ìƒë‹¨ ë§ˆì§„ ì¡°ì • */
        }

        .calendar-day.has-record { /* í¸ì§€ ê¸°ë¡ ìˆëŠ” ë‚ ì§œ í‘œì‹œ */
            border: 2px solid #764ba2; /* í…Œë‘ë¦¬ ìƒ‰ìƒ */
        }
        .calendar-day.has-record span { /* í¸ì§€ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 1em; /* ì•„ì´ì½˜ í¬ê¸° ì¡°ì • */
            z-index: 2;
        }

        /* ë‚ ì§œë³„ í¸ì§€ ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #lettersForDateModal .modal-content {
            max-width: 600px; /* ëª¨ë‹¬ ë„ˆë¹„ ì¡°ì • */
        }
        #lettersForDateModal .letter-card {
            cursor: default; /* ëª¨ë‹¬ ë‚´ ì¹´ë“œ í´ë¦­ ë¹„í™œì„±í™” */
            margin-bottom: 1rem;
        }
        #lettersForDateModal .letter-card .btn-outline {
            padding: 0.4rem 0.8rem; /* ë²„íŠ¼ íŒ¨ë”© ì¶•ì†Œ */
            font-size: 0.85rem; /* ë²„íŠ¼ í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
        }

        @media (max-width: 768px) {
            .guidelines { padding: 1.5rem; }
            .guidelines h3 { font-size: 1.1rem; }
            .guidelines li { font-size: 0.9rem; margin-bottom: 0.6rem; padding-left: 1.2rem;}
            .letter-textarea { padding: 0.8rem; min-height: 200px; }
            .letter-card { padding: 0.8rem; }
            .letter-meta { font-size: 0.8rem; margin-bottom: 0.5rem;}
            .letter-preview { font-size: 0.9rem; -webkit-line-clamp: 2; }
            .delete-all-btn { padding: 0.6rem 1rem; font-size: 0.9rem; }
            .letters-header h3 { font-size: 1.2rem; }
        }

        /* ëª¨ë‹¬ ë‚´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ê°„ê²© */
        #letterModal .modal-body .btn-outline + .btn-danger,
        #letterModal .modal-body .btn-danger + .btn-outline {
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">ê°ì • í¸ì§€</h1>
                <p class="page-subtitle">ìì‹ ì—ê²Œ ë³´ë‚´ëŠ” í¸ì§€ë¡œ ë§ˆìŒì† ê¹Šì€ ê°ì •ì„ í‘œí˜„í•´ë³´ì„¸ìš”</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="page-inner-container letters-container">
                <div class="content-block write-section">
                    <div class="guidelines">
                        <h3><i class="fas fa-lightbulb"></i> ê°ì • í¸ì§€ ì‘ì„± ê°€ì´ë“œ</h3>
                        <ul>
                            <li>ì§€ê¸ˆ ëŠë¼ê³  ìˆëŠ” ê°ì •ì„ ì†”ì§í•˜ê²Œ í‘œí˜„í•´ë³´ì„¸ìš”</li>
                            <li>ìì‹ ì—ê²Œ ë”°ëœ»í•œ ë§ì„ ê±´ë„¤ë³´ì„¸ìš”</li>
                            <li>ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í•œ ìì‹ ì„ ê²©ë ¤í•´ì£¼ì„¸ìš”</li>
                            <li>ë¯¸ë˜ì˜ ìì‹ ì—ê²Œ ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”</li>
                            <li>ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ìŠµë‹ˆë‹¤. ë§ˆìŒì´ ê°€ëŠ” ëŒ€ë¡œ ì¨ë³´ì„¸ìš”</li>
                            <li>ì‘ì„±ì´ ì™„ë£Œëœ í¸ì§€ëŠ” ì•„ë˜ ë‹¬ë ¥ì— ë‚ ì§œë³„ë¡œ ì €ì¥ë©ë‹ˆë‹¤</li>
                        </ul>
                    </div>
                    
                    <form class="letter-form" onsubmit="saveLetter(event)">
                        <textarea 
                            id="letterContent" 
                            class="letter-textarea" 
                            placeholder="ì¹œì• í•˜ëŠ” ë‚˜ì—ê²Œ,

ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ì§€ê¸ˆ ë§ˆìŒì†ì— ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”..."
                            oninput="updateCharCounter()"
                        ></textarea>
                        <div class="char-counter" id="charCounter">0ì</div>
                        
                        <div class="letter-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-pen-alt"></i> ì‘ì„± ì™„ë£Œ
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="content-block recent-letters">
                    <div class="letters-header">
                        <h3>ìµœê·¼ ì‘ì„±í•œ í¸ì§€</h3>
                        <button class="delete-all-btn" onclick="deleteAllLetters()">
                            <i class="fas fa-trash"></i> ëª¨ë“  í¸ì§€ ì‚­ì œ
                        </button>
                    </div>
                    
                    <div class="letters-list" id="recentLettersList">
                        <!-- ìµœê·¼ í¸ì§€ ëª©ë¡ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- í¸ì§€ ë‹¬ë ¥ ì„¹ì…˜ ì¶”ê°€ -->
                <div class="content-block letter-calendar-section">
                    <div class="letters-header">
                        <h3>í¸ì§€ ë‹¬ë ¥</h3>
                    </div>
                    <div class="calendar-block-header" style="margin-bottom: 1rem;">
                        <div class="calendar-block-nav">
                            <button onclick="changeLetterCalendarMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span class="calendar-block-title" id="letterCalendarMonth"></span>
                            <button onclick="changeLetterCalendarMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-block">
                        <div class="calendar-grid-common">
                        </div>
                        <div class="calendar-grid-common" id="letterCalendarGrid">
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- í¸ì§€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="letterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="letterModalDate">í¸ì§€ ë³´ê¸°</h3>
                <button class="modal-close" onclick="closeLetterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="letterModalContent" style="line-height: 1.8; white-space: pre-wrap;"></div>
                <div class="mt-3" style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                    <button class="btn-outline" onclick="startEditCurrentLetter()">
                        <i class="fas fa-edit"></i> ìˆ˜ì •í•˜ê¸°
                    </button>
                    <button class="btn-outline btn-danger" onclick="deleteLetter()">
                        <i class="fas fa-trash"></i> ì‚­ì œí•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë‚ ì§œë³„ í¸ì§€ ë³´ê¸° ëª¨ë‹¬ -->
    <div id="lettersForDateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="lettersForDateModalTitle"></h3>
                <button class="modal-close" onclick="closeLettersForDateModal()">&times;</button>
            </div>
            <div class="modal-body" id="lettersForDateModalBody">
            </div>
        </div>
    </div>
    
    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let recentLetters = []; 
        let allLettersData = {}; 
        let currentLetterId = null; 
        let editingLetterId = null; // ìˆ˜ì • ì¤‘ì¸ í¸ì§€ ID
        let currentCalendarDate = new Date(); 
        
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('authStateReady', async function(e) {
                currentUser = e.detail.user; 
                console.log('emotion-letters.html: authStateReady event. User:', currentUser ? currentUser.uid : 'No user');
                allLettersData = {}; 
                editingLetterId = null; // ë¡œê·¸ì•„ì›ƒ/ë¡œê·¸ì¸ ì‹œ ìˆ˜ì • ìƒíƒœ ì´ˆê¸°í™”
                if (e.detail.user) {
                    console.log('emotion-letters.html: User detected, calling loadAllLetters.');
                    await loadAllLetters();
                } else {
                    loadAllLetters(); 
                    showMessage("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹œë©´ í¸ì§€ ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.", "info");
                }
                updateRecentLettersList(); 
                renderRecentLetters(); 
                renderLetterCalendar(); 
            });

            const draft = localStorage.getItem('letterDraft');
            if (draft) {
                document.getElementById('letterContent').value = draft;
                updateCharCounter();
            }
            let autoSaveTimer;
            document.getElementById('letterContent').addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    const content = this.value.trim();
                    if (content) {
                        localStorage.setItem('letterDraft', content);
                    } else {
                         localStorage.removeItem('letterDraft');
                    }
                }, 2000); 
            });
        });
        
        function updateCharCounter() {
            const content = document.getElementById('letterContent').value;
            const counter = document.getElementById('charCounter');
            counter.textContent = `${content.length}ì`;
            
            if (content.length > 1000) { 
                counter.style.color = '#ff6b6b';
            } else {
                counter.style.color = '#666';
            }
        }
        
        async function saveLetter(event) {
            event.preventDefault();
            
            const letterContentElement = document.getElementById('letterContent');
            const content = letterContentElement.value.trim();
            const saveButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = saveButton.innerHTML;

            if (!content) {
                showMessage('í¸ì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
             if (content.length > 1000) {
                 showMessage('í¸ì§€ ë‚´ìš©ì€ 1000ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                 return;
             }

            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';

            if (editingLetterId) { // ìˆ˜ì • ëª¨ë“œ
                let letterToUpdate = null;
                let originalDateKey = null;

                Object.keys(allLettersData).forEach(dateKey => {
                    const foundLetter = allLettersData[dateKey].find(l => l.id === editingLetterId);
                    if (foundLetter) {
                        letterToUpdate = foundLetter;
                        originalDateKey = dateKey;
                    }
                });

                if (letterToUpdate) {
                    letterToUpdate.content = content;
                    letterToUpdate.preview = content.substring(0, 100) + (content.length > 100 ? '...' : '');
                    
                    if (currentUser) {
                        try {
                            await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.ê°ì •í¸ì§€).doc(editingLetterId).update({
                                content: content,
                                preview: letterToUpdate.preview,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            showMessage('í¸ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        } catch (error) {
                            console.error("Firebase í¸ì§€ ìˆ˜ì • ì‹¤íŒ¨:", error);
                            showMessage('í¸ì§€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                        }
                    } else {
                         showMessage('í¸ì§€ê°€ ë¡œì»¬ì—ì„œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¡œê·¸ì¸ ì‹œ ë™ê¸°í™”)', 'info');
                    }
                    saveToLocalStorage('allEmotionLettersData', allLettersData);
                } else {
                    showMessage('ìˆ˜ì •í•  í¸ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
                editingLetterId = null; 

            } else { // ìƒˆ í¸ì§€ ì €ì¥ ëª¨ë“œ
                const now = new Date(); // ì‚¬ìš©ìì˜ í˜„ì¬ ë¡œì»¬ ì‹œê°„
                const localDateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const utcTimestamp = now.toISOString();

                const letter = {
                    id: Date.now().toString(),
                    content: content,
                    date: utcTimestamp, 
                    displayDate: localDateString, 
                    preview: content.substring(0, 100) + (content.length > 100 ? '...' : '')
                };
                const dateKey = letter.displayDate; 
                if (!allLettersData[dateKey]) allLettersData[dateKey] = [];
                allLettersData[dateKey].unshift(letter);
                saveToLocalStorage('allEmotionLettersData', allLettersData);
                if (currentUser) {
                    try {
                        await saveToFirestore(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.ê°ì •í¸ì§€, letter.id, { 
                            content: letter.content,
                            date: letter.date, 
                            displayDate: letter.displayDate, 
                            preview: letter.preview,
                            userId: currentUser.uid 
                        });
                        showMessage('í¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    } catch (error) {
                        console.error("Firebase í¸ì§€ ì €ì¥ ì‹¤íŒ¨:", error);
                        showMessage('í¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì˜¤ë¥˜)', 'error');
                    }
                } else {
                    showMessage('í¸ì§€ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ë©´ ë™ê¸°í™”ë©ë‹ˆë‹¤.', 'info');
                }
            }

            updateRecentLettersList();
            renderRecentLetters();
            clearLetter(); 
            renderLetterCalendar();
            localStorage.removeItem('letterDraft');
            saveButton.disabled = false;
        }
        
        function clearLetter() {
            document.getElementById('letterContent').value = '';
            updateCharCounter();
            editingLetterId = null; 
            const saveButton = document.querySelector('.letter-form button[type="submit"]');
            if (saveButton) {
                saveButton.innerHTML = '<i class="fas fa-pen-alt"></i> ì‘ì„± ì™„ë£Œ';
            }
        }
        
        async function loadAllLetters() {
            console.log('loadAllLetters: currentUser in loadAllLetters:', currentUser ? currentUser.uid : 'No user');
            if (currentUser) {
                try {
                    console.log(`loadAllLetters: Fetching letters from Firebase for user ${currentUser.uid}`);
                    const snapshot = await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.ê°ì •í¸ì§€)
                                           .where('userId', '==', currentUser.uid)
                                           .orderBy('date', 'desc') 
                                           .get();
                    
                    const firebaseData = {};
                    snapshot.forEach(doc => {
                        const letterData = doc.data();
                        const dateKey = letterData.displayDate || letterData.date.split('T')[0]; 
                        if (!firebaseData[dateKey]) {
                            firebaseData[dateKey] = [];
                        }
                        firebaseData[dateKey].push({ id: doc.id, ...letterData });
                    });
                    console.log('loadAllLetters: Fetched', snapshot.size, 'letters from Firebase. Processed data:', firebaseData);
                    allLettersData = firebaseData; 
                    saveToLocalStorage('allEmotionLettersData', allLettersData); 
                } catch (error) {
                    console.error("Firebase ëª¨ë“  í¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", error);
                    showMessage("í¸ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                    allLettersData = {}; 
                }
            } else {
                console.log('loadAllLetters: No user, loading from LocalStorage.');
                const localData = loadFromLocalStorage('allEmotionLettersData');
                allLettersData = localData || {};
            }
        }

        function updateRecentLettersList() {
            const flatLetters = Object.values(allLettersData).flat(); 
            flatLetters.sort((a, b) => new Date(b.date) - new Date(a.date));
            recentLetters = flatLetters.slice(0, 3);
        }

        function mergeLetterArrays(arr1, arr2) {
            const map = new Map(arr1.map(item => [item.id, item]));
            arr2.forEach(item => map.set(item.id, item));
            return Array.from(map.values()).sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        
        function renderRecentLetters() {
            const lettersList = document.getElementById('recentLettersList'); 
            
            if (recentLetters.length === 0) {
                lettersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-envelope-open"></i>
                        <p>ì•„ì§ ì‘ì„±í•œ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ í¸ì§€ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }
            
            lettersList.innerHTML = recentLetters.map(letter => `
                <div class="letter-card" onclick="openLetterModal('${letter.id}')">
                    <div class="letter-meta">
                        <span><i class="fas fa-calendar"></i> ${formatLetterDate(letter.date)}</span>
                        <span><i class="fas fa-file-alt"></i> ${letter.content.length}ì</span>
                    </div>
                    <div class="letter-preview">${letter.preview}</div>
                </div>
            `).join('');
        }

        function renderLetterCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('letterCalendarMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;

            const calendarGrid = document.getElementById('letterCalendarGrid');
            calendarGrid.innerHTML = '';

            const dayHeaderGrid = calendarGrid.previousElementSibling;
            const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            if (dayHeaderGrid.innerHTML.trim() === '') {
                dayHeaders.forEach(day => {
                    const dayHeaderCell = document.createElement('div');
                    dayHeaderCell.className = 'calendar-day-name-common';
                    dayHeaderCell.textContent = day;
                    dayHeaderGrid.appendChild(dayHeaderCell);
                });
            }

            const firstDayOfMonth = new Date(year, month, 1);
            const startDate = new Date(firstDayOfMonth);
            startDate.setDate(startDate.getDate() - firstDayOfMonth.getDay()); 

            const today = new Date();

            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dataAccessKey = `${cellDate.getFullYear()}-${String(cellDate.getMonth() + 1).padStart(2, '0')}-${String(cellDate.getDate()).padStart(2, '0')}`;

                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day-cell-common calendar-day'; 

                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month');
                } else {
                    // â˜…â˜…â˜… ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì§ì „) â˜…â˜…â˜…
                    console.log(`Attaching click listener to day: ${dataAccessKey}`);
                    if (allLettersData[dataAccessKey] && allLettersData[dataAccessKey].length > 0) {
                        dayCell.classList.add('has-record');
                        dayCell.innerHTML += `<span style="position:absolute; bottom:5px; right:5px; font-size:1.2em;">ğŸ’Œ</span>`;
                        dayCell.addEventListener('click', () => {
                            // â˜…â˜…â˜… ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ (ì´ë²¤íŠ¸ ë°œìƒ ì‹œ) â˜…â˜…â˜…
                            console.log(`Calendar day (WITH records) clicked: ${dataAccessKey}, cellDate: ${cellDate.toDateString()}`);
                            openLettersForDateModal(dataAccessKey, cellDate);
                        });
                    } else {
                         dayCell.addEventListener('click', () => {
                            // â˜…â˜…â˜… ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ (ì´ë²¤íŠ¸ ë°œìƒ ì‹œ) â˜…â˜…â˜…
                            console.log(`Calendar day (NO records) clicked: ${dataAccessKey}, cellDate: ${cellDate.toDateString()}`);
                            openLettersForDateModal(dataAccessKey, cellDate);
                         }); 
                    }
                }
                 if (cellDate.getFullYear() === today.getFullYear() &&
                     cellDate.getMonth() === today.getMonth() &&
                     cellDate.getDate() === today.getDate()) {
                    dayCell.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                calendarGrid.appendChild(dayCell);
            }
        }

        function changeLetterCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderLetterCalendar();
        }
        
        function formatLetterDate(dateString) { 
            const date = new Date(dateString); 
            const now = new Date();
            const todayForCompare = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const letterDateForCompare = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const diffInMilliseconds = todayForCompare.getTime() - letterDateForCompare.getTime();
            const diffInDays = diffInMilliseconds / (1000 * 60 * 60 * 24);
            
            if (diffInDays === 0) return 'ì˜¤ëŠ˜';
            if (diffInDays === 1) return 'ì–´ì œ';
            if (diffInDays > 1 && diffInDays <= 7) return `${Math.floor(diffInDays)}ì¼ ì „`;
            return `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
        }
        
        function openLetterModal(letterId) {
            const letter = Object.values(allLettersData).flat().find(l => l.id === letterId);
            if (!letter) return;
            
            currentLetterId = letter.id; 
            document.getElementById('letterModalDate').textContent = 
                formatLetterDate(letter.date) + ' ì‘ì„±í•œ í¸ì§€';
            document.getElementById('letterModalContent').textContent = letter.content;
            document.getElementById('letterModal').style.display = 'block';
        }
        
        function openLettersForDateModal(dataAccessKey, localCellDate) {
            // â˜…â˜…â˜… ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ (í•¨ìˆ˜ í˜¸ì¶œ ì‹œ) â˜…â˜…â˜…
            console.log(`openLettersForDateModal called. dataAccessKey: ${dataAccessKey}, localCellDate: ${localCellDate.toDateString()}`);
            
            const lettersOnDate = allLettersData[dataAccessKey] || [];
            const modalTitle = document.getElementById('lettersForDateModalTitle');
            const modalBody = document.getElementById('lettersForDateModalBody');
            const modal = document.getElementById('lettersForDateModal');

            if (!modal || !modalTitle || !modalBody) {
                console.error("ë‚ ì§œë³„ í¸ì§€ ë³´ê¸° ëª¨ë‹¬ ë˜ëŠ” ë‚´ë¶€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                showMessage("í¸ì§€ ë³´ê¸° ì°½ì„ ì—¬ëŠ” ë° í•„ìš”í•œ êµ¬ì„± ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                return;
            }
            
            modalTitle.textContent = `${localCellDate.getFullYear()}ë…„ ${localCellDate.getMonth() + 1}ì›” ${localCellDate.getDate()}ì¼ì˜ í¸ì§€`;

            if (lettersOnDate.length === 0) {
                modalBody.innerHTML = '<p>í•´ë‹¹ ë‚ ì§œì— ì‘ì„±ëœ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                lettersOnDate.sort((a, b) => new Date(b.date) - new Date(a.date));
                modalBody.innerHTML = lettersOnDate.map(letter => `
                    <div class="letter-card" style="cursor:default; margin-bottom:1rem;">
                        <div class="letter-meta">
                            <span><i class="fas fa-clock"></i> ${new Date(letter.date).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</span>
                            <span><i class="fas fa-file-alt"></i> ${letter.content.length}ì</span>
                        </div>
                        <div style="white-space: pre-wrap; margin-top:0.5rem;">${letter.content}</div>
                         <button class="btn-outline btn-sm mt-2" onclick="deleteSpecificLetter('${letter.id}', '${dataAccessKey}')">ì´ í¸ì§€ ì‚­ì œ</button>
                    </div>
                `).join('');
            }
            // â˜…â˜…â˜… ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ (ëª¨ë‹¬ í‘œì‹œ ì§ì „) â˜…â˜…â˜…
            console.log('Attempting to display lettersForDateModal. Current display:', modal.style.display);
            modal.style.display = 'block';
            console.log('lettersForDateModal display style set to "block". New display:', modal.style.display);
        }

        function closeLettersForDateModal() {
            const modal = document.getElementById('lettersForDateModal');
            if (modal) modal.style.display = 'none';
        }

        function closeLetterModal() {
            const modal = document.getElementById('letterModal');
            if (modal) modal.style.display = 'none';
            currentLetterId = null;
        }
        
        async function deleteLetter() {
            if (!currentLetterId) return;
            
            if (confirm('ì´ í¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                let dateKeyToDeleteFrom = null;
                Object.keys(allLettersData).forEach(dateKey => {
                    const initialLength = allLettersData[dateKey].length;
                    allLettersData[dateKey] = allLettersData[dateKey].filter(l => l.id !== currentLetterId);
                    if (allLettersData[dateKey].length < initialLength) {
                        dateKeyToDeleteFrom = dateKey; 
                    }
                     if (allLettersData[dateKey].length === 0) {
                        delete allLettersData[dateKey]; 
                    }
                });

                saveToLocalStorage('allEmotionLettersData', allLettersData);

                if (currentUser) {
                    try {
                         await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.ê°ì •í¸ì§€).doc(currentLetterId).delete(); 
                    } catch (error) { console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', error); }
                }

                updateRecentLettersList(); 
                renderRecentLetters(); 
                renderLetterCalendar(); 
                closeLetterModal(); 
                showMessage('í¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        async function deleteSpecificLetter(letterId, dataAccessKey) {
             if (confirm('ì´ í¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (allLettersData[dataAccessKey]) {
                    allLettersData[dataAccessKey] = allLettersData[dataAccessKey].filter(l => l.id !== letterId);
                    if (allLettersData[dataAccessKey].length === 0) {
                        delete allLettersData[dataAccessKey]; 
                    }
                }
                saveToLocalStorage('allEmotionLettersData', allLettersData);

                if (currentUser) {
                     try {
                         await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.ê°ì •í¸ì§€).doc(letterId).delete(); 
                     } catch (error) { console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', error); }
                }

                updateRecentLettersList(); 
                renderRecentLetters(); 
                renderLetterCalendar(); 
                closeLettersForDateModal(); 
                showMessage('í¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        async function deleteAllLetters() {
            const totalLettersCount = Object.values(allLettersData).flat().length;

            if (totalLettersCount === 0) {
                showMessage('ì‚­ì œí•  í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                return;
            }
            
            if (confirm(`ëª¨ë“  í¸ì§€ ${totalLettersCount}ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                recentLetters = []; 
                allLettersData = {}; 
                saveToLocalStorage('allEmotionLettersData', allLettersData); 

                if (currentUser) {
                    try {
                        const snapshot = await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.ê°ì •í¸ì§€).where('userId', '==', currentUser.uid).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    } catch (error) { console.error('Firebase ì „ì²´ ì‚­ì œ ì‹¤íŒ¨:', error); }
                }

                renderRecentLetters(); 
                renderLetterCalendar(); 
                showMessage('ëª¨ë“  í¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        function startEditCurrentLetter() {
            if (!currentLetterId) return;

            let letterToEdit = null;
            Object.values(allLettersData).flat().forEach(letter => {
                if (letter.id === currentLetterId) {
                    letterToEdit = letter;
                }
            });

            if (letterToEdit) {
                editingLetterId = currentLetterId; 
                document.getElementById('letterContent').value = letterToEdit.content;
                updateCharCounter();
                document.querySelector('.letter-form button[type="submit"]').innerHTML = '<i class="fas fa-check"></i> ìˆ˜ì • ì™„ë£Œ';
                closeLetterModal(); 
                document.getElementById('letterContent').focus(); 
                window.scrollTo({ top: document.querySelector('.write-section').offsetTop, behavior: 'smooth' });
            } else {
                showMessage('ìˆ˜ì •í•  í¸ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        window.addEventListener('click', function(event) {
            const letterModal = document.getElementById('letterModal');
            if (event.target === letterModal) {
                closeLetterModal();
            }
            const lettersForDateModal = document.getElementById('lettersForDateModal');
            if (event.target === lettersForDateModal) {
                closeLettersForDateModal();
            }
        });
        
    </script>
</body>
</html>
