<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°ì • í¸ì§€ - EmotiCare</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .letters-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .write-section {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 3rem;
        }
        
        .guidelines {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .guidelines h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .guidelines ul {
            list-style: none;
            padding: 0;
        }
        
        .guidelines li {
            margin-bottom: 0.8rem;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .guidelines li::before {
            content: 'âœ¨';
            position: absolute;
            left: 0;
        }
        
        .letter-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .letter-textarea {
            min-height: 300px;
            padding: 1.5rem;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        .letter-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .letter-actions {
            display: flex;
            gap: 1rem;
            justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
        }
        
        .recent-letters {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 3rem; /* ë‹¬ë ¥ê³¼ì˜ ê°„ê²© ì¶”ê°€ */
        }
        
        .letters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .letters-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .letter-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 1.5rem;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .letter-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        
        .letter-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .letter-preview {
            color: #333;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .char-counter {
            text-align: right;
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .delete-all-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .delete-all-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        /* í¸ì§€ ë‹¬ë ¥ ì„¹ì…˜ ìŠ¤íƒ€ì¼ (mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© ë° ì¶”ê°€) */
        .letter-calendar-section {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 3rem;
        }

        .calendar-header-routine .date-nav { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
             display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
        }
        
        .calendar-header-routine .date-nav button { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
            background: #667eea;
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .calendar-header-routine .date-nav button:hover {
            background: #764ba2;
            transform: scale(1.1);
        }
         .calendar-header-routine .current-date-display { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .calendar-routine { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 0; /* í•˜ë‹¨ ë§ˆì§„ ì œê±° */
        }
        .calendar-day-header-routine { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }
        .calendar-grid-routine .calendar-day { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
            background: white;
            padding: 0.5rem; 
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .calendar-grid-routine { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e1e8ed;
            border-radius: 10px;
            overflow: hidden;
        }
        .calendar-day.other-month { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
            color: #ccc;
            background: #f8f9fa;
            pointer-events: none;
        }
        .calendar-day.today { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
             background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .calendar-day .day-number { /* mood-routine.html ìŠ¤íƒ€ì¼ ì¬í™œìš© */
            font-weight: 600;
            margin-bottom: 0.3rem; 
            z-index: 2; 
            position: relative; 
        }
        .calendar-day.has-record { /* í¸ì§€ ê¸°ë¡ ìˆëŠ” ë‚ ì§œ í‘œì‹œ */
            border: 2px solid #764ba2; /* í…Œë‘ë¦¬ ìƒ‰ìƒ */
        }
        .calendar-day.has-record span { /* í¸ì§€ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 1.2em;
            z-index: 2;
        }

        /* ë‚ ì§œë³„ í¸ì§€ ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #lettersForDateModal .modal-content {
            max-width: 600px; /* ëª¨ë‹¬ ë„ˆë¹„ ì¡°ì • */
        }
        #lettersForDateModal .letter-card {
            cursor: default; /* ëª¨ë‹¬ ë‚´ ì¹´ë“œ í´ë¦­ ë¹„í™œì„±í™” */
            margin-bottom: 1rem;
        }
        #lettersForDateModal .letter-card .btn-outline {
            padding: 0.5rem 1rem; /* ë²„íŠ¼ íŒ¨ë”© ì¡°ì • */
            font-size: 0.9rem; /* ë²„íŠ¼ í°íŠ¸ í¬ê¸° ì¡°ì • */
        }

    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">ê°ì • í¸ì§€</h1>
                <p class="page-subtitle">ìì‹ ì—ê²Œ ë³´ë‚´ëŠ” í¸ì§€ë¡œ ë§ˆìŒì† ê¹Šì€ ê°ì •ì„ í‘œí˜„í•´ë³´ì„¸ìš”</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="letters-container">
                <div class="write-section">
                    <div class="guidelines">
                        <h3><i class="fas fa-lightbulb"></i> ê°ì • í¸ì§€ ì‘ì„± ê°€ì´ë“œ</h3>
                        <ul>
                            <li>ì§€ê¸ˆ ëŠë¼ëŠ” ê°ì •ì„ ì†”ì§í•˜ê²Œ í‘œí˜„í•´ë³´ì„¸ìš”</li>
                            <li>ìì‹ ì—ê²Œ ë”°ëœ»í•œ ë§ì„ ê±´ë„¤ë³´ì„¸ìš”</li>
                            <li>ì˜¤ëŠ˜ í•˜ë£¨ ìˆ˜ê³ í•œ ìì‹ ì„ ê²©ë ¤í•´ì£¼ì„¸ìš”</li>
                            <li>ë¯¸ë˜ì˜ ìì‹ ì—ê²Œ ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”</li>
                            <li>ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ìŠµë‹ˆë‹¤. ë§ˆìŒì´ ê°€ëŠ” ëŒ€ë¡œ ì¨ë³´ì„¸ìš”</li>
                        </ul>
                    </div>
                    
                    <form class="letter-form" onsubmit="saveLetter(event)">
                        <textarea 
                            id="letterContent" 
                            class="letter-textarea" 
                            placeholder="ì¹œì• í•˜ëŠ” ë‚˜ì—ê²Œ,

ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ì§€ê¸ˆ ë§ˆìŒì†ì— ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”..."
                            oninput="updateCharCounter()"
                        ></textarea>
                        <div class="char-counter" id="charCounter">0ì</div>
                        
                        <div class="letter-actions">
                            <!-- ì§€ìš°ê¸° ë²„íŠ¼ ì‚­ì œ -->
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> í¸ì§€ ì €ì¥í•˜ê¸°
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="recent-letters">
                    <div class="letters-header">
                        <h3>ìµœê·¼ ì‘ì„±í•œ í¸ì§€</h3>
                        <button class="delete-all-btn" onclick="deleteAllLetters()">
                            <i class="fas fa-trash"></i> ëª¨ë“  í¸ì§€ ì‚­ì œ
                        </button>
                    </div>
                    
                    <div class="letters-list" id="recentLettersList">
                        <!-- ìµœê·¼ í¸ì§€ ëª©ë¡ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- í¸ì§€ ë‹¬ë ¥ ì„¹ì…˜ ì¶”ê°€ -->
                <div class="letter-calendar-section">
                    <div class="letters-header">
                        <h3>í¸ì§€ ë‹¬ë ¥</h3>
                    </div>
                    <div class="calendar-header-routine" style="margin-bottom: 1rem;">
                        <div class="date-nav">
                            <button onclick="changeLetterCalendarMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span class="current-date-display" id="letterCalendarMonth"></span>
                            <button onclick="changeLetterCalendarMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-routine">
                        <div class="calendar-grid-routine" id="letterCalendarGrid">
                            <!-- ë‹¬ë ¥ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- í¸ì§€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="letterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="letterModalDate">í¸ì§€ ë³´ê¸°</h3>
                <button class="modal-close" onclick="closeLetterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="letterModalContent" style="line-height: 1.8; white-space: pre-wrap;"></div>
                <div class="mt-3">
                    <button class="btn-outline" onclick="deleteLetter()">
                        <i class="fas fa-trash"></i> ì´ í¸ì§€ ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë‚ ì§œë³„ í¸ì§€ ë³´ê¸° ëª¨ë‹¬ -->
    <div id="lettersForDateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="lettersForDateModalTitle"></h3>
                <button class="modal-close" onclick="closeLettersForDateModal()">&times;</button>
            </div>
            <div class="modal-body" id="lettersForDateModalBody">
                <!-- í•´ë‹¹ ë‚ ì§œì˜ í¸ì§€ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
    
    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let recentLetters = []; // ìµœê·¼ 3ê°œë§Œ í‘œì‹œ
        let allLettersData = {}; // ëª¨ë“  í¸ì§€ë¥¼ ë‚ ì§œë³„ë¡œ ì €ì¥: {'YYYY-MM-DD': [letterObj, ...]}
        let currentLetterId = null; // ìƒì„¸ë³´ê¸° ëª¨ë‹¬ìš©
        let currentCalendarDate = new Date(); // í¸ì§€ ë‹¬ë ¥ìš© í˜„ì¬ ë‚ ì§œ
        
        document.addEventListener('DOMContentLoaded', function() {
            // common.jsì—ì„œ ì¸ì¦ ìƒíƒœ í™•ì¸ í›„ authStateReady ì´ë²¤íŠ¸ ë°œìƒ
            document.addEventListener('authStateReady', async function(e) {
                if (e.detail.user) {
                    await loadAllLetters(); // ë¡œê·¸ì¸ ì‹œ Firebaseì—ì„œë„ ë¡œë“œ
                } else {
                    loadAllLetters(); // ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œë§Œ ë¡œë“œ
                    showMessage("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹œë©´ í¸ì§€ ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.", "info");
                }
                updateRecentLettersList(); // ë¡œë“œëœ ë°ì´í„°ë¡œ ìµœê·¼ í¸ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
                renderRecentLetters(); // ìµœê·¼ í¸ì§€ ëª©ë¡ ë Œë”ë§
                renderLetterCalendar(); // í¸ì§€ ë‹¬ë ¥ ë Œë”ë§
            });

             // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ì‹œì €ì¥ëœ ë‚´ìš© ë³µì›
            const draft = localStorage.getItem('letterDraft');
            if (draft) {
                document.getElementById('letterContent').value = draft;
                updateCharCounter();
            }
             // ìë™ ì €ì¥ ê¸°ëŠ¥ (ì„ íƒì‚¬í•­)
            let autoSaveTimer;
            document.getElementById('letterContent').addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    const content = this.value.trim();
                    if (content) {
                        localStorage.setItem('letterDraft', content);
                        // showMessage('ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info'); // ìë™ ì €ì¥ ì•Œë¦¼ì€ ë„ˆë¬´ ìì£¼ ëœ¨ë©´ ë°©í•´ë  ìˆ˜ ìˆìŒ
                    } else {
                         localStorage.removeItem('letterDraft');
                    }
                }, 2000); // 2ì´ˆ í›„ ìë™ ì €ì¥
            });
        });
        
        function updateCharCounter() {
            const content = document.getElementById('letterContent').value;
            const counter = document.getElementById('charCounter');
            counter.textContent = `${content.length}ì`;
            
            if (content.length > 1000) { // ì˜ˆì‹œ: 1000ì ì œí•œ
                counter.style.color = '#ff6b6b';
            } else {
                counter.style.color = '#666';
            }
        }
        
        async function saveLetter(event) {
            event.preventDefault();
            
            const content = document.getElementById('letterContent').value.trim();
            if (!content) {
                showMessage('í¸ì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
             if (content.length > 1000) {
                 showMessage('í¸ì§€ ë‚´ìš©ì€ 1000ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                 return;
             }
            
            const letter = {
                id: Date.now().toString(), // ê³ ìœ  ID ìƒì„±
                content: content,
                date: new Date().toISOString(), // ISO ë¬¸ìì—´ë¡œ ì €ì¥
                preview: content.substring(0, 100) + (content.length > 100 ? '...' : '')
            };
            
            // ëª¨ë“  í¸ì§€ ë°ì´í„°ì— ì¶”ê°€
            const dateKey = letter.date.split('T')[0]; // 'YYYY-MM-DD' í˜•ì‹ì˜ ë‚ ì§œ í‚¤
            if (!allLettersData[dateKey]) {
                allLettersData[dateKey] = [];
            }
            allLettersData[dateKey].unshift(letter); // í•´ë‹¹ ë‚ ì§œì˜ ë§¨ ì•ì— ìƒˆ í¸ì§€ ì¶”ê°€

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ëª¨ë“  í¸ì§€ ë°ì´í„° ì €ì¥
            saveToLocalStorage('allEmotionLettersData', allLettersData);
            
            // Firebaseì— ì €ì¥ (ë¡œê·¸ì¸ëœ ê²½ìš°)
            if (currentUser) {
                // Firebaseì—ëŠ” ê°œë³„ í¸ì§€ ë¬¸ì„œë¥¼ ì €ì¥í•˜ê³  ë‚ ì§œ í•„ë“œë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ë” ìœ ì—°í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œ ê°œë³„ ë¬¸ì„œë¥¼ ì €ì¥í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                await saveToFirestore('emotionLetters', letter.id, {
                    ...letter,
                    userId: currentUser.uid // ì‚¬ìš©ì ID ì¶”ê°€
                });
            }

            updateRecentLettersList(); // ìµœê·¼ í¸ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
            renderRecentLetters(); // ìµœê·¼ í¸ì§€ ëª©ë¡ ë Œë”ë§
            clearLetter(); // ì‘ì„± í¼ ì´ˆê¸°í™”
            renderLetterCalendar(); // ë‹¬ë ¥ë„ ì—…ë°ì´íŠ¸ (í¸ì§€ ì•„ì´ì½˜ í‘œì‹œ)
            showMessage('í¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            localStorage.removeItem('letterDraft'); // ì„ì‹œì €ì¥ ë‚´ìš© ì‚­ì œ
        }
        
        function clearLetter() {
            document.getElementById('letterContent').value = '';
            updateCharCounter();
        }
        
        async function loadAllLetters() {
            const localData = loadFromLocalStorage('allEmotionLettersData');
            if (localData) {
                allLettersData = localData;
            } else {
                allLettersData = {}; // ë¡œì»¬ì— ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ë¡œ ì´ˆê¸°í™”
            }

            // ë¡œê·¸ì¸ëœ ê²½ìš° Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ë° ë³‘í•©
            if (currentUser) {
                try {
                    // Firebaseì—ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  í¸ì§€ë¥¼ ê°€ì ¸ì˜´
                    const snapshot = await db.collection('emotionLetters')
                                           .where('userId', '==', currentUser.uid)
                                           .orderBy('date', 'desc') // ë‚ ì§œ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì ¸ì˜´
                                           .get();
                    
                    const firebaseData = {};
                    snapshot.forEach(doc => {
                        const letter = doc.data();
                        const dateKey = letter.date.split('T')[0];
                        if (!firebaseData[dateKey]) {
                            firebaseData[dateKey] = [];
                        }
                        firebaseData[dateKey].push({ id: doc.id, ...letter });
                    });

                    // ë¡œì»¬ ë°ì´í„°ì™€ Firebase ë°ì´í„°ë¥¼ ë³‘í•© (Firebase ë°ì´í„° ìš°ì„ )
                    // ë‚ ì§œë³„ë¡œ ë³‘í•©
                    Object.keys(firebaseData).forEach(dateKey => {
                        allLettersData[dateKey] = mergeLetterArrays(allLettersData[dateKey] || [], firebaseData[dateKey]);
                    });
                    
                    // ë¡œì»¬ì—ë§Œ ìˆê³  Firebaseì— ì—†ëŠ” ë°ì´í„° ì²˜ë¦¬ (ì„ íƒì‚¬í•­: ì—…ë¡œë“œ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥)
                    // í˜„ì¬ëŠ” Firebase ë°ì´í„°ê°€ ìš°ì„ í•˜ë¯€ë¡œ ë¡œì»¬ ë°ì´í„°ëŠ” ë®ì–´ì“°ê±°ë‚˜ ë¬´ì‹œë¨

                    saveToLocalStorage('allEmotionLettersData', allLettersData); // ë³‘í•©ëœ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œì»¬ì— ì €ì¥

                } catch (error) {
                    console.error("Firebase ëª¨ë“  í¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", error);
                    // Firebase ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë°ì´í„°ë§Œ ì‚¬ìš© (allLettersDataëŠ” ì´ë¯¸ ë¡œì»¬ ë°ì´í„°ë¡œ ì´ˆê¸°í™”ë¨)
                }
            }
        }

        // ëª¨ë“  í¸ì§€ ë°ì´í„°ì—ì„œ ìµœê·¼ 3ê°œë§Œ ì¶”ì¶œí•˜ì—¬ recentLetters ë°°ì—´ ì—…ë°ì´íŠ¸
        function updateRecentLettersList() {
            const flatLetters = Object.values(allLettersData).flat(); // ëª¨ë“  ë‚ ì§œì˜ í¸ì§€ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹¨
            // ë‚ ì§œ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            flatLetters.sort((a, b) => new Date(b.date) - new Date(a.date));
            // ìµœê·¼ 3ê°œë§Œ ì„ íƒ
            recentLetters = flatLetters.slice(0, 3);
        }

        // ë‘ í¸ì§€ ë°°ì—´ì„ ë³‘í•© (ID ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ì œê±°, arr2 ìš°ì„ )
        function mergeLetterArrays(arr1, arr2) {
            const map = new Map(arr1.map(item => [item.id, item]));
            arr2.forEach(item => map.set(item.id, item));
            return Array.from(map.values()).sort((a, b) => new Date(b.date) - new Date(a.date)); // ë‚ ì§œ ìµœì‹ ìˆœ ì •ë ¬
        }
        
        // ìµœê·¼ í¸ì§€ ëª©ë¡ë§Œ ë Œë”ë§
        function renderRecentLetters() {
            const lettersList = document.getElementById('recentLettersList'); // ID ë³€ê²½
            
            if (recentLetters.length === 0) {
                lettersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-envelope-open"></i>
                        <p>ì•„ì§ ì‘ì„±í•œ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ í¸ì§€ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }
            
            lettersList.innerHTML = recentLetters.map(letter => `
                <div class="letter-card" onclick="openLetterModal('${letter.id}')">
                    <div class="letter-meta">
                        <span><i class="fas fa-calendar"></i> ${formatLetterDate(letter.date)}</span>
                        <span><i class="fas fa-file-alt"></i> ${letter.content.length}ì</span>
                    </div>
                    <div class="letter-preview">${letter.preview}</div>
                </div>
            `).join('');
        }

        // í¸ì§€ ë‹¬ë ¥ ë Œë”ë§
        function renderLetterCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('letterCalendarMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;

            const calendarGrid = document.getElementById('letterCalendarGrid');
            calendarGrid.innerHTML = '';

            const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header-routine'; // mood-routine ìŠ¤íƒ€ì¼ ì¬í™œìš©
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date();

            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                const dateKey = cellDate.toISOString().split('T')[0]; // 'YYYY-MM-DD' í˜•ì‹

                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day'; // mood-routine ìŠ¤íƒ€ì¼ ì¬í™œìš©

                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month'); // mood-routine ìŠ¤íƒ€ì¼ ì¬í™œìš©
                } else {
                    // í•´ë‹¹ ë‚ ì§œì— í¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
                    if (allLettersData[dateKey] && allLettersData[dateKey].length > 0) {
                        dayCell.classList.add('has-record'); // í¸ì§€ ê¸°ë¡ ìˆëŠ” ë‚ ì§œ í´ë˜ìŠ¤ ì¶”ê°€
                        // í¸ì§€ ì•„ì´ì½˜ ì¶”ê°€
                        dayCell.innerHTML += `<span style="position:absolute; bottom:5px; right:5px; font-size:1.2em;">ğŸ’Œ</span>`;
                        // ë‚ ì§œ í´ë¦­ ì‹œ í•´ë‹¹ ë‚ ì§œ í¸ì§€ ëª¨ë‹¬ ì—´ê¸°
                        dayCell.addEventListener('click', () => openLettersForDateModal(dateKey));
                    } else {
                         // í¸ì§€ ì—†ëŠ” ë‚ ì§œë„ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ í•˜ë ¤ë©´ ì—¬ê¸°ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                         // dayCell.addEventListener('click', () => openLettersForDateModal(dateKey)); // ë¹ˆ ëª¨ë‹¬ ì—´ê¸°
                    }
                }
                 if (cellDate.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today'); // mood-routine ìŠ¤íƒ€ì¼ ì¬í™œìš©
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number'; // mood-routine ìŠ¤íƒ€ì¼ ì¬í™œìš©
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                calendarGrid.appendChild(dayCell);
            }
        }

        // í¸ì§€ ë‹¬ë ¥ ì›” ë³€ê²½
        function changeLetterCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderLetterCalendar();
        }
        
        // ë‚ ì§œ ë¬¸ìì—´ í¬ë§·íŒ… (ì˜ˆ: "ì˜¤ëŠ˜", "ì–´ì œ", "YYYYë…„ MMì›” DDì¼")
        function formatLetterDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0 && date.toDateString() === now.toDateString()) {
                 return 'ì˜¤ëŠ˜';
            } else if (diffDays === 1 && new Date(now).setDate(now.getDate() - 1) === date.setDate(date.getDate())) {
                 return 'ì–´ì œ';
            } else if (diffDays <= 7) {
                return `${diffDays}ì¼ ì „`;
            } else {
                return `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
            }
        }
        
        // ìµœê·¼ í¸ì§€ ëª©ë¡ì—ì„œ í¸ì§€ í´ë¦­ ì‹œ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
        function openLetterModal(letterId) {
            // ëª¨ë“  í¸ì§€ ë°ì´í„°ì—ì„œ IDë¡œ ê²€ìƒ‰
            const letter = Object.values(allLettersData).flat().find(l => l.id === letterId);
            if (!letter) return;
            
            currentLetterId = letter.id; // í˜„ì¬ ë³´ê³  ìˆëŠ” í¸ì§€ ID ì €ì¥
            document.getElementById('letterModalDate').textContent = 
                formatLetterDate(letter.date) + 'ì— ì‘ì„±í•œ í¸ì§€';
            document.getElementById('letterModalContent').textContent = letter.content;
            document.getElementById('letterModal').style.display = 'block';
        }
        
        // ë‚ ì§œë³„ í¸ì§€ ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
        function openLettersForDateModal(dateKey) {
            const lettersOnDate = allLettersData[dateKey] || [];
            const modalTitle = document.getElementById('lettersForDateModalTitle');
            const modalBody = document.getElementById('lettersForDateModalBody');

            const dateObj = new Date(dateKey + 'T00:00:00'); // Ensure correct date parsing
            modalTitle.textContent = `${dateObj.getFullYear()}ë…„ ${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼ì˜ í¸ì§€`;

            if (lettersOnDate.length === 0) {
                modalBody.innerHTML = '<p>í•´ë‹¹ ë‚ ì§œì— ì‘ì„±ëœ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                // í•´ë‹¹ ë‚ ì§œì˜ í¸ì§€ë¥¼ ì‹œê°„ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                lettersOnDate.sort((a, b) => new Date(b.date) - new Date(a.date));

                modalBody.innerHTML = lettersOnDate.map(letter => `
                    <div class="letter-card" style="cursor:default; margin-bottom:1rem;">
                        <div class="letter-meta">
                            <span><i class="fas fa-clock"></i> ${new Date(letter.date).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</span>
                            <span><i class="fas fa-file-alt"></i> ${letter.content.length}ì</span>
                        </div>
                        <div style="white-space: pre-wrap; margin-top:0.5rem;">${letter.content}</div>
                         <button class="btn-outline btn-sm mt-2" onclick="deleteSpecificLetter('${letter.id}', '${dateKey}')">ì´ í¸ì§€ ì‚­ì œ</button>
                    </div>
                `).join('');
            }
            document.getElementById('lettersForDateModal').style.display = 'block';
        }

        // ë‚ ì§œë³„ í¸ì§€ ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
        function closeLettersForDateModal() {
            document.getElementById('lettersForDateModal').style.display = 'none';
        }

        // í¸ì§€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
        function closeLetterModal() {
            document.getElementById('letterModal').style.display = 'none';
            currentLetterId = null;
        }
        
        // í¸ì§€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ì—ì„œ í˜„ì¬ í¸ì§€ ì‚­ì œ
        async function deleteLetter() {
            if (!currentLetterId) return;
            
            if (confirm('ì´ í¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // allLettersDataì—ì„œ ì‚­ì œ
                let dateKeyToDelete = null;
                Object.keys(allLettersData).forEach(dateKey => {
                    const initialLength = allLettersData[dateKey].length;
                    allLettersData[dateKey] = allLettersData[dateKey].filter(l => l.id !== currentLetterId);
                    if (allLettersData[dateKey].length < initialLength) {
                        dateKeyToDelete = dateKey; // ì‚­ì œëœ í¸ì§€ê°€ ì†í•œ ë‚ ì§œ í‚¤
                    }
                     if (allLettersData[dateKey].length === 0) {
                        delete allLettersData[dateKey]; // í•´ë‹¹ ë‚ ì§œì— í¸ì§€ê°€ ì—†ìœ¼ë©´ ë‚ ì§œ í‚¤ ì‚­ì œ
                    }
                });

                saveToLocalStorage('allEmotionLettersData', allLettersData);

                // Firebaseì—ì„œë„ ì‚­ì œ (ë¡œê·¸ì¸ëœ ê²½ìš°)
                if (currentUser) {
                    try {
                         await db.collection('emotionLetters').doc(currentLetterId).delete(); // ê°œë³„ í¸ì§€ ë¬¸ì„œ ì‚­ì œ
                    } catch (error) { console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', error); }
                }

                updateRecentLettersList(); // ìµœê·¼ í¸ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
                renderRecentLetters(); // ìµœê·¼ í¸ì§€ ëª©ë¡ ë Œë”ë§
                renderLetterCalendar(); // ë‹¬ë ¥ ì—…ë°ì´íŠ¸ (ì•„ì´ì½˜ ì‚¬ë¼ì§)
                closeLetterModal(); // ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
                showMessage('í¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // ë‚ ì§œë³„ í¸ì§€ ë³´ê¸° ëª¨ë‹¬ì—ì„œ íŠ¹ì • í¸ì§€ ì‚­ì œ
        async function deleteSpecificLetter(letterId, dateKey) {
             if (confirm('ì´ í¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (allLettersData[dateKey]) {
                    allLettersData[dateKey] = allLettersData[dateKey].filter(l => l.id !== letterId);
                    if (allLettersData[dateKey].length === 0) {
                        delete allLettersData[dateKey]; // í•´ë‹¹ ë‚ ì§œì— í¸ì§€ê°€ ì—†ìœ¼ë©´ ë‚ ì§œ í‚¤ ì‚­ì œ
                    }
                }
                saveToLocalStorage('allEmotionLettersData', allLettersData);

                // Firebaseì—ì„œë„ ì‚­ì œ (ë¡œê·¸ì¸ëœ ê²½ìš°)
                if (currentUser) {
                     try {
                         await db.collection('emotionLetters').doc(letterId).delete(); // ê°œë³„ í¸ì§€ ë¬¸ì„œ ì‚­ì œ
                     } catch (error) { console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', error); }
                }

                updateRecentLettersList(); // ìµœê·¼ í¸ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
                renderRecentLetters(); // ìµœê·¼ í¸ì§€ ëª©ë¡ ë Œë”ë§
                renderLetterCalendar(); // ë‹¬ë ¥ ì—…ë°ì´íŠ¸ (ì•„ì´ì½˜ ì‚¬ë¼ì§)
                closeLettersForDateModal(); // ë‚ ì§œë³„ í¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
                showMessage('í¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        // ëª¨ë“  í¸ì§€ ì‚­ì œ
        async function deleteAllLetters() {
            // ëª¨ë“  í¸ì§€ ìˆ˜ë¥¼ í•©ì‚°í•˜ì—¬ í™•ì¸
            const totalLettersCount = Object.values(allLettersData).flat().length;

            if (totalLettersCount === 0) {
                showMessage('ì‚­ì œí•  í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                return;
            }
            
            if (confirm(`ëª¨ë“  í¸ì§€ ${totalLettersCount}ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                recentLetters = []; // ìµœê·¼ í¸ì§€ ëª©ë¡ ë¹„ìš°ê¸°
                allLettersData = {}; // ëª¨ë“  í¸ì§€ ë°ì´í„° ë¹„ìš°ê¸°
                saveToLocalStorage('allEmotionLettersData', allLettersData); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸

                // Firebaseì—ì„œë„ ëª¨ë“  í¸ì§€ ì‚­ì œ (ì£¼ì˜: ëŒ€ëŸ‰ ì‚­ì œ ì‹œ ì„±ëŠ¥ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥)
                // ì‹¤ì œ ì•±ì—ì„œëŠ” ì„œë²„ ì¸¡ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
                if (currentUser) {
                    try {
                        const snapshot = await db.collection('emotionLetters').where('userId', '==', currentUser.uid).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    } catch (error) { console.error('Firebase ì „ì²´ ì‚­ì œ ì‹¤íŒ¨:', error); }
                }

                renderRecentLetters(); // ìµœê·¼ í¸ì§€ ëª©ë¡ ë Œë”ë§
                renderLetterCalendar(); // ë‹¬ë ¥ ì—…ë°ì´íŠ¸
                showMessage('ëª¨ë“  í¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', function(event) {
            const letterModal = document.getElementById('letterModal');
            if (event.target === letterModal) {
                closeLetterModal();
            }
            const lettersForDateModal = document.getElementById('lettersForDateModal');
            if (event.target === lettersForDateModal) {
                closeLettersForDateModal();
            }
        });
        
    </script>
</body>
</html>
