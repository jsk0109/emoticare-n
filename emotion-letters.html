<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>감정 편지 - EmotiCare</title>
    <link rel="stylesheet" href="styles.css?v=20240701a">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* .letters-container 패딩은 .page-inner-container 로 대체 */
        
        .write-section {
            /* .content-block 으로 대체 */
            margin-bottom: 2rem; /* content-block 기본 마진 외 추가 마진 필요시 */
        }
        
        .guidelines {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 1.5rem; /* 마진 축소 */
        }
        
        .guidelines h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .guidelines ul {
            list-style: none;
            padding: 0;
        }
        
        .guidelines li {
            margin-bottom: 0.8rem;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .guidelines li::before {
            content: '✨';
            position: absolute;
            left: 0;
        }
        
        .letter-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .letter-textarea {
            min-height: 300px;
            padding: 1rem; /* 패딩 축소 */
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
            /* transition은 styles.css의 .form-input 등에서 이미 처리 */
        }
        
        .letter-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .letter-actions {
            display: flex;
            gap: 1rem;
            justify-content: center; /* 가운데 정렬 */
        }
        
        .recent-letters {
            /* .content-block 으로 대체 */
            margin-bottom: 2rem; /* content-block 기본 마진 외 추가 마진 필요시 */
        }
        
        .letters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .letters-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .letter-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 1rem; /* 패딩 축소 */
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .letter-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        
        .letter-meta {
            display: flex;
            justify-content: space-between;
            align-items: center; 
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .letter-preview {
            color: #333;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .char-counter {
            text-align: right;
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .delete-all-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .delete-all-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        /* 편지 달력 섹션 스타일 (mood-routine.html 스타일 재활용 및 추가) */
        .letter-calendar-section {
            /* .content-block 또는 .calendar-block 으로 대체 */
            margin-top: 2rem; /* 상단 마진 조정 */
        }

        .calendar-day.has-record { /* 편지 기록 있는 날짜 표시 */
            border: 2px solid #764ba2; /* 테두리 색상 */
        }
        .calendar-day.has-record span { /* 편지 아이콘 스타일 */
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 1em; /* 아이콘 크기 조정 */
            z-index: 2;
        }

        /* 날짜별 편지 보기 모달 스타일 */
        #lettersForDateModal .modal-content {
            max-width: 600px; /* 모달 너비 조정 */
        }
        #lettersForDateModal .letter-card {
            cursor: default; /* 모달 내 카드 클릭 비활성화 */
            margin-bottom: 1rem;
        }
        #lettersForDateModal .letter-card .btn-outline {
            padding: 0.4rem 0.8rem; /* 버튼 패딩 축소 */
            font-size: 0.85rem; /* 버튼 폰트 크기 축소 */
        }

        @media (max-width: 768px) {
            .guidelines { padding: 1.5rem; }
            .guidelines h3 { font-size: 1.1rem; }
            .guidelines li { font-size: 0.9rem; margin-bottom: 0.6rem; padding-left: 1.2rem;}
            .letter-textarea { padding: 0.8rem; min-height: 200px; }
            .letter-card { padding: 0.8rem; }
            .letter-meta { font-size: 0.8rem; margin-bottom: 0.5rem;}
            .letter-preview { font-size: 0.9rem; -webkit-line-clamp: 2; }
            .delete-all-btn { padding: 0.6rem 1rem; font-size: 0.9rem; }
            .letters-header h3 { font-size: 1.2rem; }
        }

        /* 모달 내 수정/삭제 버튼 간격 */
        #letterModal .modal-body .btn-outline + .btn-danger,
        #letterModal .modal-body .btn-danger + .btn-outline {
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">감정 편지</h1>
                <p class="page-subtitle">자신에게 보내는 편지로 마음속 깊은 감정을 표현해보세요</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="page-inner-container letters-container">
                <div class="content-block write-section">
                    <div class="guidelines">
                        <h3><i class="fas fa-lightbulb"></i> 감정 편지 작성 가이드</h3>
                        <ul>
                            <li>지금 느끼고 있는 감정을 솔직하게 표현해보세요</li>
                            <li>자신에게 따뜻한 말을 건네보세요</li>
                            <li>오늘 하루도 수고한 자신을 격려해주세요</li>
                            <li>미래의 자신에게 응원의 메시지를 남겨보세요</li>
                            <li>완벽하지 않아도 괜찮습니다. 마음이 가는 대로 써보세요</li>
                            <li>작성이 완료된 편지는 아래 달력에 날짜별로 저장됩니다</li>
                        </ul>
                    </div>
                    
                    <form class="letter-form" onsubmit="saveLetter(event)">
                        <textarea 
                            id="letterContent" 
                            class="letter-textarea" 
                            placeholder="친애하는 나에게,

오늘 하루는 어떠셨나요? 지금 마음속에 있는 이야기를 들려주세요..."
                            oninput="updateCharCounter()"
                        ></textarea>
                        <div class="char-counter" id="charCounter">0자</div>
                        
                        <div class="letter-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-pen-alt"></i> 작성 완료
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="content-block recent-letters">
                    <div class="letters-header">
                        <h3>최근 작성한 편지</h3>
                        <button class="delete-all-btn" onclick="deleteAllLetters()">
                            <i class="fas fa-trash"></i> 모든 편지 삭제
                        </button>
                    </div>
                    
                    <div class="letters-list" id="recentLettersList">
                        <!-- 최근 편지 목록이 여기에 생성됩니다 -->
                    </div>
                </div>

                <!-- 편지 달력 섹션 추가 -->
                <div class="content-block letter-calendar-section">
                    <div class="letters-header">
                        <h3>편지 달력</h3>
                    </div>
                    <div class="calendar-block-header" style="margin-bottom: 1rem;">
                        <div class="calendar-block-nav">
                            <button onclick="changeLetterCalendarMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span class="calendar-block-title" id="letterCalendarMonth"></span>
                            <button onclick="changeLetterCalendarMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-block">
                        <div class="calendar-grid-common">
                        </div>
                        <div class="calendar-grid-common" id="letterCalendarGrid">
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- 편지 상세보기 모달 -->
    <div id="letterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="letterModalDate">편지 보기</h3>
                <button class="modal-close" onclick="closeLetterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="letterModalContent" style="line-height: 1.8; white-space: pre-wrap;"></div>
                <div class="mt-3" style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                    <button class="btn-outline" onclick="startEditCurrentLetter()">
                        <i class="fas fa-edit"></i> 수정하기
                    </button>
                    <button class="btn-outline btn-danger" onclick="deleteLetter()">
                        <i class="fas fa-trash"></i> 삭제하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 날짜별 편지 보기 모달 -->
    <div id="lettersForDateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="lettersForDateModalTitle"></h3>
                <button class="modal-close" onclick="closeLettersForDateModal()">&times;</button>
            </div>
            <div class="modal-body" id="lettersForDateModalBody">
            </div>
        </div>
    </div>
    
    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let recentLetters = []; 
        let allLettersData = {}; 
        let currentLetterId = null; 
        let editingLetterId = null; // 수정 중인 편지 ID
        let currentCalendarDate = new Date(); 
        
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('authStateReady', async function(e) {
                currentUser = e.detail.user; 
                console.log('emotion-letters.html: authStateReady event. User:', currentUser ? currentUser.uid : 'No user');
                allLettersData = {}; 
                editingLetterId = null; // 로그아웃/로그인 시 수정 상태 초기화
                if (e.detail.user) {
                    console.log('emotion-letters.html: User detected, calling loadAllLetters.');
                    await loadAllLetters();
                } else {
                    loadAllLetters(); 
                    showMessage("로그인 후 이용하시면 편지 데이터가 안전하게 보관됩니다.", "info");
                }
                updateRecentLettersList(); 
                renderRecentLetters(); 
                renderLetterCalendar(); 
            });

            const draft = localStorage.getItem('letterDraft');
            if (draft) {
                document.getElementById('letterContent').value = draft;
                updateCharCounter();
            }
            let autoSaveTimer;
            document.getElementById('letterContent').addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    const content = this.value.trim();
                    if (content) {
                        localStorage.setItem('letterDraft', content);
                    } else {
                         localStorage.removeItem('letterDraft');
                    }
                }, 2000); 
            });
        });
        
        function updateCharCounter() {
            const content = document.getElementById('letterContent').value;
            const counter = document.getElementById('charCounter');
            counter.textContent = `${content.length}자`;
            
            if (content.length > 1000) { 
                counter.style.color = '#ff6b6b';
            } else {
                counter.style.color = '#666';
            }
        }
        
        async function saveLetter(event) {
            event.preventDefault();
            
            const letterContentElement = document.getElementById('letterContent');
            const content = letterContentElement.value.trim();
            const saveButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = saveButton.innerHTML;

            if (!content) {
                showMessage('편지 내용을 입력해주세요.', 'error');
                return;
            }
             if (content.length > 1000) {
                 showMessage('편지 내용은 1000자를 초과할 수 없습니다.', 'error');
                 return;
             }

            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 저장 중...';

            if (editingLetterId) { // 수정 모드
                let letterToUpdate = null;
                let originalDateKey = null;

                Object.keys(allLettersData).forEach(dateKey => {
                    const foundLetter = allLettersData[dateKey].find(l => l.id === editingLetterId);
                    if (foundLetter) {
                        letterToUpdate = foundLetter;
                        originalDateKey = dateKey;
                    }
                });

                if (letterToUpdate) {
                    letterToUpdate.content = content;
                    letterToUpdate.preview = content.substring(0, 100) + (content.length > 100 ? '...' : '');
                    
                    if (currentUser) {
                        try {
                            await db.collection(컬렉션_이름_맵.감정편지).doc(editingLetterId).update({
                                content: content,
                                preview: letterToUpdate.preview,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            showMessage('편지가 수정되었습니다.', 'success');
                        } catch (error) {
                            console.error("Firebase 편지 수정 실패:", error);
                            showMessage('편지 수정에 실패했습니다.', 'error');
                        }
                    } else {
                         showMessage('편지가 로컬에서 수정되었습니다. (로그인 시 동기화)', 'info');
                    }
                    saveToLocalStorage('allEmotionLettersData', allLettersData);
                } else {
                    showMessage('수정할 편지를 찾지 못했습니다.', 'error');
                }
                editingLetterId = null; 

            } else { // 새 편지 저장 모드
                const now = new Date(); // 사용자의 현재 로컬 시간
                const localDateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const utcTimestamp = now.toISOString();

                const letter = {
                    id: Date.now().toString(),
                    content: content,
                    date: utcTimestamp, 
                    displayDate: localDateString, 
                    preview: content.substring(0, 100) + (content.length > 100 ? '...' : '')
                };
                const dateKey = letter.displayDate; 
                if (!allLettersData[dateKey]) allLettersData[dateKey] = [];
                allLettersData[dateKey].unshift(letter);
                saveToLocalStorage('allEmotionLettersData', allLettersData);
                if (currentUser) {
                    try {
                        await saveToFirestore(컬렉션_이름_맵.감정편지, letter.id, { 
                            content: letter.content,
                            date: letter.date, 
                            displayDate: letter.displayDate, 
                            preview: letter.preview,
                            userId: currentUser.uid 
                        });
                        showMessage('편지가 저장되었습니다.', 'success');
                    } catch (error) {
                        console.error("Firebase 편지 저장 실패:", error);
                        showMessage('편지 저장에 실패했습니다. (서버 오류)', 'error');
                    }
                } else {
                    showMessage('편지가 로컬에 저장되었습니다. 로그인하면 동기화됩니다.', 'info');
                }
            }

            updateRecentLettersList();
            renderRecentLetters();
            clearLetter(); 
            renderLetterCalendar();
            localStorage.removeItem('letterDraft');
            saveButton.disabled = false;
        }
        
        function clearLetter() {
            document.getElementById('letterContent').value = '';
            updateCharCounter();
            editingLetterId = null; 
            const saveButton = document.querySelector('.letter-form button[type="submit"]');
            if (saveButton) {
                saveButton.innerHTML = '<i class="fas fa-pen-alt"></i> 작성 완료';
            }
        }
        
        async function loadAllLetters() {
            console.log('loadAllLetters: currentUser in loadAllLetters:', currentUser ? currentUser.uid : 'No user');
            if (currentUser) {
                try {
                    console.log(`loadAllLetters: Fetching letters from Firebase for user ${currentUser.uid}`);
                    const snapshot = await db.collection(컬렉션_이름_맵.감정편지)
                                           .where('userId', '==', currentUser.uid)
                                           .orderBy('date', 'desc') 
                                           .get();
                    
                    const firebaseData = {};
                    snapshot.forEach(doc => {
                        const letterData = doc.data();
                        const dateKey = letterData.displayDate || letterData.date.split('T')[0]; 
                        if (!firebaseData[dateKey]) {
                            firebaseData[dateKey] = [];
                        }
                        firebaseData[dateKey].push({ id: doc.id, ...letterData });
                    });
                    console.log('loadAllLetters: Fetched', snapshot.size, 'letters from Firebase. Processed data:', firebaseData);
                    allLettersData = firebaseData; 
                    saveToLocalStorage('allEmotionLettersData', allLettersData); 
                } catch (error) {
                    console.error("Firebase 모든 편지 로드 실패:", error);
                    showMessage("편지 목록을 불러오는 데 실패했습니다.", "error");
                    allLettersData = {}; 
                }
            } else {
                console.log('loadAllLetters: No user, loading from LocalStorage.');
                const localData = loadFromLocalStorage('allEmotionLettersData');
                allLettersData = localData || {};
            }
        }

        function updateRecentLettersList() {
            const flatLetters = Object.values(allLettersData).flat(); 
            flatLetters.sort((a, b) => new Date(b.date) - new Date(a.date));
            recentLetters = flatLetters.slice(0, 3);
        }

        function mergeLetterArrays(arr1, arr2) {
            const map = new Map(arr1.map(item => [item.id, item]));
            arr2.forEach(item => map.set(item.id, item));
            return Array.from(map.values()).sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        
        function renderRecentLetters() {
            const lettersList = document.getElementById('recentLettersList'); 
            
            if (recentLetters.length === 0) {
                lettersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-envelope-open"></i>
                        <p>아직 작성한 편지가 없습니다.<br>첫 번째 편지를 작성해보세요!</p>
                    </div>
                `;
                return;
            }
            
            lettersList.innerHTML = recentLetters.map(letter => `
                <div class="letter-card" onclick="openLetterModal('${letter.id}')">
                    <div class="letter-meta">
                        <span><i class="fas fa-calendar"></i> ${formatLetterDate(letter.date)}</span>
                        <span><i class="fas fa-file-alt"></i> ${letter.content.length}자</span>
                    </div>
                    <div class="letter-preview">${letter.preview}</div>
                </div>
            `).join('');
        }

        function renderLetterCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('letterCalendarMonth').textContent = `${year}년 ${month + 1}월`;

            const calendarGrid = document.getElementById('letterCalendarGrid');
            calendarGrid.innerHTML = '';

            const dayHeaderGrid = calendarGrid.previousElementSibling;
            const dayHeaders = ['일', '월', '화', '수', '목', '금', '토'];
            if (dayHeaderGrid.innerHTML.trim() === '') {
                dayHeaders.forEach(day => {
                    const dayHeaderCell = document.createElement('div');
                    dayHeaderCell.className = 'calendar-day-name-common';
                    dayHeaderCell.textContent = day;
                    dayHeaderGrid.appendChild(dayHeaderCell);
                });
            }

            const firstDayOfMonth = new Date(year, month, 1);
            const startDate = new Date(firstDayOfMonth);
            startDate.setDate(startDate.getDate() - firstDayOfMonth.getDay()); 

            const today = new Date();

            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dataAccessKey = `${cellDate.getFullYear()}-${String(cellDate.getMonth() + 1).padStart(2, '0')}-${String(cellDate.getDate()).padStart(2, '0')}`;

                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day-cell-common calendar-day'; 

                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month');
                } else {
                    // ★★★ 디버깅 로그 추가 (이벤트 리스너 추가 직전) ★★★
                    console.log(`Attaching click listener to day: ${dataAccessKey}`);
                    if (allLettersData[dataAccessKey] && allLettersData[dataAccessKey].length > 0) {
                        dayCell.classList.add('has-record');
                        dayCell.innerHTML += `<span style="position:absolute; bottom:5px; right:5px; font-size:1.2em;">💌</span>`;
                        dayCell.addEventListener('click', () => {
                            // ★★★ 디버깅 로그 추가 (이벤트 발생 시) ★★★
                            console.log(`Calendar day (WITH records) clicked: ${dataAccessKey}, cellDate: ${cellDate.toDateString()}`);
                            openLettersForDateModal(dataAccessKey, cellDate);
                        });
                    } else {
                         dayCell.addEventListener('click', () => {
                            // ★★★ 디버깅 로그 추가 (이벤트 발생 시) ★★★
                            console.log(`Calendar day (NO records) clicked: ${dataAccessKey}, cellDate: ${cellDate.toDateString()}`);
                            openLettersForDateModal(dataAccessKey, cellDate);
                         }); 
                    }
                }
                 if (cellDate.getFullYear() === today.getFullYear() &&
                     cellDate.getMonth() === today.getMonth() &&
                     cellDate.getDate() === today.getDate()) {
                    dayCell.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                calendarGrid.appendChild(dayCell);
            }
        }

        function changeLetterCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderLetterCalendar();
        }
        
        function formatLetterDate(dateString) { 
            const date = new Date(dateString); 
            const now = new Date();
            const todayForCompare = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const letterDateForCompare = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const diffInMilliseconds = todayForCompare.getTime() - letterDateForCompare.getTime();
            const diffInDays = diffInMilliseconds / (1000 * 60 * 60 * 24);
            
            if (diffInDays === 0) return '오늘';
            if (diffInDays === 1) return '어제';
            if (diffInDays > 1 && diffInDays <= 7) return `${Math.floor(diffInDays)}일 전`;
            return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
        }
        
        function openLetterModal(letterId) {
            const letter = Object.values(allLettersData).flat().find(l => l.id === letterId);
            if (!letter) return;
            
            currentLetterId = letter.id; 
            document.getElementById('letterModalDate').textContent = 
                formatLetterDate(letter.date) + ' 작성한 편지';
            document.getElementById('letterModalContent').textContent = letter.content;
            document.getElementById('letterModal').style.display = 'block';
        }
        
        function openLettersForDateModal(dataAccessKey, localCellDate) {
            // ★★★ 디버깅 로그 추가 (함수 호출 시) ★★★
            console.log(`openLettersForDateModal called. dataAccessKey: ${dataAccessKey}, localCellDate: ${localCellDate.toDateString()}`);
            
            const lettersOnDate = allLettersData[dataAccessKey] || [];
            const modalTitle = document.getElementById('lettersForDateModalTitle');
            const modalBody = document.getElementById('lettersForDateModalBody');
            const modal = document.getElementById('lettersForDateModal');

            if (!modal || !modalTitle || !modalBody) {
                console.error("날짜별 편지 보기 모달 또는 내부 요소를 찾을 수 없습니다.");
                showMessage("편지 보기 창을 여는 데 필요한 구성 요소를 찾을 수 없습니다.", "error");
                return;
            }
            
            modalTitle.textContent = `${localCellDate.getFullYear()}년 ${localCellDate.getMonth() + 1}월 ${localCellDate.getDate()}일의 편지`;

            if (lettersOnDate.length === 0) {
                modalBody.innerHTML = '<p>해당 날짜에 작성된 편지가 없습니다.</p>';
            } else {
                lettersOnDate.sort((a, b) => new Date(b.date) - new Date(a.date));
                modalBody.innerHTML = lettersOnDate.map(letter => `
                    <div class="letter-card" style="cursor:default; margin-bottom:1rem;">
                        <div class="letter-meta">
                            <span><i class="fas fa-clock"></i> ${new Date(letter.date).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</span>
                            <span><i class="fas fa-file-alt"></i> ${letter.content.length}자</span>
                        </div>
                        <div style="white-space: pre-wrap; margin-top:0.5rem;">${letter.content}</div>
                         <button class="btn-outline btn-sm mt-2" onclick="deleteSpecificLetter('${letter.id}', '${dataAccessKey}')">이 편지 삭제</button>
                    </div>
                `).join('');
            }
            // ★★★ 디버깅 로그 추가 (모달 표시 직전) ★★★
            console.log('Attempting to display lettersForDateModal. Current display:', modal.style.display);
            modal.style.display = 'block';
            console.log('lettersForDateModal display style set to "block". New display:', modal.style.display);
        }

        function closeLettersForDateModal() {
            const modal = document.getElementById('lettersForDateModal');
            if (modal) modal.style.display = 'none';
        }

        function closeLetterModal() {
            const modal = document.getElementById('letterModal');
            if (modal) modal.style.display = 'none';
            currentLetterId = null;
        }
        
        async function deleteLetter() {
            if (!currentLetterId) return;
            
            if (confirm('이 편지를 삭제하시겠습니까?')) {
                let dateKeyToDeleteFrom = null;
                Object.keys(allLettersData).forEach(dateKey => {
                    const initialLength = allLettersData[dateKey].length;
                    allLettersData[dateKey] = allLettersData[dateKey].filter(l => l.id !== currentLetterId);
                    if (allLettersData[dateKey].length < initialLength) {
                        dateKeyToDeleteFrom = dateKey; 
                    }
                     if (allLettersData[dateKey].length === 0) {
                        delete allLettersData[dateKey]; 
                    }
                });

                saveToLocalStorage('allEmotionLettersData', allLettersData);

                if (currentUser) {
                    try {
                         await db.collection(컬렉션_이름_맵.감정편지).doc(currentLetterId).delete(); 
                    } catch (error) { console.error('Firebase 삭제 실패:', error); }
                }

                updateRecentLettersList(); 
                renderRecentLetters(); 
                renderLetterCalendar(); 
                closeLetterModal(); 
                showMessage('편지가 삭제되었습니다.', 'success');
            }
        }

        async function deleteSpecificLetter(letterId, dataAccessKey) {
             if (confirm('이 편지를 삭제하시겠습니까?')) {
                if (allLettersData[dataAccessKey]) {
                    allLettersData[dataAccessKey] = allLettersData[dataAccessKey].filter(l => l.id !== letterId);
                    if (allLettersData[dataAccessKey].length === 0) {
                        delete allLettersData[dataAccessKey]; 
                    }
                }
                saveToLocalStorage('allEmotionLettersData', allLettersData);

                if (currentUser) {
                     try {
                         await db.collection(컬렉션_이름_맵.감정편지).doc(letterId).delete(); 
                     } catch (error) { console.error('Firebase 삭제 실패:', error); }
                }

                updateRecentLettersList(); 
                renderRecentLetters(); 
                renderLetterCalendar(); 
                closeLettersForDateModal(); 
                showMessage('편지가 삭제되었습니다.', 'success');
            }
        }
        
        async function deleteAllLetters() {
            const totalLettersCount = Object.values(allLettersData).flat().length;

            if (totalLettersCount === 0) {
                showMessage('삭제할 편지가 없습니다.', 'info');
                return;
            }
            
            if (confirm(`모든 편지 ${totalLettersCount}개를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
                recentLetters = []; 
                allLettersData = {}; 
                saveToLocalStorage('allEmotionLettersData', allLettersData); 

                if (currentUser) {
                    try {
                        const snapshot = await db.collection(컬렉션_이름_맵.감정편지).where('userId', '==', currentUser.uid).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    } catch (error) { console.error('Firebase 전체 삭제 실패:', error); }
                }

                renderRecentLetters(); 
                renderLetterCalendar(); 
                showMessage('모든 편지가 삭제되었습니다.', 'success');
            }
        }

        function startEditCurrentLetter() {
            if (!currentLetterId) return;

            let letterToEdit = null;
            Object.values(allLettersData).flat().forEach(letter => {
                if (letter.id === currentLetterId) {
                    letterToEdit = letter;
                }
            });

            if (letterToEdit) {
                editingLetterId = currentLetterId; 
                document.getElementById('letterContent').value = letterToEdit.content;
                updateCharCounter();
                document.querySelector('.letter-form button[type="submit"]').innerHTML = '<i class="fas fa-check"></i> 수정 완료';
                closeLetterModal(); 
                document.getElementById('letterContent').focus(); 
                window.scrollTo({ top: document.querySelector('.write-section').offsetTop, behavior: 'smooth' });
            } else {
                showMessage('수정할 편지를 찾지 못했습니다.', 'error');
            }
        }
        
        window.addEventListener('click', function(event) {
            const letterModal = document.getElementById('letterModal');
            if (event.target === letterModal) {
                closeLetterModal();
            }
            const lettersForDateModal = document.getElementById('lettersForDateModal');
            if (event.target === lettersForDateModal) {
                closeLettersForDateModal();
            }
        });
        
    </script>
</body>
</html>
