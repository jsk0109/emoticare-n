<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ë£¨ ê¸°ë¶„ ê¸°ë¡ - EmotiCare</title>
    <link rel="stylesheet" href="styles.css?v=20240701a">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* .routine-container íŒ¨ë”©ì€ .page-inner-container ë¡œ ëŒ€ì²´ */
        
        .calendar-header-routine {
            /* .calendar-block-header ë¡œ ëŒ€ì²´ë˜ê±°ë‚˜ ìœ ì‚¬ ìŠ¤íƒ€ì¼ ì ìš© */
            border-radius: 15px;
            padding: 1rem; /* íŒ¨ë”© ì¶•ì†Œ */
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .date-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
        }
        
        .date-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.6rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .date-nav button:hover {
            background: #764ba2;
            transform: scale(1.1);
        }
        
        .current-date-display {
            font-size: 1.3rem; /* í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
            font-weight: 600;
            color: #333;
        }

        .calendar-routine {
            /* .calendar-block ìœ¼ë¡œ ëŒ€ì²´ */
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        .calendar-day-header-routine {
            /* .calendar-day-name-common ìœ¼ë¡œ ëŒ€ì²´ */
        }
        .calendar-grid-routine .calendar-day {
            /* .calendar-day-cell-common ìœ¼ë¡œ ëŒ€ì²´ */
        }
        .calendar-grid-routine {
            /* .calendar-grid-common ìœ¼ë¡œ ëŒ€ì²´ */
        }
        
        .time-sections {
            display: grid;
            gap: 1.5rem; /* ê°„ê²© ì¶•ì†Œ */
            margin-bottom: 2rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .time-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .time-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .time-icon.morning {
            background: linear-gradient(135deg, #f9ca24, #f0932b);
        }
        
        .time-icon.afternoon {
            background: linear-gradient(135deg, #eb4d4b, #6c5ce7);
        }
        
        .time-icon.evening {
            background: linear-gradient(135deg, #6c5ce7, #2d3436);
        }
        
        .time-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }
        
        .mood-selector {
            display: flex;
            gap: 0.75rem; /* ê°„ê²© ì¶•ì†Œ */
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .mood-emoji {
            font-size: 2.5rem;
            padding: 0.6rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            background: #f8f9ff;
        }
        
        .mood-emoji:hover {
            transform: scale(1.1);
            background: #e8f0ff;
        }
        
        .mood-emoji.selected {
            border-color: #667eea;
            background: #667eea;
            transform: scale(1.1);
        }
        
        .thought-input {
            width: 100%;
            padding: 0.8rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        .thought-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .gratitude-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px; /* .content-block ê³¼ ìœ ì‚¬í•˜ê²Œ */
            padding: 1.5rem; /* íŒ¨ë”© ì¶•ì†Œ */
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .gratitude-header {
            text-align: center;
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .gratitude-header h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .gratitude-items {
            display: grid;
            gap: 0.75rem; /* ê°„ê²© ì¶•ì†Œ */
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .gratitude-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .gratitude-number {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .gratitude-input {
            flex: 1;
            padding: 0.7rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .gratitude-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .gratitude-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .gratitude-note {
            width: 100%;
            padding: 0.8rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
            min-height: 100px;
            resize: vertical;
        }
        
        .gratitude-note::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .save-section {
            text-align: center;
            margin-top: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .save-btn {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            color: #333;
            border: none;
            padding: 0.8rem 2.5rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(255, 234, 167, 0.4);
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 234, 167, 0.6);
        }
        
        .summary-card {
            /* .content-block ìœ¼ë¡œ ëŒ€ì²´ */
            margin-top: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .summary-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
            text-align: center;
        }
        
        .mood-summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
        }
        
        .mood-summary-item {
            text-align: center;
        }
        
        .mood-summary-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .mood-summary-label {
            font-size: 0.9rem;
            color: #666;
        }

        .calendar-day.selected-day {
            background-color: #e8f0ff !important;
            border: 2px solid #667eea !important;
            color: #333 !important;
        }
        .calendar-day.has-record {
            position: relative;
        }
        .calendar-day.has-record::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: #764ba2;
            border-radius: 50%;
        }
        .calendar-header-routine .btn-secondary {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .calendar-header-routine { padding: 0.8rem; margin-bottom: 1rem; }
            .date-nav { gap: 1rem; }
            .date-nav button { padding: 0.5rem; }
            .current-date-display { font-size: 1.1rem; }
            .time-section { padding: 1.25rem; } /* .content-block ê¸°ë³¸ íŒ¨ë”©ë³´ë‹¤ ì¡°ê¸ˆ ë” */
            .time-icon { width: 40px; height: 40px; font-size: 1.2rem; }
            .time-title { font-size: 1.1rem; }
            .mood-emoji { font-size: 2rem; padding: 0.5rem; }
            .thought-input { padding: 0.7rem; min-height: 60px; }
            .gratitude-section { padding: 1.25rem; }
            .gratitude-header h3 { font-size: 1.2rem; }
            .gratitude-input, .gratitude-note { padding: 0.7rem; }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">í•˜ë£¨ ê¸°ë¶„ ê¸°ë¡</h1>
                <p class="page-subtitle">ì‹œê°„ëŒ€ë³„ ê¸°ë¶„ì„ ê¸°ë¡í•˜ê³  ê°ì‚¬í•œ ì¼ë“¤ì„ ë˜ìƒˆê²¨ë³´ì„¸ìš”</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="page-inner-container routine-container">
                <div class="content-block calendar-header-routine">
                    <div class="date-nav">
                        <button onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
                        <span class="current-date-display" id="currentDateDisplay"></span>
                        <button onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div>
                        <button class="btn-secondary" onclick="goToToday()">ì˜¤ëŠ˜</button>
                    </div>
                </div>

                <div class="calendar-block" id="calendarView">
                    <div class="calendar-grid-common">
                        <!-- ìš”ì¼ í—¤ë” JSë¡œ ìƒì„± -->
                    </div>
                    <div class="calendar-grid-common" id="calendarGridRoutine">
                    </div>
                </div>
                
                <div class="time-sections">
                    <div class="content-block time-section">
                        <div class="time-header">
                            <div class="time-icon morning">
                                <i class="fas fa-sun"></i>
                            </div>
                            <div>
                                <div class="time-title">ì•„ì¹¨ (6:00 - 12:00)</div>
                                <div style="color: #666; font-size: 0.9rem;">í•˜ë£¨ë¥¼ ì‹œì‘í•˜ëŠ” ë§ˆìŒ</div>
                            </div>
                        </div>
                        
                        <div class="mood-selector" data-time="morning">
                            <div class="mood-emoji" data-mood="very-happy" title="ë§¤ìš° ê¸°ì¨">ğŸ˜„</div>
                            <div class="mood-emoji" data-mood="happy" title="ê¸°ì¨">ğŸ˜Š</div>
                            <div class="mood-emoji" data-mood="neutral" title="ë³´í†µ">ğŸ˜</div>
                            <div class="mood-emoji" data-mood="sad" title="ìŠ¬í””">ğŸ˜”</div>
                            <div class="mood-emoji" data-mood="very-sad" title="ë§¤ìš° ìŠ¬í””">ğŸ˜¢</div>
                        </div>
                        
                        <textarea 
                            class="thought-input" 
                            data-time="morning"
                            placeholder="ì•„ì¹¨ì— ì–´ë–¤ ìƒê°ì´ë‚˜ ê¸°ë¶„ì´ ë“œì…¨ë‚˜ìš”?"
                        ></textarea>
                    </div>
                    
                    <div class="content-block time-section">
                        <div class="time-header">
                            <div class="time-icon afternoon">
                                <i class="fas fa-cloud-sun"></i>
                            </div>
                            <div>
                                <div class="time-title">ì ì‹¬ (12:00 - 18:00)</div>
                                <div style="color: #666; font-size: 0.9rem;">í•˜ë£¨ ì¤‘ë°˜ì˜ ì—ë„ˆì§€</div>
                            </div>
                        </div>
                        
                        <div class="mood-selector" data-time="afternoon">
                            <div class="mood-emoji" data-mood="very-happy" title="ë§¤ìš° ê¸°ì¨">ğŸ˜„</div>
                            <div class="mood-emoji" data-mood="happy" title="ê¸°ì¨">ğŸ˜Š</div>
                            <div class="mood-emoji" data-mood="neutral" title="ë³´í†µ">ğŸ˜</div>
                            <div class="mood-emoji" data-mood="sad" title="ìŠ¬í””">ğŸ˜”</div>
                            <div class="mood-emoji" data-mood="very-sad" title="ë§¤ìš° ìŠ¬í””">ğŸ˜¢</div>
                        </div>
                        
                        <textarea 
                            class="thought-input" 
                            data-time="afternoon"
                            placeholder="ì ì‹¬ ì‹œê°„ ì´í›„ ê¸°ë¶„ì€ ì–´ë– ì…¨ë‚˜ìš”?"
                        ></textarea>
                    </div>
                    
                    <div class="content-block time-section">
                        <div class="time-header">
                            <div class="time-icon evening">
                                <i class="fas fa-moon"></i>
                            </div>
                            <div>
                                <div class="time-title">ì €ë… (18:00 - 24:00)</div>
                                <div style="color: #666; font-size: 0.9rem;">í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•˜ëŠ” ì‹œê°„</div>
                            </div>
                        </div>
                        
                        <div class="mood-selector" data-time="evening">
                            <div class="mood-emoji" data-mood="very-happy" title="ë§¤ìš° ê¸°ì¨">ğŸ˜„</div>
                            <div class="mood-emoji" data-mood="happy" title="ê¸°ì¨">ğŸ˜Š</div>
                            <div class="mood-emoji" data-mood="neutral" title="ë³´í†µ">ğŸ˜</div>
                            <div class="mood-emoji" data-mood="sad" title="ìŠ¬í””">ğŸ˜”</div>
                            <div class="mood-emoji" data-mood="very-sad" title="ë§¤ìš° ìŠ¬í””">ğŸ˜¢</div>
                        </div>
                        
                        <textarea 
                            class="thought-input" 
                            data-time="evening"
                            placeholder="í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•˜ë©° ì–´ë–¤ ê¸°ë¶„ì´ì‹ ê°€ìš”?"
                        ></textarea>
                    </div>
                </div>
                
                <div class="gratitude-section">
                    <div class="gratitude-header">
                        <h3><i class="fas fa-heart"></i> ì˜¤ëŠ˜ì˜ ê°ì‚¬í•œ ì¼ 3ê°€ì§€</h3>
                        <p>ì‘ì€ ê²ƒì´ë¼ë„ ê´œì°®ìŠµë‹ˆë‹¤. ê°ì‚¬í•œ ë§ˆìŒì„ í‘œí˜„í•´ë³´ì„¸ìš”.</p>
                    </div>
                    
                    <div class="gratitude-items">
                        <div class="gratitude-item">
                            <div class="gratitude-number">1</div>
                            <input type="text" class="gratitude-input" data-index="0" placeholder="ì²« ë²ˆì§¸ ê°ì‚¬í•œ ì¼">
                        </div>
                        <div class="gratitude-item">
                            <div class="gratitude-number">2</div>
                            <input type="text" class="gratitude-input" data-index="1" placeholder="ë‘ ë²ˆì§¸ ê°ì‚¬í•œ ì¼">
                        </div>
                        <div class="gratitude-item">
                            <div class="gratitude-number">3</div>
                            <input type="text" class="gratitude-input" data-index="2" placeholder="ì„¸ ë²ˆì§¸ ê°ì‚¬í•œ ì¼">
                        </div>
                    </div>
                    
                    <textarea 
                        class="gratitude-note" 
                        placeholder="ê°ì‚¬í•œ ë§ˆìŒì— ëŒ€í•´ ë” ìì„¸íˆ ì ì–´ë³´ì„¸ìš”..."
                    ></textarea>
                </div>
                
                <div class="save-section">
                    <button class="save-btn" onclick="saveMoodData()">
                        <i class="fas fa-save"></i> ì˜¤ëŠ˜ì˜ ê¸°ë¡ ì €ì¥í•˜ê¸°
                    </button>
                </div>
                
                <div class="content-block summary-card" id="summaryCard" style="display: none;">
                    <h3 class="summary-title">ì˜¤ëŠ˜ì˜ ê¸°ë¶„ ìš”ì•½</h3>
                    <div class="mood-summary" id="moodSummary">
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let currentDate = new Date();
        let moodData = {};
        
        const moodEmojis = {
            'very-happy': 'ğŸ˜„',
            'happy': 'ğŸ˜Š',
            'neutral': 'ğŸ˜',
            'sad': 'ğŸ˜”',
            'very-sad': 'ğŸ˜¢'
        };
        
        const moodLabels = {
            'very-happy': 'ë§¤ìš° ê¸°ì¨',
            'happy': 'ê¸°ì¨',
            'neutral': 'ë³´í†µ',
            'sad': 'ìŠ¬í””',
            'very-sad': 'ë§¤ìš° ìŠ¬í””'
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            setupMoodSelectors();

            document.addEventListener('authStateReady', async function(e) {
                currentUser = e.detail.user;
                moodData = {}; // â˜…â˜…â˜… ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ì‹œ ê¸°ë¶„ ë°ì´í„° ì´ˆê¸°í™”
                if (e.detail.user) {
                    await loadMoodData(); 
                } else {
                    const localData = loadFromLocalStorage('moodRoutineData');
                    if (localData) {
                        moodData = localData;
                    } else {
                        moodData = {};
                    }
                     showMessage("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹œë©´ ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.", "info");
                }
                renderCalendarRoutine();
                loadTodayData();
            });
        });
        
        function updateDateDisplay() {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDateDisplay').textContent = 
                currentDate.toLocaleDateString('ko-KR', options);
        }

        function renderCalendarRoutine() {
            updateDateDisplay();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const calendarGrid = document.getElementById('calendarGridRoutine');
            calendarGrid.innerHTML = '';
            
            const dayHeaderGrid = calendarGrid.previousElementSibling;
            const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            // ìš”ì¼ í—¤ë”ê°€ ë¹„ì–´ìˆì„ ë•Œë§Œ ìƒì„±
            if (dayHeaderGrid.innerHTML.trim() === '') {
                dayHeaders.forEach(day => {
                    const dayHeaderCell = document.createElement('div');
                    dayHeaderCell.className = 'calendar-day-name-common';
                    dayHeaderCell.textContent = day;
                    dayHeaderGrid.appendChild(dayHeaderCell);
                });
            }
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const today = new Date();

            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day-cell-common calendar-day'; 
                
                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month');
                } else {
                    dayCell.addEventListener('click', () => {                        
                        currentDate = new Date(cellDate);
                        renderCalendarRoutine();
                        loadTodayData();
                    });
                }

                if (cellDate.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }
                if (cellDate.toDateString() === currentDate.toDateString()) {
                    dayCell.classList.add('selected-day'); 
                }

                const dateKey = formatDate(cellDate);
                const dayData = moodData[dateKey];
                if (dayData && (Object.keys(dayData.moods || {}).length > 0 || (dayData.gratitude && dayData.gratitude.some(g => g)) || dayData.gratitudeNote)) {
                    dayCell.classList.add('has-record');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                
                calendarGrid.appendChild(dayCell);
            }
        }
        
        function changeDate(direction) {
            saveTodayData();
            currentDate.setDate(currentDate.getDate() + direction);
            renderCalendarRoutine();
            loadTodayData();
        }
        
        function setupMoodSelectors() {
            document.querySelectorAll('.mood-emoji').forEach(emoji => {
                emoji.addEventListener('click', function() {
                    const timeSection = this.closest('.mood-selector');
                    const time = timeSection.dataset.time;
                    
                    timeSection.querySelectorAll('.mood-emoji').forEach(e => 
                        e.classList.remove('selected'));
                    
                    this.classList.add('selected');
                    saveTodayData();
                });
            });
            
            document.querySelectorAll('.thought-input, .gratitude-input, .gratitude-note').forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(input.saveTimer);
                    input.saveTimer = setTimeout(saveTodayData, 1000);
                });
            });
        }
        
        async function loadMoodData() {
            // moodDataëŠ” authStateReadyì—ì„œ ì´ë¯¸ ì´ˆê¸°í™”ë¨
            if (currentUser) {
                try {
                    const snapshot = await db.collection('moodRoutines')
                                        .where('userId', '==', currentUser.uid)
                                        .get();
                    const firebaseData = {};
                    snapshot.forEach(doc => {
                        firebaseData[doc.id] = doc.data();
                    });
                    moodData = firebaseData; // ë¡œì»¬ ë°ì´í„°ì™€ ë³‘í•©í•˜ì§€ ì•Šê³  Firebase ë°ì´í„°ë§Œ ì‚¬ìš©
                    saveToLocalStorage('moodRoutineData', moodData);
                } catch (error) {
                    console.error("Firebase moodRoutines ë¡œë“œ ì‹¤íŒ¨:", error);
                    moodData = {}; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ë°ì´í„°ë¡œ ì‹œì‘
                }
            } else {
                // ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
                const localData = loadFromLocalStorage('moodRoutineData');
                moodData = localData || {};
            }
        }
        
        function saveTodayData() {
            const dateKey = formatDate(currentDate);
            const todayData = {
                date: dateKey,
                moods: {},
                thoughts: {},
                gratitude: [],
                gratitudeNote: ''
            };
            
            ['morning', 'afternoon', 'evening'].forEach(time => {
                const selectedMood = document.querySelector(`.mood-selector[data-time="${time}"] .mood-emoji.selected`);
                if (selectedMood) {
                    todayData.moods[time] = selectedMood.dataset.mood;
                }
                
                const thoughtInput = document.querySelector(`.thought-input[data-time="${time}"]`);
                if (thoughtInput && thoughtInput.value.trim()) {
                    todayData.thoughts[time] = thoughtInput.value.trim();
                }
            });
            
            document.querySelectorAll('.gratitude-input').forEach((input, index) => {
                if (input.value.trim()) {
                    todayData.gratitude[index] = input.value.trim();
                }
            });
            
            const gratitudeNote = document.querySelector('.gratitude-note');
            if (gratitudeNote && gratitudeNote.value.trim()) {
                todayData.gratitudeNote = gratitudeNote.value.trim();
            }
            
            moodData[dateKey] = todayData;
            saveToLocalStorage('moodRoutineData', moodData);
            if (currentUser && (Object.keys(todayData.moods).length > 0 || (Array.isArray(todayData.gratitude) && todayData.gratitude.some(g => g)) || todayData.gratitudeNote)) {
                 saveToFirestore('moodRoutines', dateKey, todayData);
            }
        }
        
        function loadTodayData() {
            const dateKey = formatDate(currentDate);
            const todayData = moodData[dateKey];
            
            document.querySelectorAll('.mood-emoji').forEach(emoji => 
                emoji.classList.remove('selected'));
            document.querySelectorAll('.thought-input').forEach(input => input.value = '');
            document.querySelectorAll('.gratitude-input').forEach(input => input.value = '');
            document.querySelector('.gratitude-note').value = '';
            
            if (todayData) {
                Object.entries(todayData.moods || {}).forEach(([time, mood]) => {
                    const moodEmoji = document.querySelector(
                        `.mood-selector[data-time="${time}"] .mood-emoji[data-mood="${mood}"]`
                    );
                    if (moodEmoji) {
                        moodEmoji.classList.add('selected');
                    }
                });
                
                Object.entries(todayData.thoughts || {}).forEach(([time, thought]) => {
                    const thoughtInput = document.querySelector(`.thought-input[data-time="${time}"]`);
                    if (thoughtInput) {
                        thoughtInput.value = thought;
                    }
                });
                
                (todayData.gratitude || []).forEach((gratitude, index) => {
                    const gratitudeInput = document.querySelector(`.gratitude-input[data-index="${index}"]`);
                    if (gratitudeInput) {
                        gratitudeInput.value = gratitude;
                    }
                });
                
                if (todayData.gratitudeNote) {
                    document.querySelector('.gratitude-note').value = todayData.gratitudeNote;
                }
                showMoodSummary(todayData);
            } else {
                document.getElementById('summaryCard').style.display = 'none';
            }
        }
        
        async function saveMoodData() {
            saveTodayData();
            
            const dateKey = formatDate(currentDate);
            const todayData = moodData[dateKey];
            
            if (!todayData || Object.keys(todayData.moods || {}).length === 0) {
                showMessage('ìµœì†Œ í•˜ë‚˜ì˜ ì‹œê°„ëŒ€ ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (currentUser) {
                await saveToFirestore('moodRoutines', dateKey, todayData);
            }
            showMoodSummary(todayData);
            showMessage('ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            renderCalendarRoutine();
        }
        
        function showMoodSummary(data) {
            const summaryCard = document.getElementById('summaryCard');
            const moodSummary = document.getElementById('moodSummary');
            
            moodSummary.innerHTML = '';
            
            ['morning', 'afternoon', 'evening'].forEach(time => {
                const mood = data.moods[time];
                if (mood) {
                    const timeLabels = {
                        morning: 'ì•„ì¹¨',
                        afternoon: 'ì ì‹¬',
                        evening: 'ì €ë…'
                    };
                    
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'mood-summary-item';
                    summaryItem.innerHTML = `
                        <div class="mood-summary-emoji">${moodEmojis[mood]}</div>
                        <div class="mood-summary-label">${timeLabels[time]}<br>${moodLabels[mood]}</div>
                    `;
                    moodSummary.appendChild(summaryItem);
                }
            });
            
            summaryCard.style.display = 'block';
        }
        
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function goToToday() {
            saveTodayData();
            currentDate = new Date();
            renderCalendarRoutine();
            loadTodayData();
        }
    </script>
</body>
</html>
