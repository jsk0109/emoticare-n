<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ë£¨ ê¸°ë¡ - EmotiCare</title>
    <link rel="stylesheet" href="styles.css?v=20240701b"> <!-- ìŠ¤íƒ€ì¼ì‹œíŠ¸ ë²„ì „ ì—…ë°ì´íŠ¸ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* mood-routine.html íŠ¹ì • ìŠ¤íƒ€ì¼ */
        .mood-input-section { margin-bottom: 2rem; }
        .mood-options { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; justify-content: center; }
        .mood-btn {
            background-color: #f0f0f0; border: 2px solid transparent;
            padding: 0.25rem 0.5rem; border-radius: 20px; cursor: pointer;
            transition: all 0.3s ease; font-size: 1rem;
        }
        .mood-btn:hover { background-color: #e0e0e0; }
        .mood-btn.selected {
            border-color: #667eea; background-color: #e9e7ff;
            font-weight: bold; color: #667eea;
        }
        .mood-btn i { margin-right: 0.5rem; }

        #moodRoutineDateModal .form-group { margin-bottom: 1rem; }
        #moodRoutineDateModal textarea { min-height: 100px; }

        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì¤‘ í•„ìš”í•œ ê²ƒë§Œ ë‚¨ê¸°ê±°ë‚˜, .content-block ë“±ìœ¼ë¡œ ëŒ€ì²´ëœ ê²ƒì€ ì£¼ì„ ì²˜ë¦¬/ì‚­ì œ */
        /* .calendar-header-routine, .date-nav, .current-date-display ë“± ê¸°ì¡´ ë‹¬ë ¥ ê´€ë ¨ ìŠ¤íƒ€ì¼ì€ ìƒˆ ë‹¬ë ¥ ìŠ¤íƒ€ì¼ë¡œ ëŒ€ì²´ */
        /* .time-sections, .time-header, .mood-selector, .mood-emoji, .thought-input ë“± ê¸°ì¡´ ì‹œê°„ëŒ€ë³„ ì…ë ¥í¼ ìŠ¤íƒ€ì¼ì€ ì œê±° ë˜ëŠ” ìƒˆ í¼ì— ë§ê²Œ ìˆ˜ì • */
        /* .gratitude-section, .gratitude-items, .gratitude-input ë“± ê¸°ì¡´ ê°ì‚¬ ì„¹ì…˜ ìŠ¤íƒ€ì¼ì€ ìƒˆ í¼ì— ë§ê²Œ ìˆ˜ì • */
        /* .save-section, .summary-card ë“± ê¸°ì¡´ ì €ì¥/ìš”ì•½ ìŠ¤íƒ€ì¼ì€ ì œê±° ë˜ëŠ” ìƒˆ ê¸°ëŠ¥ì— ë§ê²Œ ìˆ˜ì • */
    </style>
</head>
<body>
    <div id="header-container"></div>

    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">í•˜ë£¨ ê¸°ë¡</h1>
                <p class="page-subtitle">ì˜¤ëŠ˜ì˜ ê¸°ë¶„, ê°ì‚¬í•œ ì¼, ì‹¤ì²œí•œ ë£¨í‹´ì„ ê¸°ë¡í•˜ë©° í•˜ë£¨ë¥¼ ëŒì•„ë³´ì„¸ìš”.</p>
            </div>
        </section>

        <section class="page-content">
            <div class="page-inner-container">
                <!-- ì˜¤ëŠ˜ì˜ ê¸°ë¡ ì…ë ¥ í¼ -->
                   <div class="content-block mood-input-section" id="todayEntryFormContainer" style="text-align: center;">
                    <h2 style="font-size: 1.5em; margin-bottom: 1rem;"><i class="fas fa-sun"></i> ì˜¤ëŠ˜ì˜ ê¸°ë¡</h2>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 3rem;">
                        ë§¤ì¼ì˜ ê¸°ë¶„, ê°ì‚¬í•œ ì¼, ì‘ì€ ì„±ì·¨ë¥¼ ê¸°ë¡í•˜ë©° ê¸ì •ì ì¸ ë§ˆìŒ ìŠµê´€ì„ ë§Œë“¤ê³ <br>ìì‹ ì„ ë” ê¹Šì´ ì´í•´í•˜ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”.
                    </p>
                    <form id="todayMoodRoutineForm" onsubmit="saveTodayMoodRoutine(event)">
                        <div class="form-group" style="margin-bottom: 3rem;">
                            <label>ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì€ ì–´ë– ì…¨ë‚˜ìš”?</label>
                            <div class="mood-options" id="todayMoodOptions">
                                <!-- JavaScriptë¡œ ê¸°ë¶„ ë²„íŠ¼ ìƒì„± -->
                            </div>
                            <input type="hidden" id="todaySelectedMood" name="mood">
                        </div>
                        <div class="form-group" style="margin-bottom: 3rem;">
                            <label for="todayGratitude">ì˜¤ëŠ˜ ê°ì‚¬í–ˆë˜ ì¼ (3ê°€ì§€ ì´ìƒ ê¶Œì¥)</label>
                            <textarea id="todayGratitude" class="form-control" placeholder="ì˜ˆ: ë§›ìˆëŠ” ì €ë…, ì¹œêµ¬ì˜ ì „í™”, ë”°ëœ»í•œ í–‡ì‚´" rows="3"></textarea>
                        </div>
                        <div class="form-group" style="margin-bottom: 3rem;">
                            <label for="todayRoutine">ì˜¤ëŠ˜ ì‹¤ì²œí•œ ì‘ì€ ê¸ì • ìŠµê´€</label>
                            <textarea id="todayRoutine" class="form-control" placeholder="ì˜ˆ: ì•„ì¹¨ 3ë¶„ ìŠ¤íŠ¸ë ˆì¹­, ë¬¼ 2L ë§ˆì‹œê¸°, ì €ë… ë…ì„œ 30ë¶„" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn-primary" style="margin-top: 1rem; margin-bottom: 2rem;"><i class="fas fa-save"></i> ì˜¤ëŠ˜ì˜ ê¸°ë¡ ì €ì¥</button>
                    </form>
                </div>

                <!-- í•˜ë£¨ ê¸°ë¡ ë‹¬ë ¥ ì„¹ì…˜ -->
                <div class="content-block mood-routine-calendar-section" style="margin-bottom: 8rem;">
                    <div class="letters-header"> <!-- emotion-letters.htmlì˜ í´ë˜ìŠ¤ ì¬í™œìš© -->
                        <h3>ê¸°ë¡ ë‹¬ë ¥</h3>
                    </div>
                    <div class="calendar-block-header" style="margin-bottom: 1rem;">
                        <div class="calendar-block-nav">
                            <button onclick="changeMoodRoutineCalendarMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span class="calendar-block-title" id="moodRoutineCalendarMonth"></span>
                            <button onclick="changeMoodRoutineCalendarMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-block">
                        <div class="calendar-grid-common">
                            <!-- ìš”ì¼ í—¤ë”ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ (JS) -->
                        </div>
                        <div class="calendar-grid-common" id="moodRoutineCalendarGrid">
                            <!-- ë‚ ì§œ ì…€ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ (JS) -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ë‚ ì§œë³„ í•˜ë£¨ ê¸°ë¡ ë³´ê¸°/ì…ë ¥ ëª¨ë‹¬ -->
    <div id="moodRoutineDateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="moodRoutineDateModalTitle"></h3>
                <button class="modal-close" onclick="closeMoodRoutineDateModal()">&times;</button>
            </div>
            <div class="modal-body" id="moodRoutineDateModalBody">
                <!-- ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <div id="footer-container"></div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let allMoodRoutineData = {}; // ë‚ ì§œë³„ í•˜ë£¨ ê¸°ë¡ ë°ì´í„°: { "YYYY-MM-DD": {mood, gratitude, routine, timestamp, id}, ... }
        let currentMoodRoutineCalendarDate = new Date();
        let selectedDateForMoodRoutine = null; // ë‹¬ë ¥ì—ì„œ ì„ íƒëœ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹)
        let editingMoodRoutineDateKey = null; // ìˆ˜ì • ì¤‘ì¸ ê¸°ë¡ì˜ ë‚ ì§œ í‚¤ (YYYY-MM-DD í˜•ì‹)

        const moodEmojis = { // ì˜¤ëŠ˜ ê¸°ë¡ í¼ ë° ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•  ê¸°ë¶„ ì˜µì…˜
            "í–‰ë³µ": "ğŸ˜„", "ê¸°ì¨": "ğŸ˜Š", "ì„¤ë ˜": "ğŸ¤©", "í‰ì˜¨": "ğŸ˜Œ", "ê°ì‚¬": "ğŸ™",
            "ë³´í†µ": "ğŸ˜", "í”¼ê³¤": "ğŸ˜©", "ìŠ¬í””": "ğŸ˜¢", "í™”ë‚¨": "ğŸ˜ ", "ë¶ˆì•ˆ": "ğŸ˜Ÿ"
        };

        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('authStateReady', async function(e) {
                currentUser = e.detail.user;
                allMoodRoutineData = {}; 
                editingMoodRoutineDateKey = null;

                if (currentUser) {
                    await loadAllMoodRoutineRecords();
                } else {
                    allMoodRoutineData = loadFromLocalStorage('allMoodRoutineData') || {};
                    // ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ë¡œ ì‹œì‘
                    showMessage("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹œë©´ ê¸°ë¡ì´ ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.", "info");
                }
                renderMoodRoutineCalendar();
                renderTodayMoodOptions(); 
            });

            // ì˜¤ëŠ˜ ê¸°ë¡ í¼ì˜ ê¸°ë¶„ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            document.getElementById('todayMoodOptions')?.addEventListener('click', function(e) {
                if (e.target.classList.contains('mood-btn')) {
                    const moodValue = e.target.dataset.mood;
                    document.getElementById('todaySelectedMood').value = moodValue;
                    // ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                    this.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            });
        });

        function renderTodayMoodOptions() {
            const container = document.getElementById('todayMoodOptions');
            if (!container) return;
            container.innerHTML = Object.entries(moodEmojis).map(([text, emoji]) =>
                `<button type="button" class="mood-btn" data-mood="${text}">${emoji} ${text}</button>`
            ).join('');
        }

        async function saveTodayMoodRoutine(event) {
            event.preventDefault();
            const mood = document.getElementById('todaySelectedMood').value;
            const gratitude = document.getElementById('todayGratitude').value.trim();
            const routine = document.getElementById('todayRoutine').value.trim();

            if (!mood) {
                showMessage('ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            if (!gratitude && !routine) { // ë‘˜ ë‹¤ ë¹„ì–´ìˆìœ¼ë©´ ì €ì¥ ì˜ë¯¸ ì—†ìŒ
                showMessage('ê°ì‚¬í•œ ì¼ ë˜ëŠ” ì‹¤ì²œí•œ ë£¨í‹´ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const today = new Date();
            const dateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            await saveMoodRoutineForDate(dateKey, { mood, gratitude, routine }, true); // isTodayForm = true
            
            // ì˜¤ëŠ˜ ê¸°ë¡ í¼ ì´ˆê¸°í™”
            document.getElementById('todaySelectedMood').value = '';
            document.getElementById('todayGratitude').value = '';
            document.getElementById('todayRoutine').value = '';
            document.querySelectorAll('#todayMoodOptions .mood-btn.selected').forEach(btn => btn.classList.remove('selected'));
        }

        async function loadAllMoodRoutineRecords() {
            if (currentUser) {
                try {
                    const snapshot = await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.í•˜ë£¨ê¸°ë¶„ê¸°ë¡) // common.jsì˜ ì»¬ë ‰ì…˜ ì´ë¦„ ì‚¬ìš©
                                           .where('userId', '==', currentUser.uid)
                                           .get();
                    const firebaseData = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // dateString í•„ë“œê°€ Firestoreì— ì €ì¥ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
                        firebaseData[data.dateString] = { id: doc.id, ...data }; 
                    });
                    allMoodRoutineData = firebaseData;
                    saveToLocalStorage('allMoodRoutineData', allMoodRoutineData); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ ë™ê¸°í™”
                } catch (error) {
                    console.error("Firebase í•˜ë£¨ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:", error);
                    showMessage("í•˜ë£¨ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                    // Firebase ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë°ì´í„° ì‚¬ìš© (ì„ íƒì )
                    allMoodRoutineData = loadFromLocalStorage('allMoodRoutineData') || {};
                }
            } else {
                // ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ (authStateReadyì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨)
                allMoodRoutineData = loadFromLocalStorage('allMoodRoutineData') || {};
            }
        }

        function renderMoodRoutineCalendar() {
            const year = currentMoodRoutineCalendarDate.getFullYear();
            const month = currentMoodRoutineCalendarDate.getMonth();
            document.getElementById('moodRoutineCalendarMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;

            const calendarGrid = document.getElementById('moodRoutineCalendarGrid');
            calendarGrid.innerHTML = ''; // ê¸°ì¡´ ì…€ ì´ˆê¸°í™”

            const dayHeaderGrid = calendarGrid.previousElementSibling; // ìš”ì¼ í—¤ë” ì»¨í…Œì´ë„ˆ
            if (dayHeaderGrid && dayHeaderGrid.innerHTML.trim() === '') { // ë¹„ì–´ìˆì„ ë•Œë§Œ ìƒì„±
                const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                dayHeaders.forEach(day => {
                    const dayHeaderCell = document.createElement('div');
                    dayHeaderCell.className = 'calendar-day-name-common'; // ê³µí†µ ìŠ¤íƒ€ì¼ ì‚¬ìš©
                    dayHeaderCell.textContent = day;
                    dayHeaderGrid.appendChild(dayHeaderCell);
                });
            }

            const firstDayOfMonth = new Date(year, month, 1);
            const startDate = new Date(firstDayOfMonth);
            startDate.setDate(startDate.getDate() - firstDayOfMonth.getDay()); // ë‹¬ë ¥ ì‹œì‘ì¼ ê³„ì‚°
            const today = new Date();

            for (let i = 0; i < 42; i++) { // 6ì£¼ * 7ì¼ = 42ì¹¸
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                const dateKey = `${cellDate.getFullYear()}-${String(cellDate.getMonth() + 1).padStart(2, '0')}-${String(cellDate.getDate()).padStart(2, '0')}`;

                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day-cell-common calendar-day'; // ê³µí†µ ìŠ¤íƒ€ì¼ ì‚¬ìš©

                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month');
                } else {
                    // í•´ë‹¹ ë‚ ì§œì— ê¸°ë¡ì´ ìˆëŠ”ì§€ í™•ì¸
                    if (allMoodRoutineData[dateKey]) {
                        dayCell.classList.add('has-record'); // ê¸°ë¡ ìˆìŒ í‘œì‹œ (styles.cssì˜ ::after ì‚¬ìš©)
                        // ì„ íƒì ìœ¼ë¡œ ê¸°ë¶„ ì´ëª¨ì§€ í‘œì‹œ
                        const moodEmoji = moodEmojis[allMoodRoutineData[dateKey].mood];
                        if (moodEmoji) {
                            const moodIndicator = document.createElement('span');
                            moodIndicator.textContent = moodEmoji;
                            moodIndicator.style.fontSize = '1.2em'; // ì•„ì´ì½˜ í¬ê¸°
                            moodIndicator.style.position = 'absolute';
                            moodIndicator.style.top = '5px'; // ìœ„ì¹˜ ì¡°ì •
                            moodIndicator.style.right = '5px'; // ìœ„ì¹˜ ì¡°ì •
                            dayCell.appendChild(moodIndicator);
                        }
                    }
                    // ë‹¤ë¥¸ ë‹¬ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    dayCell.addEventListener('click', () => {
                        const todayForCompare = new Date();
                        todayForCompare.setHours(0,0,0,0); // ì‹œê°„ ì •ë³´ ì œê±°
                        const clickedDateForCompare = new Date(cellDate);
                        clickedDateForCompare.setHours(0,0,0,0); // ì‹œê°„ ì •ë³´ ì œê±°

                        if (clickedDateForCompare > todayForCompare) {
                            showMessage('ë¯¸ë˜ë¥¼ ì˜¤ëŠ˜ ê¸°ë¡í•  ìˆœ ì—†ì–´ìš” ğŸ˜Š', 'info');
                            return;
                        }
                        openMoodRoutineModalForDate(dateKey, cellDate)
                    });
                }

                // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
                if (cellDate.getFullYear() === today.getFullYear() &&
                    cellDate.getMonth() === today.getMonth() &&
                    cellDate.getDate() === today.getDate()) {
                    dayCell.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);
                calendarGrid.appendChild(dayCell);
            }
        }

        function changeMoodRoutineCalendarMonth(offset) {
            currentMoodRoutineCalendarDate.setMonth(currentMoodRoutineCalendarDate.getMonth() + offset);
            renderMoodRoutineCalendar();
        }

        function openMoodRoutineModalForDate(dateKey, cellDate) {
            selectedDateForMoodRoutine = dateKey; // ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•  ë‚ ì§œ í‚¤ ì €ì¥
            editingMoodRoutineDateKey = null; // ìƒˆë¡œ ì—´ ë•Œ ìˆ˜ì • ìƒíƒœ ì´ˆê¸°í™”

            const modal = document.getElementById('moodRoutineDateModal');
            const modalTitle = document.getElementById('moodRoutineDateModalTitle');
            const modalBody = document.getElementById('moodRoutineDateModalBody');

            if (!modal || !modalTitle || !modalBody) {
                showMessage("ê¸°ë¡ ì°½ì„ ì—¬ëŠ” ë° í•„ìš”í•œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                return;
            }

            modalTitle.textContent = `${cellDate.getFullYear()}ë…„ ${cellDate.getMonth() + 1}ì›” ${cellDate.getDate()}ì¼ ê¸°ë¡`;
            const record = allMoodRoutineData[dateKey];

            if (record) { // ê¸°ë¡ì´ ìˆëŠ” ê²½ìš° (ìˆ˜ì • ëª¨ë“œ)
                editingMoodRoutineDateKey = dateKey; // ìˆ˜ì • ì¤‘ì¸ ë‚ ì§œ í‚¤ ì„¤ì •
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>ê¸°ë¶„</label>
                        <div class="mood-options" id="modalMoodOptions">
                            ${Object.entries(moodEmojis).map(([text, emoji]) =>
                                `<button type="button" class="mood-btn ${record.mood === text ? 'selected' : ''}" data-mood="${text}">${emoji} ${text}</button>`
                            ).join('')}
                        </div>
                        <input type="hidden" id="modalSelectedMood" value="${record.mood || ''}">
                    </div>
                    <div class="form-group">
                        <label for="modalGratitude">ê°ì‚¬í–ˆë˜ ì¼</label>
                        <textarea id="modalGratitude" class="form-control" rows="3">${record.gratitude || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="modalRoutine">ì‹¤ì²œí•œ ë£¨í‹´</label>
                        <textarea id="modalRoutine" class="form-control" rows="3">${record.routine || ''}</textarea>
                    </div>
                    <div class="mt-3" style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                        <button class="btn-primary" onclick="handleSaveFromModal()"><i class="fas fa-save"></i> ìˆ˜ì • ì™„ë£Œ</button>
                        <button class="btn-outline btn-danger" onclick="deleteMoodRoutineForDate('${dateKey}')"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    </div>
                `;
            } else { // ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš° (ìƒˆ ì…ë ¥ ëª¨ë“œ)
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>ê¸°ë¶„</label>
                        <div class="mood-options" id="modalMoodOptions">
                             ${Object.entries(moodEmojis).map(([text, emoji]) =>
                                `<button type="button" class="mood-btn" data-mood="${text}">${emoji} ${text}</button>`
                            ).join('')}
                        </div>
                        <input type="hidden" id="modalSelectedMood">
                    </div>
                    <div class="form-group">
                        <label for="modalGratitude">ê°ì‚¬í–ˆë˜ ì¼</label>
                        <textarea id="modalGratitude" class="form-control" placeholder="ì˜¤ëŠ˜ ê°ì‚¬í–ˆë˜ ì¼ì„ ì ì–´ë³´ì„¸ìš”." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="modalRoutine">ì‹¤ì²œí•œ ë£¨í‹´</label>
                        <textarea id="modalRoutine" class="form-control" placeholder="ì˜¤ëŠ˜ ì‹¤ì²œí•œ ë£¨í‹´ì„ ì ì–´ë³´ì„¸ìš”." rows="3"></textarea>
                    </div>
                    <div class="mt-3" style="display: flex; justify-content: flex-end;">
                        <button class="btn-primary" onclick="handleSaveFromModal()"><i class="fas fa-save"></i> ì €ì¥í•˜ê¸°</button>
                    </div>
                `;
            }
            
            // ëª¨ë‹¬ ë‚´ ê¸°ë¶„ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            modalBody.querySelector('#modalMoodOptions')?.addEventListener('click', function(e) {
                if (e.target.classList.contains('mood-btn')) {
                    const moodValue = e.target.dataset.mood;
                    modalBody.querySelector('#modalSelectedMood').value = moodValue;
                    // ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                    this.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            });

            modal.style.display = 'block';
        }

        function closeMoodRoutineDateModal() {
            const modal = document.getElementById('moodRoutineDateModal');
            if (modal) modal.style.display = 'none';
            selectedDateForMoodRoutine = null; // ì„ íƒëœ ë‚ ì§œ ì´ˆê¸°í™”
            editingMoodRoutineDateKey = null; // ìˆ˜ì • ìƒíƒœ ì´ˆê¸°í™”
        }

        async function handleSaveFromModal() {
            const mood = document.getElementById('modalSelectedMood').value;
            const gratitude = document.getElementById('modalGratitude').value.trim();
            const routine = document.getElementById('modalRoutine').value.trim();
            // ì €ì¥í•  ë‚ ì§œ í‚¤ëŠ” ìˆ˜ì • ëª¨ë“œì¼ ê²½ìš° editingMoodRoutineDateKey, ìƒˆ ì…ë ¥ì¼ ê²½ìš° selectedDateForMoodRoutine
            const dateKeyToSave = editingMoodRoutineDateKey || selectedDateForMoodRoutine;

            if (!dateKeyToSave) {
                showMessage('ì €ì¥í•  ë‚ ì§œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (!mood) {
                showMessage('ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
             if (!gratitude && !routine) { // ë‘˜ ë‹¤ ë¹„ì–´ìˆìœ¼ë©´ ì €ì¥ ì˜ë¯¸ ì—†ìŒ
                showMessage('ê°ì‚¬í•œ ì¼ ë˜ëŠ” ì‹¤ì²œí•œ ë£¨í‹´ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            await saveMoodRoutineForDate(dateKeyToSave, { mood, gratitude, routine });
        }

        async function saveMoodRoutineForDate(dateKey, data, isTodayForm = false) {
            const recordToSave = {
                ...data, // mood, gratitude, routine
                dateString: dateKey, // YYYY-MM-DD í˜•ì‹ì˜ ë‚ ì§œ ë¬¸ìì—´
                timestamp: new Date().toISOString() // ì €ì¥/ìˆ˜ì • ì‹œì ì˜ íƒ€ì„ìŠ¤íƒ¬í”„
            };

            // ë©”ëª¨ë¦¬ ë‚´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ê¸°ì¡´ IDê°€ ìˆë‹¤ë©´ ìœ ì§€í•˜ë©° ì—…ë°ì´íŠ¸)
            allMoodRoutineData[dateKey] = { ...allMoodRoutineData[dateKey], ...recordToSave }; 
            
            let firestoreId = allMoodRoutineData[dateKey]?.id; // ê¸°ì¡´ Firestore ë¬¸ì„œ IDê°€ ìˆë‹¤ë©´ ì‚¬ìš©

            if (currentUser) {
                try {
                    if (!firestoreId) { // ìƒˆ ê¸°ë¡ì´ê±°ë‚˜ ë¡œì»¬ ê¸°ë¡ì„ ì²˜ìŒ Firestoreì— ì €ì¥í•˜ëŠ” ê²½ìš°
                        const docRef = db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.í•˜ë£¨ê¸°ë¶„ê¸°ë¡).doc(); // ìƒˆ ë¬¸ì„œ ID ìƒì„±
                        firestoreId = docRef.id;
                        allMoodRoutineData[dateKey].id = firestoreId; // ë¡œì»¬ ë°ì´í„°ì—ë„ Firestore ID ì €ì¥
                    }
                    // Firestoreì— ì €ì¥ (ë¬¸ì„œ IDë¥¼ ì‚¬ìš©í•˜ì—¬ set ë˜ëŠ” update)
                    await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.í•˜ë£¨ê¸°ë¶„ê¸°ë¡).doc(firestoreId).set({
                        ...recordToSave,
                        userId: currentUser.uid // ì‚¬ìš©ì ID ì¶”ê°€
                    }, { merge: true }); // merge: true ì˜µì…˜ìœ¼ë¡œ ê¸°ì¡´ í•„ë“œ ìœ ì§€í•˜ë©° ì—…ë°ì´íŠ¸
                    showMessage('ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (error) {
                    console.error("Firebase í•˜ë£¨ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:", error);
                    showMessage('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì˜¤ë¥˜)', 'error');
                    // ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë°ì´í„°ëŠ” ì´ë¯¸ ì—…ë°ì´íŠ¸ëœ ìƒíƒœì´ë¯€ë¡œ, ë¡¤ë°±ì€ ê³ ë ¤í•˜ì§€ ì•ŠìŒ (ë˜ëŠ” í•„ìš”ì‹œ êµ¬í˜„)
                }
            } else {
                // ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ ì „ìš© ID ë¶€ì—¬ (ì´ë¯¸ ìˆë‹¤ë©´ ìœ ì§€)
                if (!allMoodRoutineData[dateKey].id) { 
                    allMoodRoutineData[dateKey].id = `local_${Date.now()}`;
                }
                showMessage('ê¸°ë¡ì´ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ë©´ ë™ê¸°í™”ë©ë‹ˆë‹¤.', 'info');
            }
            
            saveToLocalStorage('allMoodRoutineData', allMoodRoutineData); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥
            renderMoodRoutineCalendar(); // ë‹¬ë ¥ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            if (!isTodayForm) { // "ì˜¤ëŠ˜ì˜ ê¸°ë¡" í¼ì—ì„œ ì €ì¥í•œ ê²Œ ì•„ë‹ˆë©´ ëª¨ë‹¬ ë‹«ê¸°
                closeMoodRoutineDateModal();
            }
        }

        async function deleteMoodRoutineForDate(dateKey) {
            if (confirm(`${dateKey}ì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const recordToDelete = allMoodRoutineData[dateKey];
                delete allMoodRoutineData[dateKey]; // ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ
                saveToLocalStorage('allMoodRoutineData', allMoodRoutineData); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸

                if (currentUser && recordToDelete && recordToDelete.id && !recordToDelete.id.startsWith('local_')) {
                    // ë¡œê·¸ì¸ ìƒíƒœì´ê³ , Firestore IDê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ Firestoreì—ì„œ ì‚­ì œ
                    try {
                        await db.collection(ì»¬ë ‰ì…˜_ì´ë¦„_ë§µ.í•˜ë£¨ê¸°ë¶„ê¸°ë¡).doc(recordToDelete.id).delete();
                    } catch (error) {
                        console.error('Firebase í•˜ë£¨ ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨:', error);
                        // ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë°ì´í„° ë³µêµ¬ (ì„ íƒì )
                        // allMoodRoutineData[dateKey] = recordToDelete;
                        // saveToLocalStorage('allMoodRoutineData', allMoodRoutineData);
                        // renderMoodRoutineCalendar(); // ë³µêµ¬ í›„ ë‹¬ë ¥ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                        showMessage('ì„œë²„ì—ì„œ ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                        return; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¶”ê°€ ì§„í–‰ ì¤‘ë‹¨
                    }
                }
                renderMoodRoutineCalendar(); // ë‹¬ë ¥ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                closeMoodRoutineDateModal(); // ëª¨ë‹¬ ë‹«ê¸°
                showMessage('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', function(event) {
            const moodModal = document.getElementById('moodRoutineDateModal');
            if (event.target === moodModal) {
                closeMoodRoutineDateModal();
            }
        });

    </script>
</body>
</html>
