<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íë§ ì¹´ë“œ - EmotiCare</title>
    <link rel="stylesheet" href="styles.css?v=20240701a">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* .cards-container íŒ¨ë”©ì€ .page-inner-container ë¡œ ëŒ€ì²´ */
        
        .card-draw-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            padding: 2rem; /* íŒ¨ë”© ì¶•ì†Œ */
            text-align: center;
            margin-bottom: 2rem; /* ë§ˆì§„ ì¶•ì†Œ */
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
        }
        
        .card-draw-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .card-draw-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .draw-button {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            color: #333;
            border: none;
            padding: 1rem 2.5rem; /* íŒ¨ë”© ì¶•ì†Œ */
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 234, 167, 0.4);
            margin-bottom: 1rem;
        }
        
        .draw-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(255, 234, 167, 0.6);
        }
        
        .draw-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .daily-limit {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .healing-card {
            background: white;
            border-radius: 20px;
            padding: 2rem; /* íŠ¹ë³„ ê°•ì¡° ì¹´ë“œ íŒ¨ë”© (ë°ìŠ¤í¬í†±) */
            margin: 1.5rem 0; 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.5s ease;
            border: 3px solid transparent;
        }
        
        .healing-card.show {
            transform: scale(1);
            opacity: 1;
            border-color: #667eea;
        }
        
        .card-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 1.5rem;
        }
        
        .card-message {
            font-size: 1.3rem;
            line-height: 1.6;
            color: #333;
            margin-bottom: 2rem;
            font-weight: 500;
        }
        
        .card-category {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        
        .card-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .save-card-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .save-card-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .new-card-btn {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .new-card-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .saved-cards-section {
            /* .content-block ìœ¼ë¡œ ëŒ€ì²´ */
        }
        
        .saved-cards-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; /* ë§ˆì§„ ì¶•ì†Œ */
        }
        
        .saved-cards-list {
            display: grid;
            gap: 1.5rem;
        }
        
        .saved-card-item {
            /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì œê±°í•˜ê³  .item-card í´ë˜ìŠ¤ ì‚¬ìš© ì˜ˆì • */
            /* background: #f8f9ff; */
            /* border-radius: 15px; */
            /* padding: 1rem; */
            /* border-left: 4px solid #667eea; */
            /* transition: all 0.3s ease; */
        }
        
        .saved-card-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        
        .saved-card-message {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .saved-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }
        
        .delete-saved-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .delete-saved-btn:hover {
            background: #ff5252;
        }
        
        .empty-saved {
            text-align: center;
            padding: 2rem; /* íŒ¨ë”© ì¶•ì†Œ */
            color: #666;
        }
        
        .empty-saved i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .time-based-message {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .card-draw-section { padding: 1.5rem; margin-bottom: 1.5rem; }
            .card-draw-title { font-size: 1.5rem; }
            .card-draw-subtitle { font-size: 1rem; margin-bottom: 1rem; }
            .draw-button { padding: 0.8rem 2rem; font-size: 1rem; } 
            .healing-card { padding: 1.5rem; margin: 1rem 0; } /* íŠ¹ë³„ ê°•ì¡° ì¹´ë“œ íŒ¨ë”© (ëª¨ë°”ì¼) */
            .card-icon { font-size: 3rem; margin-bottom: 1rem; }
            .card-message { font-size: 1.1rem; margin-bottom: 1.5rem; }
            .save-card-btn, .new-card-btn { padding: 0.7rem 1.5rem; font-size: 0.9rem; }
            .saved-cards-header h3 { font-size: 1.2rem; }
            .saved-card-item { padding: 0.8rem; }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">íë§ ì¹´ë“œ</h1>
                <p class="page-subtitle">ë§¤ì¼ ìƒˆë¡œìš´ íë§ ë©”ì‹œì§€ë¥¼ ë°›ì•„ë³´ê³  ë§ˆìŒì˜ ìœ„ë¡œë¥¼ ì–»ì–´ë³´ì„¸ìš”</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="page-inner-container cards-container">
                <div class="card-draw-section">
                    <h2 class="card-draw-title">ì˜¤ëŠ˜ì˜ íë§ ì¹´ë“œ</h2>
                    <p class="card-draw-subtitle">ë§ˆìŒì´ í•„ìš”ë¡œ í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ë°›ì•„ë³´ì„¸ìš”</p>
                    
                    <div class="time-based-message" id="timeMessage">
                        <!-- ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    
                    <button class="draw-button" id="drawButton" onclick="drawCard()">
                        <i class="fas fa-magic"></i> ì¹´ë“œ ë½‘ê¸°
                    </button>
                    
                    <div class="daily-limit" id="dailyLimit">
                        ì˜¤ëŠ˜ <span id="drawCount">0</span>/5 ì¹´ë“œë¥¼ ë½‘ìœ¼ì…¨ìŠµë‹ˆë‹¤
                    </div>
                </div>
                
                <div class="healing-card" id="healingCard">
                    <!-- ë½‘ì€ ì¹´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="content-block saved-cards-section" style="margin-bottom: 8rem;">
                    <div class="saved-cards-header">
                        <h3>ë‚´ê°€ ì €ì¥í•œ íë§ ë©”ì‹œì§€</h3>
                        <button class="btn-outline" onclick="clearAllSavedCards()">
                            <i class="fas fa-trash"></i> ëª¨ë‘ ì‚­ì œ
                        </button>
                    </div>
                    
                    <div class="saved-cards-list" id="savedCardsList">
                        <!-- ì €ì¥ëœ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let dailyDrawCount = 0;
        let savedCards = []; // ì´ ë°°ì—´ì€ ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì±„ì›Œì§‘ë‹ˆë‹¤.
        let currentCard = null;
        // currentUser ë³€ìˆ˜ëŠ” common.js íŒŒì¼ì˜ authStateReady ì´ë²¤íŠ¸ë¥¼ í†µí•´ ì„¤ì •ë©ë‹ˆë‹¤.

        const healingMessages = {
            timeSensitive: {
                earlyMorning: [ 
                    { message: "ìƒˆë¡œìš´ í•˜ë£¨ê°€ ë°ì•˜ì–´ìš”. ì˜¤ëŠ˜ ë‹¹ì‹ ì—ê²Œ ì–´ë–¤ ë©‹ì§„ ì¼ë“¤ì´ ê¸°ë‹¤ë¦¬ê³  ìˆì„ê¹Œìš”?", category: "ê¸°ëŒ€", icon: "fas fa-sun" },
                    { message: "ì°½ë°–ì˜ ì•„ì¹¨ í–‡ì‚´ì²˜ëŸ¼, ë‹¹ì‹ ì˜ í•˜ë£¨ë„ ë§‘ê³  ë”°ëœ»í•˜ê²Œ ì‹œì‘ë˜ê¸¸ ë°”ë¼ìš”.", category: "ì¶•ë³µ", icon: "fas fa-cloud-sun" },
                    { message: "ì ì‹œ ê³ ìš”íˆ ìˆ¨ì„ ì‰¬ë©°, ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ìœ„í•œ ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ì±„ì›Œë³´ì„¸ìš”.", category: "í‰ì˜¨", icon: "fas fa-wind" },
                    { message: "ì•„ì§ì€ ì¡°ìš©í•œ ì‹œê°„, ë‹¹ì‹ ë§Œì˜ ì‘ì€ ëª©í‘œë¥¼ ì„¸ìš°ê³  í˜ì°¨ê²Œ ì¶œë°œí•´ë´ìš”!", category: "ì‹œì‘", icon: "fas fa-flag-checkered" },
                    { message: "\"ì˜ ì¤ì–´ìš”?\" ì˜¤ëŠ˜ í•˜ë£¨ë„ ë‹¹ì‹ ì´ í–‰ë³µí•˜ê¸°ë¥¼ ì‘ì›í• ê²Œìš”.", category: "ì‘ì›", icon: "fas fa-smile-beam" }
                ],
                morning: [ 
                    { message: "í•œì°½ ë°”ì˜ê²Œ ì›€ì§ì´ê³  ìˆê² ë„¤ìš”. ì ì‹œ ì»¤í”¼ í•œ ì”ì˜ ì—¬ìœ ëŠ” ì–´ë•Œìš”?", category: "ì—¬ìœ ", icon: "fas fa-coffee" },
                    { message: "ì§‘ì¤‘í•˜ëŠ” ë‹¹ì‹ ì˜ ëª¨ìŠµì´ ë©‹ì ¸ìš”. ì‘ì€ ì„±ì·¨ë“¤ì´ ëª¨ì—¬ í° ê¸°ì¨ì´ ë  ê±°ì˜ˆìš”.", category: "ì¹­ì°¬", icon: "fas fa-medal" },
                    { message: "í˜¹ì‹œ ì–´ë ¤ìš´ ì¼ì— ë¶€ë”ªí˜”ë‹¤ë©´, ì ì‹œ ìˆ¨ì„ ê³ ë¥´ê³  ì²œì²œíˆ ë‹¤ì‹œ ì‹œì‘í•´ë³´ì„¸ìš”. ë‹¹ì‹ ì€ í•  ìˆ˜ ìˆì–´ìš”!", category: "ê²©ë ¤", icon: "fas fa-mountain" },
                    { message: "ì˜¤ì „ì˜ í™œê¸°ì°¬ ê¸°ìš´ì„ ë°›ì•„, ì˜¤ëŠ˜ ê³„íší•œ ì¼ë“¤ì„ ìˆœì¡°ë¡­ê²Œ í•´ë‚˜ê°€ê¸¸ ë°”ë¼ìš”.", category: "í™œë ¥", icon: "fas fa-bolt" },
                    { message: "ì£¼ë³€ì˜ ì‘ì€ ì†Œë¦¬ì—ë„ ê·€ ê¸°ìš¸ì—¬ë³´ì„¸ìš”. ì˜ˆìƒì¹˜ ëª»í•œ ì¦ê±°ì›€ì„ ë°œê²¬í• ì§€ë„ ëª°ë¼ìš”.", category: "ë°œê²¬", icon: "fas fa-search" }
                ],
                lunch: [ 
                    { message: "ë§›ìˆëŠ” ì ì‹¬ ì‹ì‚¬ë¡œ ì—ë„ˆì§€ ì¶©ì „! ì˜¤í›„ë¥¼ ìœ„í•œ ë“ ë“ í•œ í˜ì´ ë  ê±°ì˜ˆìš”.", category: "ì¶©ì „", icon: "fas fa-utensils" },
                    { message: "ì ì‹œ í•˜ë˜ ì¼ì„ ë©ˆì¶”ê³ , ì°½ë°–ì„ ë³´ê±°ë‚˜ ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­ìœ¼ë¡œ ëª¸ì„ í’€ì–´ì£¼ì„¸ìš”.", category: "íœ´ì‹", icon: "fas fa-chair" },
                    { message: "ì˜¤ì „ ë™ì•ˆ ì •ë§ ìˆ˜ê³  ë§ì•˜ì–´ìš”. ë‚¨ì€ í•˜ë£¨ë„ ë‹¹ì‹ ì„ ì‘ì›í• ê²Œìš”.", category: "ì¸ì •", icon: "fas fa-award" },
                    { message: "ì¢‹ì•„í•˜ëŠ” ìŒì•…ì„ ë“£ê±°ë‚˜ ì§§ì€ ëª…ìƒìœ¼ë¡œ ë§ˆìŒì˜ íœ´ì‹ì„ ê°€ì ¸ë³´ëŠ” ê±´ ì–´ë•Œìš”?", category: "í‰í™”", icon: "fas fa-headphones-alt" },
                    { message: "\"ì ì‹¬ ë§›ìˆê²Œ ë“œì…¨ì–´ìš”?\" ì˜¤í›„ì—ë„ ì¢‹ì€ ì¼ë§Œ ê°€ë“í•˜ê¸¸!", category: "ì•ˆë¶€", icon: "fas fa-comment-dots" }
                ],
                afternoon: [ 
                    { message: "ë‚˜ë¥¸í•œ ì˜¤í›„, ë”°ëœ»í•œ ì°¨ í•œ ì”ìœ¼ë¡œ ì ì‹œ ê¸°ë¶„ ì „í™˜ì„ í•´ë³´ì„¸ìš”.", category: "ì „í™˜", icon: "fas fa-mug-hot" },
                    { message: "ì˜¤ëŠ˜ í•˜ë£¨ë„ ê±°ì˜ ë‹¤ ì§€ë‚˜ê°€ë„¤ìš”. ë§ˆë¬´ë¦¬ê¹Œì§€ ì¡°ê¸ˆë§Œ ë” í˜ë‚´ìš”!", category: "ì‘ì›", icon: "fas fa-running" },
                    { message: "í˜¹ì‹œ ì§€ì¹˜ëŠ” ê¸°ë¶„ì´ ë“ ë‹¤ë©´, ì•„ì£¼ ì‘ì€ ì„±ê³¼ë¼ë„ ìŠ¤ìŠ¤ë¡œë¥¼ ì¹­ì°¬í•´ì£¼ì„¸ìš”.", category: "ìê¸°ê²©ë ¤", icon: "fas fa-star" },
                    { message: "ì°½ë¬¸ì„ ì—´ì–´ ì‹ ì„ í•œ ê³µê¸°ë¥¼ ë§ˆì‹œë©°, ë‚¨ì€ ì˜¤í›„ë¥¼ ìœ„í•œ í™œë ¥ì„ ë˜ì°¾ì•„ë³´ì„¸ìš”.", category: "í™˜ê¸°", icon: "fas fa-leaf" },
                    { message: "í‡´ê·¼/í•˜êµ ì‹œê°„ì´ ì–¼ë§ˆ ë‚¨ì§€ ì•Šì•˜ë„¤ìš”! ì˜¤ëŠ˜ í•˜ë£¨ë„ ì •ë§ ì• ì¼ì–´ìš”.", category: "ìˆ˜ê³ ", icon: "fas fa-hourglass-end" }
                ],
                evening: [ 
                    { message: "í¸ì•ˆí•œ ì €ë… ì‹œê°„ ë³´ë‚´ê³  ìˆë‚˜ìš”? ì˜¤ëŠ˜ í•˜ë£¨ì˜ í”¼ë¡œë¥¼ ì‹¹ ë‚ ë ¤ë²„ë¦¬ì„¸ìš”.", category: "íœ´ì‹", icon: "fas fa-couch" },
                    { message: "ì‚¬ë‘í•˜ëŠ” ì‚¬ëŒë“¤ê³¼ í•¨ê»˜ ë§›ìˆëŠ” ì €ë…ì„ ë‚˜ëˆ„ë©° í–‰ë³µí•œ ì‹œê°„ì„ ë³´ë‚´ê¸¸ ë°”ë¼ìš”.", category: "í–‰ë³µ", icon: "fas fa-users" },
                    { message: "ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¢‹ì€ ì¼ë“¤ì„ ë– ì˜¬ë¦¬ë©°, ê°ì‚¬í•˜ëŠ” ë§ˆìŒìœ¼ë¡œ í•˜ë£¨ë¥¼ ëŒì•„ë³´ì„¸ìš”.", category: "ê°ì‚¬", icon: "fas fa-hands-helping" },
                    { message: "ì¢‹ì•„í•˜ëŠ” ì·¨ë¯¸ ìƒí™œì´ë‚˜ í¸ì•ˆí•œ íœ´ì‹ìœ¼ë¡œ ì˜¨ì „íˆ ë‹¹ì‹ ë§Œì˜ ì‹œê°„ì„ ì¦ê²¨ë³´ì„¸ìš”.", category: "ì¦ê±°ì›€", icon: "fas fa-palette" },
                    { message: "\"ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë• ì–´ìš”?\" ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ì— ê·€ ê¸°ìš¸ì¼ ì¤€ë¹„ê°€ ë˜ì–´ ìˆì–´ìš”.", category: "ì†Œí†µ", icon: "fas fa-comments" }
                ],
                lateNight: [ 
                    { message: "ì´ì œ ê³§ ì ìë¦¬ì— ë“¤ ì‹œê°„ì´ë„¤ìš”. ì˜¤ëŠ˜ í•˜ë£¨ë„ ì •ë§ ê³ ìƒ ë§ì•˜ì–´ìš”.", category: "ë§ˆë¬´ë¦¬", icon: "fas fa-bed" },
                    { message: "ë”°ëœ»í•œ ë¬¼ë¡œ ìƒ¤ì›Œí•˜ê±°ë‚˜, ì”ì”í•œ ìŒì•…ì„ ë“¤ìœ¼ë©° í¸ì•ˆí•˜ê²Œ ì ë“¤ ì¤€ë¹„ë¥¼ í•´ë³´ì„¸ìš”.", category: "ì¤€ë¹„", icon: "fas fa-music" },
                    { message: "ì˜¤ëŠ˜ ìˆì—ˆë˜ ê±±ì •ê±°ë¦¬ëŠ” ì ì‹œ ë‚´ë ¤ë†“ê³ , ë‚´ì¼ì˜ ë‹¹ì‹ ì—ê²Œ ë§¡ê²¨ë³´ëŠ” ê±´ ì–´ë•Œìš”?", category: "ë‚´ë ¤ë†“ìŒ", icon: "fas fa-moon" },
                    { message: "í¬ê·¼í•œ ì´ë¶ˆ ì†ì—ì„œ ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì˜ ë§ˆë¬´ë¦¬í•˜ê³ , ë‹¨ì  ì£¼ë¬´ì‹œê¸¸ ë°”ë¼ìš”.", category: "ì•ˆë…•", icon: "fas fa-cloud-moon" },
                    { message: "\"ì˜ ììš”.\" ì¢‹ì€ ê¿ˆ ê¾¸ê³ , ë‚´ì¼ ì•„ì¹¨ì— ë” ë°ì€ ëª¨ìŠµìœ¼ë¡œ ë§Œë‚˜ìš”.", category: "ê¿ˆ", icon: "fas fa-star-of-david" }
                ],
                dawn: [ 
                    { message: "ì•„ì§ ê¹¨ì–´ìˆë‹¤ë©´, í˜¹ì€ ì ì‹œ ì ì—ì„œ ê¹¼ë‹¤ë©´, ê³ ìš”í•œ ìƒˆë²½ì˜ í‰í™”ë¥¼ ëŠê»´ë³´ì„¸ìš”.", category: "ê³ ìš”", icon: "fas fa-adjust" },
                    { message: "í˜¹ì‹œ ì  ëª» ì´ë£¨ëŠ” ë°¤ì´ë¼ë©´, ë”°ëœ»í•œ ìš°ìœ  í•œ ì”ì´ë‚˜ ê°€ë²¼ìš´ ë…ì„œê°€ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”.", category: "ìœ„ì•ˆ", icon: "fas fa-book-reader" },
                    { message: "ê¹Šì€ ë°¤, ë‹¹ì‹ ì˜ ë§ˆìŒì† ì‘ì€ ì†Œë¦¬ì—ë„ ê·€ ê¸°ìš¸ì—¬ë³´ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”.", category: "ì„±ì°°", icon: "fas fa-lightbulb" },
                    { message: "ì„¸ìƒì´ ì ë“  ì‹œê°„, ë‹¹ì‹ ì˜ ëª¸ê³¼ ë§ˆìŒë„ ì¶©ë¶„í•œ íœ´ì‹ì„ ì·¨í•˜ê¸¸ ë°”ë¼ìš”.", category: "íšŒë³µ", icon: "fas fa-heartbeat" },
                    { message: "ê³§ ìƒˆë¡œìš´ ì•„ì¹¨ì´ ë°ì•„ì˜¬ ê±°ì˜ˆìš”. í¸ì•ˆí•œ ë§ˆìŒìœ¼ë¡œ ë‹¤ì‹œ ì ë“¤ì–´ë³´ì„¸ìš”.", category: "í¬ë§", icon: "fas fa-dove" }
                ]
            },
            general: [
                { message: "ë‹¹ì‹ ì˜ í•˜ë£¨ê°€ ì‘ì€ ê¸°ì¨ë“¤ë¡œ ê°€ë“ ì±„ì›Œì§€ê¸°ë¥¼ ì‘ì›í•©ë‹ˆë‹¤.", category: "ì‘ì›", icon: "fas fa-gift" },
                { message: "ë§ˆìŒì˜ ì§ì„ ì ì‹œ ë‚´ë ¤ë†“ê³ , ê°€ë³ê²Œ ìˆ¨ ì‰¬ëŠ” ì—°ìŠµì„ í•´ë³´ì„¸ìš”.", category: "í‰ì˜¨", icon: "fas fa-feather-alt" },
                { message: "ë‹¹ì‹ ì€ í˜¼ìê°€ ì•„ë‹™ë‹ˆë‹¤. ì–¸ì œë‚˜ ë‹¹ì‹ ì„ ì§€ì§€í•˜ëŠ” ì‚¬ëŒë“¤ì´ ìˆì–´ìš”.", category: "ì§€ì§€", icon: "fas fa-users" },
                { message: "ìŠ¤ìŠ¤ë¡œì—ê²Œ ì¹œì ˆí•œ í•˜ë£¨ë¥¼ ì„ ë¬¼í•˜ì„¸ìš”.", category: "ìê¸°ì• ", icon: "fas fa-hand-holding-heart" },
                { message: "ë„˜ì–´ì ¸ë„ ê´œì°®ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¼ì–´ì„¤ í˜ì€ ë‹¹ì‹  ì•ˆì— ìˆìŠµë‹ˆë‹¤.", category: "ìš©ê¸°", icon: "fas fa-fist-raised" },
                { message: "ì˜¤ëŠ˜ ë‹¹ì‹ ì˜ ìš©ê¸° ìˆëŠ” ì„ íƒì„ ì‘ì›í•©ë‹ˆë‹¤.", category: "ì„ íƒ", icon: "fas fa-map-signs" },
                { message: "ë‹¹ì‹ ì˜ ë§ˆìŒì´ ë”°ëœ»í•œ ìœ„ë¡œë¥¼ ë°›ê¸°ë¥¼ ë°”ëë‹ˆë‹¤.", category: "ìœ„ë¡œ", icon: "fas fa-hands-helping" },
                { message: "ì‘ì€ ë³€í™”ê°€ í° í–‰ë³µì„ ê°€ì ¸ë‹¤ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", category: "ë³€í™”", icon: "fas fa-seedling" },
                { message: "ë‹¹ì‹ ì˜ ë¯¸ì†ŒëŠ” ì£¼ë³€ì„ í™˜í•˜ê²Œ ë¹„ì¶¥ë‹ˆë‹¤.", category: "ë¯¸ì†Œ", icon: "fas fa-smile" },
                { message: "ì§€ê¸ˆ ì´ ìˆœê°„, ë‹¹ì‹ ì€ ì¶©ë¶„íˆ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤.", category: "ì•„ë¦„ë‹¤ì›€", icon: "fas fa-spa" },
                { message: "í˜ë“  ê°ì •ì€ ì ì‹œ ë¨¸ë¬¼ë‹¤ ì§€ë‚˜ê°ˆ êµ¬ë¦„ê³¼ ê°™ìŠµë‹ˆë‹¤.", category: "ê°ì •", icon: "fas fa-cloud" },
                { message: "ë‹¹ì‹ ì˜ ë…¸ë ¥ì€ ê²°ì½” í—›ë˜ì§€ ì•Šì„ ê±°ì˜ˆìš”.", category: "ë…¸ë ¥", icon: "fas fa-trophy" },
                { message: "ìŠ¤ìŠ¤ë¡œë¥¼ ë¯¿ìœ¼ì„¸ìš”. ë‹¹ì‹ ì€ ìƒê°ë³´ë‹¤ ê°•í•©ë‹ˆë‹¤.", category: "ë¯¿ìŒ", icon: "fas fa-shield-alt" },
                { message: "ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ì— ê·€ ê¸°ìš¸ì—¬ì£¼ëŠ” ì‚¬ëŒì´ ìˆë‹¤ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”.", category: "ê²½ì²­", icon: "fas fa-assistive-listening-systems" },
                { message: "ì˜¤ëŠ˜ì€ ë‹¹ì‹ ì—ê²Œ ê°€ì¥ ë‹¤ì •í•œ ì¹œêµ¬ê°€ ë˜ì–´ì£¼ì„¸ìš”.", category: "ìê¸°ëŒë´„", icon: "fas fa-user-friends" },
                { message: "ë‹¹ì‹ ì˜ ë§ˆìŒ ì •ì›ì— ì˜ˆìœ ê½ƒì„ í”¼ì›Œë³´ì„¸ìš”.", category: "ì„±ì¥", icon: "fas fa-tree" },
                { message: "ê´œì°®ì•„ìš”, ì§€ê¸ˆ ëŠë¼ëŠ” ëª¨ë“  ê°ì •ì€ ìì—°ìŠ¤ëŸ¬ìš´ ê²ƒì…ë‹ˆë‹¤.", category: "ìˆ˜ìš©", icon: "fas fa-check-circle" },
                { message: "ë‹¹ì‹ ì˜ ë°œê±¸ìŒ í•˜ë‚˜í•˜ë‚˜ê°€ ì†Œì¤‘í•œ ì—¬ì •ì…ë‹ˆë‹¤.", category: "ì—¬ì •", icon: "fas fa-shoe-prints" },
                { message: "ê°€ë”ì€ ëª¨ë“  ê²ƒì„ ë‚´ë ¤ë†“ê³  í¸ì•ˆí•˜ê²Œ ì‰¬ëŠ” ê²ƒë„ í•„ìš”í•©ë‹ˆë‹¤.", category: "íœ´ì‹", icon: "fas fa-umbrella-beach" },
                { message: "ë‹¹ì‹ ì˜ ë”°ëœ»í•œ ë§ˆìŒì´ ì„¸ìƒì„ ì¡°ê¸ˆ ë” ë‚˜ì€ ê³³ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.", category: "ì˜¨ê¸°", icon: "fas fa-fire" },
                { message: "ì–´ë‘ìš´ ë°¤í•˜ëŠ˜ì—ë„ ë³„ì€ ë¹›ë‚˜ê³  ìˆìŠµë‹ˆë‹¤. ë‹¹ì‹ ì²˜ëŸ¼ìš”.", category: "í¬ë§", icon: "fas fa-star-and-crescent" },
                { message: "ë‹¹ì‹ ì˜ ê¿ˆì„ í–¥í•´ ë‚˜ì•„ê°€ëŠ” ìš©ê¸°ë¥¼ ì‘ì›í•©ë‹ˆë‹¤.", category: "ê¿ˆ", icon: "fas fa-rocket" },
                { message: "ëª¨ë“  ìˆœê°„ì´ ì™„ë²½í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. ì§€ê¸ˆ ì´ëŒ€ë¡œë„ ì¢‹ìŠµë‹ˆë‹¤.", category: "ì™„ë²½ì£¼ì˜íƒˆí”¼", icon: "fas fa-thumbs-up" },
                { message: "ë‹¹ì‹ ì˜ ì¡´ì¬ ìì²´ë¡œ ì´ë¯¸ ì¶©ë¶„í•œ ê°€ì¹˜ê°€ ìˆìŠµë‹ˆë‹¤.", category: "ì¡´ì¬ê°€ì¹˜", icon: "fas fa-gem" },
                { message: "ì ì‹œ í•˜ëŠ˜ì„ ì˜¬ë ¤ë‹¤ë³´ë©°, ë§ˆìŒì˜ ì—¬ìœ ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.", category: "ì—¬ìœ ", icon: "fas fa-binoculars" },
                { message: "ë‹¹ì‹ ì€ ì‚¬ë‘ë°›ê¸° ìœ„í•´ íƒœì–´ë‚œ ì†Œì¤‘í•œ ì¡´ì¬ì…ë‹ˆë‹¤.", category: "ì‚¬ë‘", icon: "fas fa-heart" },
                { message: "ìŠ¤ìŠ¤ë¡œì—ê²Œ \"ê³ ë§ˆì›Œ, ì‚¬ë‘í•´\"ë¼ê³  ë§í•´ì£¼ì„¸ìš”.", category: "ìê¸°ê¸ì •", icon: "fas fa-kiss-wink-heart" },
                { message: "ë‹¹ì‹ ì˜ ì˜¤ëŠ˜ì€ ì–´ì œë³´ë‹¤ ë” ë¹›ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", category: "ë°œì „", icon: "fas fa-chart-line" },
                { message: "ë³µì¡í•œ ìƒê°ì€ ì ì‹œ ë©ˆì¶”ê³ , í˜„ì¬ì— ì§‘ì¤‘í•´ë³´ì„¸ìš”.", category: "í˜„ì¬ì§‘ì¤‘", icon: "fas fa-dot-circle" },
                { message: "ë‹¹ì‹ ì˜ ì‘ì€ ë‚ ê°¯ì§“ì´ í° ë³€í™”ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", category: "ì˜í–¥ë ¥", icon: "fas fa-dove" }
            ]
        };
        
        const timeBasedMessages = {
            earlyMorning: "ğŸŒ… ì´ë¥¸ ì•„ì¹¨, ë‹¹ì‹ ì˜ í•˜ë£¨ë¥¼ ì—¬ëŠ” íŠ¹ë³„í•œ ë©”ì‹œì§€ì…ë‹ˆë‹¤.",
            morning: "â˜€ï¸ í™œê¸°ì°¬ ì˜¤ì „, ë‹¹ì‹ ì—ê²Œ í˜ì„ ì£¼ëŠ” ë©”ì‹œì§€ë¥¼ ì¤€ë¹„í–ˆì–´ìš”.",
            lunch: "ğŸ¥— ì ì‹¬ì‹œê°„, ì ì‹œ ì‰¬ì–´ê°€ë©° ì—ë„ˆì§€ë¥¼ ì±„ìš¸ ë©”ì‹œì§€ì…ë‹ˆë‹¤.",
            afternoon: "â˜• ë‚˜ë¥¸í•œ ì˜¤í›„, ë‹¹ì‹ ì˜ ë§ˆìŒì— ì‘ì€ í™œë ¥ì„ ë”í•´ì¤„ê²Œìš”.",
            evening: "ğŸŒ‡ ì €ë… ì‹œê°„, í•˜ë£¨ë¥¼ ëŒì•„ë³´ë©° ìœ„ë¡œë¥¼ ì–»ëŠ” ë©”ì‹œì§€ì…ë‹ˆë‹¤.",
            lateNight: "ğŸŒ™ ëŠ¦ì€ ë°¤, í¸ì•ˆí•œ ë§ˆë¬´ë¦¬ë¥¼ ìœ„í•œ ë©”ì‹œì§€ë¥¼ ì „í•´ë“œë ¤ìš”.",
            dawn: "âœ¨ ê³ ìš”í•œ ìƒˆë²½, ë‹¹ì‹ ì˜ ë§ˆìŒì„ ë‹¤ë…ì—¬ì¤„ ë©”ì‹œì§€ì…ë‹ˆë‹¤."
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('authStateReady', async function(e) {
                currentUser = e.detail.user; // common.jsì—ì„œ ì „ë‹¬ëœ ì‚¬ìš©ì ì •ë³´ë¡œ currentUser ì—…ë°ì´íŠ¸
                console.log('healing-cards.html: authStateReady event. User:', currentUser ? currentUser.uid : 'No user');

                loadDailyData();
                await loadSavedCards(); // ì‚¬ìš©ì ìƒíƒœ í™•ì • í›„ ì¹´ë“œ ë¡œë“œ
                updateTimeMessage();
                renderSavedCards(); // ë¡œë“œëœ ì¹´ë“œ ëª©ë¡ìœ¼ë¡œ í™”ë©´ ê°±ì‹ 
            });
        });
        
        function updateTimeMessage() {
            const hour = new Date().getHours();
            let timeKey;
            
            if (hour >= 6 && hour < 9) { // 6:00 - 8:59
                timeKey = 'earlyMorning';
            } else if (hour >= 9 && hour < 12) { // 9:00 - 11:59
                timeKey = 'morning';
            } else if (hour >= 12 && hour < 14) { // 12:00 - 13:59
                timeKey = 'lunch';
            } else if (hour >= 14 && hour < 18) { // 14:00 - 17:59
                timeKey = 'afternoon';
            } else if (hour >= 18 && hour < 21) { // 18:00 - 20:59
                timeKey = 'evening';
            } else if (hour >= 21 && hour < 24) { // 21:00 - 23:59
                timeKey = 'lateNight';
            } else { // 00:00 - 05:59
                timeKey = 'dawn';
            }
            
            document.getElementById('timeMessage').textContent = timeBasedMessages[timeKey];
        }
        
        function loadDailyData() {
            const today = getCurrentDate(); // common.jsì˜ í•¨ìˆ˜ ì‚¬ìš©
            const dailyData = loadFromLocalStorage('dailyCardData') || {}; // common.jsì˜ í•¨ìˆ˜ ì‚¬ìš©
            
            if (dailyData.date === today) {
                dailyDrawCount = dailyData.drawCount || 0;
            } else {
                dailyDrawCount = 0;
                saveToLocalStorage('dailyCardData', { date: today, drawCount: 0 }); // common.jsì˜ í•¨ìˆ˜ ì‚¬ìš©
            }
            updateDrawButton();
        }
        
        function updateDrawButton() {
            const drawButton = document.getElementById('drawButton');
            const drawCountSpan = document.getElementById('drawCount');
            
            drawCountSpan.textContent = dailyDrawCount;
            
            if (dailyDrawCount >= 5) {
                drawButton.disabled = true;
                drawButton.innerHTML = '<i class="fas fa-clock"></i> ë‚´ì¼ ë‹¤ì‹œ ë½‘ì•„ë³´ì„¸ìš”';
            } else {
                drawButton.disabled = false;
                drawButton.innerHTML = '<i class="fas fa-magic"></i> ì¹´ë“œ ë½‘ê¸°';
            }
        }
        
        function drawCard() {
            if (dailyDrawCount >= 5) {
                showMessage('í•˜ë£¨ì— ìµœëŒ€ 5ì¥ê¹Œì§€ë§Œ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            let messagePool;
            const hour = new Date().getHours();

            if (dailyDrawCount === 0) { // ì²« ë²ˆì§¸ ë½‘ê¸°
                if (hour >= 6 && hour < 9) messagePool = healingMessages.timeSensitive.earlyMorning;
                else if (hour >= 9 && hour < 12) messagePool = healingMessages.timeSensitive.morning;
                else if (hour >= 12 && hour < 14) messagePool = healingMessages.timeSensitive.lunch;
                else if (hour >= 14 && hour < 18) messagePool = healingMessages.timeSensitive.afternoon;
                else if (hour >= 18 && hour < 21) messagePool = healingMessages.timeSensitive.evening;
                else if (hour >= 21 && hour < 24) messagePool = healingMessages.timeSensitive.lateNight;
                else messagePool = healingMessages.timeSensitive.dawn;
            } else {
                messagePool = healingMessages.general;
            }
            
            currentCard = getRandomItem(messagePool); // common.jsì˜ í•¨ìˆ˜ ì‚¬ìš©
            displayCard(currentCard);
            
            dailyDrawCount++;
            const today = getCurrentDate();
            saveToLocalStorage('dailyCardData', { date: today, drawCount: dailyDrawCount });
            updateDrawButton();
        }
        
        function displayCard(card) {
            const cardElement = document.getElementById('healingCard');
            cardElement.innerHTML = `
                <div class="card-icon"><i class="${card.icon}"></i></div>
                <div class="card-category">${card.category}</div>
                <div class="card-message">${card.message}</div>
                <div class="card-actions">
                    <button class="save-card-btn" onclick="saveCurrentCard()"><i class="fas fa-bookmark"></i> ì €ì¥í•˜ê¸°</button>
                    <button class="new-card-btn" onclick="drawCard()"><i class="fas fa-sync-alt"></i> ìƒˆ ì¹´ë“œ ë½‘ê¸°</button>
                </div>
            `;
            cardElement.classList.add('show');
        }
        
        async function saveCurrentCard() {
            if (!currentCard) return;

            const cardToSave = {
                message: currentCard.message,
                category: currentCard.category,
                icon: currentCard.icon,
                savedAt: firebase.firestore.FieldValue.serverTimestamp() // Firebase ì„œë²„ ì‹œê°„ ì‚¬ìš©
            };

            if (currentUser) {
                try {
                    const docRef = await db.collection('savedCards').add({
                        ...cardToSave,
                        userId: currentUser.uid
                    });
                    // ë¡œì»¬ ë°°ì—´ì—ë„ ì¶”ê°€ (Firestore IDì™€ í•¨ê»˜)
                    const newCardForLocal = { ...currentCard, id: docRef.id, savedAt: new Date().toISOString() }; // ë¡œì»¬ìš© savedAt
                    savedCards.unshift(newCardForLocal);
                    saveToLocalStorage('savedHealingCards', savedCards); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                    renderSavedCards();
                    showMessage('ì¹´ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (error) {
                    console.error("Firebase ì¹´ë“œ ì €ì¥ ì‹¤íŒ¨:", error);
                    showMessage('ì¹´ë“œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                }
            } else {
                // ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ì—ë§Œ ì €ì¥ (ë˜ëŠ” ë¡œê·¸ì¸ ìœ ë„)
                const newCardForLocal = { ...currentCard, id: Date.now().toString(), savedAt: new Date().toISOString() };
                savedCards.unshift(newCardForLocal);
                saveToLocalStorage('savedHealingCards', savedCards);
                renderSavedCards();
                showMessage('ì¹´ë“œê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ë©´ ë™ê¸°í™”ë©ë‹ˆë‹¤.', 'info');
            }
        }

        async function loadSavedCards() {
            console.log('loadSavedCards: currentUser:', currentUser ? currentUser.uid : 'No user');
            savedCards = []; // â˜…â˜…â˜… ë°ì´í„° ë¡œë“œ ì „ í•­ìƒ ë©”ëª¨ë¦¬ ë‚´ ë°°ì—´ ì´ˆê¸°í™”

            if (currentUser) {
                try {
                    const snapshot = await db.collection('savedCards')
                                           .where('userId', '==', currentUser.uid)
                                           .orderBy('savedAt', 'desc')
                                           .get();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        savedCards.push({ 
                            id: doc.id, 
                            message: data.message,
                            category: data.category,
                            icon: data.icon,
                            savedAt: data.savedAt && data.savedAt.toDate ? data.savedAt.toDate().toISOString() : new Date().toISOString() 
                        });
                    });
                    console.log("loadSavedCards: Fetched", savedCards.length, "cards from Firebase for user", currentUser.uid);
                    saveToLocalStorage('savedHealingCards', savedCards); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì™€ ë™ê¸°í™”
                } catch (error) {
                    console.error("Firebaseì—ì„œ ì €ì¥ëœ ì¹´ë“œ ë¡œë“œ ì‹¤íŒ¨:", error);
                    // savedCardsëŠ” ì´ë¯¸ ìœ„ì—ì„œ []ë¡œ ì´ˆê¸°í™”ë¨
                    showMessage("ì €ì¥ëœ ì¹´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                }
            } else {
                // ë¹„ë¡œê·¸ì¸: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ (common.jsì˜ logoutì—ì„œ ì‚­ì œë˜ì—ˆì–´ì•¼ í•¨)
                const localData = loadFromLocalStorage('savedHealingCards');
                savedCards = localData || [];
                console.log("loadSavedCards: Loaded", savedCards.length, "cards from LocalStorage (no user).");
            }
            // renderSavedCards(); // authStateReady ë¦¬ìŠ¤ë„ˆì—ì„œ í˜¸ì¶œë¨
        }
        
        function renderSavedCards() {
            const savedCardsList = document.getElementById('savedCardsList');
            console.log('renderSavedCards: Rendering', savedCards.length, 'cards.');
            
            if (savedCards.length === 0) {
                savedCardsList.innerHTML = `
                    <div class="empty-saved">
                        <i class="fas fa-bookmark"></i>
                        <p>ì•„ì§ ì €ì¥í•œ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë§ˆìŒì— ë“œëŠ” ì¹´ë“œë¥¼ ì €ì¥í•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }
            
            savedCardsList.innerHTML = savedCards.map(card => `
                <div class="item-card saved-card-item"> <!-- .item-card í´ë˜ìŠ¤ ì¶”ê°€ -->
                    <div class="saved-card-message">${card.message}</div>
                    <div class="saved-card-meta">
                        <span><i class="${card.icon}"></i> ${card.category}</span>
                        <span>
                            ${formatSavedDate(card.savedAt)}
                            <button class="delete-saved-btn" onclick="deleteSavedCard('${card.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        function formatSavedDate(dateString) {
            if (!dateString) return 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
            const date = new Date(dateString);
            const now = new Date();
            
            // ë‚ ì§œë§Œ ë¹„êµí•˜ê¸° ìœ„í•´ ì‹œê°„ ì´ˆê¸°í™”
            const todayForCompare = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const savedDateForCompare = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            const diffTime = todayForCompare.getTime() - savedDateForCompare.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Use Math.floor for accurate day difference
            
            if (diffDays === 0) return 'ì˜¤ëŠ˜';
            if (diffDays === 1) return 'ì–´ì œ';
            if (diffDays > 1 && diffDays <= 7) return `${diffDays}ì¼ ì „`;
            return `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
        }
        
        async function deleteSavedCard(cardId) {
            if (!cardId) {
                console.error("deleteSavedCard: cardId is undefined or null.");
                return;
            }
            if (confirm('ì´ ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (currentUser) {
                    try {
                        await db.collection('savedCards').doc(cardId).delete();
                        showMessage('ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        // â˜…â˜…â˜… ì¤‘ìš”: Firebaseì—ì„œ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œ í›„, ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ UI ê°±ì‹ 
                        await loadSavedCards(); 
                        renderSavedCards();
                    } catch (error) {
                        console.error('Firebase ì¹´ë“œ ì‚­ì œ ì‹¤íŒ¨:', error);
                        showMessage('ì¹´ë“œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                    }
                } else {
                    // ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ì—ì„œë§Œ ì‚­ì œ
                    savedCards = savedCards.filter(card => card.id !== cardId);
                    saveToLocalStorage('savedHealingCards', savedCards);
                    renderSavedCards();
                    showMessage('ì¹´ë“œê°€ ë¡œì»¬ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            }
        }
        
        async function clearAllSavedCards() {
            if (confirm('ì €ì¥ëœ ëª¨ë“  ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                if (currentUser) {
                    try {
                        const snapshot = await db.collection('savedCards').where('userId', '==', currentUser.uid).get();
                        if (snapshot.empty) {
                            showMessage('ì‚­ì œí•  ì €ì¥ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                            savedCards = []; // ë¡œì»¬ë„ ë¹„ì›€
                            saveToLocalStorage('savedHealingCards', savedCards);
                            renderSavedCards();
                            return;
                        }
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        showMessage('ì €ì¥ëœ ëª¨ë“  ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        // â˜…â˜…â˜… ì¤‘ìš”: Firebaseì—ì„œ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œ í›„, ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œ (ë¹ˆ ë°°ì—´ì´ ë¨)
                        await loadSavedCards(); 
                        renderSavedCards();
                    } catch (error) {
                        console.error('Firebase ì „ì²´ ì¹´ë“œ ì‚­ì œ ì‹¤íŒ¨:', error);
                        showMessage('ì „ì²´ ì¹´ë“œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                    }
                } else {
                    // ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œì»¬ì—ì„œë§Œ ì‚­ì œ
                    if (savedCards.length === 0) {
                        showMessage('ì‚­ì œí•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                        return;
                    }
                    savedCards = []; 
                    saveToLocalStorage('savedHealingCards', savedCards); 
                    renderSavedCards(); 
                    showMessage('ì €ì¥ëœ ëª¨ë“  ì¹´ë“œê°€ ë¡œì»¬ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            }
        }
    </script>
</body>
</html>
