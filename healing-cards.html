<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íë§ ì¹´ë“œ - EmotiCare</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .cards-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .card-draw-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 3rem;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
        }
        
        .card-draw-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .card-draw-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }
        
        .draw-button {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            color: #333;
            border: none;
            padding: 1.5rem 3rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 234, 167, 0.4);
            margin-bottom: 1rem;
        }
        
        .draw-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(255, 234, 167, 0.6);
        }
        
        .draw-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .daily-limit {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .healing-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            margin: 2rem 0;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.5s ease;
            border: 3px solid transparent;
        }
        
        .healing-card.show {
            transform: scale(1);
            opacity: 1;
            border-color: #667eea;
        }
        
        .card-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 1.5rem;
        }
        
        .card-message {
            font-size: 1.3rem;
            line-height: 1.6;
            color: #333;
            margin-bottom: 2rem;
            font-weight: 500;
        }
        
        .card-category {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        
        .card-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .save-card-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .save-card-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .new-card-btn {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .new-card-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .saved-cards-section {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .saved-cards-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .saved-cards-list {
            display: grid;
            gap: 1.5rem;
        }
        
        .saved-card-item {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 1.5rem;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .saved-card-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        
        .saved-card-message {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .saved-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }
        
        .delete-saved-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .delete-saved-btn:hover {
            background: #ff5252;
        }
        
        .empty-saved {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-saved i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .time-based-message {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1 class="page-title">íë§ ì¹´ë“œ</h1>
                <p class="page-subtitle">ë§¤ì¼ ìƒˆë¡œìš´ íë§ ë©”ì‹œì§€ë¥¼ ë°›ì•„ë³´ê³  ë§ˆìŒì˜ ìœ„ë¡œë¥¼ ì–»ì–´ë³´ì„¸ìš”</p>
            </div>
        </section>
        
        <section class="page-content">
            <div class="cards-container">
                <div class="card-draw-section">
                    <h2 class="card-draw-title">ì˜¤ëŠ˜ì˜ íë§ ì¹´ë“œ</h2>
                    <p class="card-draw-subtitle">ë§ˆìŒì´ í•„ìš”ë¡œ í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ë°›ì•„ë³´ì„¸ìš”</p>
                    
                    <div class="time-based-message" id="timeMessage">
                        <!-- ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    
                    <button class="draw-button" id="drawButton" onclick="drawCard()">
                        <i class="fas fa-magic"></i> ì¹´ë“œ ë½‘ê¸°
                    </button>
                    
                    <div class="daily-limit" id="dailyLimit">
                        ì˜¤ëŠ˜ <span id="drawCount">0</span>/5 ì¹´ë“œë¥¼ ë½‘ìœ¼ì…¨ìŠµë‹ˆë‹¤
                    </div>
                </div>
                
                <div class="healing-card" id="healingCard">
                    <!-- ë½‘ì€ ì¹´ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="saved-cards-section">
                    <div class="saved-cards-header">
                        <h3>ë‚´ê°€ ì €ì¥í•œ íë§ ë©”ì‹œì§€</h3>
                        <button class="btn-outline" onclick="clearAllSavedCards()">
                            <i class="fas fa-trash"></i> ëª¨ë‘ ì‚­ì œ
                        </button>
                    </div>
                    
                    <div class="saved-cards-list" id="savedCardsList">
                        <!-- ì €ì¥ëœ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <div id="footer-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="common.js"></script>
    <script>
        let dailyDrawCount = 0;
        let savedCards = [];
        let currentCard = null;
        
        const healingMessages = {
            morning: [
                { message: "ìƒˆë¡œìš´ í•˜ë£¨ê°€ ì‹œì‘ë©ë‹ˆë‹¤. ì˜¤ëŠ˜ë„ ë‹¹ì‹ ì€ ì¶©ë¶„íˆ ì†Œì¤‘í•œ ì¡´ì¬ì…ë‹ˆë‹¤.", category: "ìê¸°ì‚¬ë‘", icon: "fas fa-heart" },
                { message: "ì•„ì¹¨ í–‡ì‚´ì²˜ëŸ¼ ë”°ëœ»í•œ ë§ˆìŒìœ¼ë¡œ í•˜ë£¨ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.", category: "í¬ë§", icon: "fas fa-sun" },
                { message: "ì–´ì œì˜ ê±±ì •ì€ ë‚´ë ¤ë†“ê³ , ì˜¤ëŠ˜ì˜ ê°€ëŠ¥ì„±ì— ì§‘ì¤‘í•´ë³´ì„¸ìš”.", category: "í˜„ì¬ì§‘ì¤‘", icon: "fas fa-leaf" },
                { message: "ë‹¹ì‹ ì˜ ì¡´ì¬ ìì²´ê°€ ì´ ì„¸ìƒì„ ë” ì•„ë¦„ë‹µê²Œ ë§Œë“­ë‹ˆë‹¤.", category: "ìê¸°ì‚¬ë‘", icon: "fas fa-star" },
                { message: "ì‘ì€ ê±¸ìŒì´ë¼ë„ ê´œì°®ìŠµë‹ˆë‹¤. ì²œì²œíˆ ë‚˜ì•„ê°€ì„¸ìš”.", category: "ê²©ë ¤", icon: "fas fa-seedling" }
            ],
            afternoon: [
                { message: "ì§€ê¸ˆê¹Œì§€ ì˜ í•´ì˜¤ê³  ìˆìŠµë‹ˆë‹¤. ìì‹ ì„ ë¯¿ì–´ë³´ì„¸ìš”.", category: "ê²©ë ¤", icon: "fas fa-thumbs-up" },
                { message: "ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì€ ì´ë¯¸ ì¶©ë¶„í•©ë‹ˆë‹¤.", category: "ìê¸°ìˆ˜ìš©", icon: "fas fa-heart" },
                { message: "ì ì‹œ ë©ˆì¶°ì„œ ê¹Šê²Œ ìˆ¨ì„ ì‰¬ì–´ë³´ì„¸ìš”. ì§€ê¸ˆ ì´ ìˆœê°„ì„ ëŠê»´ë³´ì„¸ìš”.", category: "ë§ˆìŒì±™ê¹€", icon: "fas fa-wind" },
                { message: "í˜ë“¤ ë•ŒëŠ” ì‰¬ì–´ê°€ë„ ë©ë‹ˆë‹¤. ê·¸ê²ƒë„ ìš©ê¸°ì…ë‹ˆë‹¤.", category: "ìœ„ë¡œ", icon: "fas fa-umbrella" },
                { message: "ë‹¹ì‹ ì˜ ë…¸ë ¥ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤. ìŠ¤ìŠ¤ë¡œë¥¼ ê²©ë ¤í•´ì£¼ì„¸ìš”.", category: "ê²©ë ¤", icon: "fas fa-medal" }
            ],
            evening: [
                { message: "ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ìì‹ ì—ê²Œ ë”°ëœ»í•œ ë§ì„ ê±´ë„¤ë³´ì„¸ìš”.", category: "ê°ì‚¬", icon: "fas fa-moon" },
                { message: "ì‘ì€ ì„±ì·¨ë¼ë„ ì¶•í•˜í•  ê°€ì¹˜ê°€ ìˆìŠµë‹ˆë‹¤.", category: "ìê¸°ì¸ì •", icon: "fas fa-gift" },
                { message: "ë‚´ì¼ì€ ìƒˆë¡œìš´ ê¸°íšŒê°€ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.", category: "í¬ë§", icon: "fas fa-sunrise" },
                { message: "ì˜¤ëŠ˜ì˜ ê²½í—˜ë“¤ì´ ë‹¹ì‹ ì„ ë” ì„±ì¥ì‹œì¼°ìŠµë‹ˆë‹¤.", category: "ì„±ì¥", icon: "fas fa-tree" },
                { message: "í‰ì•ˆí•œ ë°¤ ë˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤. ë‹¹ì‹ ì€ ì‚¬ë‘ë°›ì„ ìê²©ì´ ìˆìŠµë‹ˆë‹¤.", category: "ìê¸°ì‚¬ë‘", icon: "fas fa-heart" }
            ],
            general: [
                { message: "ë‹¹ì‹ ì˜ ê°ì •ì€ ëª¨ë‘ ì†Œì¤‘í•˜ê³  ì˜ë¯¸ê°€ ìˆìŠµë‹ˆë‹¤.", category: "ê°ì •ìˆ˜ìš©", icon: "fas fa-rainbow" },
                { message: "í˜ë“  ì‹œê°„ë„ ì§€ë‚˜ê°‘ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì´ê²¨ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", category: "í¬ë§", icon: "fas fa-mountain" },
                { message: "ìì‹ ì—ê²Œ ì¹œì ˆí•˜ì„¸ìš”. ë‹¹ì‹ ì€ ìµœì„ ì„ ë‹¤í•˜ê³  ìˆìŠµë‹ˆë‹¤.", category: "ìê¸°ì‚¬ë‘", icon: "fas fa-heart" },
                { message: "ëª¨ë“  ê²ƒì´ ì™„ë²½í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. ì§€ê¸ˆ ì´ëŒ€ë¡œë„ ì¶©ë¶„í•©ë‹ˆë‹¤.", category: "ìê¸°ìˆ˜ìš©", icon: "fas fa-check-circle" },
                { message: "ë‹¹ì‹ ì˜ ì¡´ì¬ë§Œìœ¼ë¡œë„ ëˆ„êµ°ê°€ì—ê²ŒëŠ” í° ì˜ë¯¸ì…ë‹ˆë‹¤.", category: "ì¡´ì¬ê°€ì¹˜", icon: "fas fa-star" }
            ]
        };
        
        const timeBasedMessages = {
            morning: "ğŸŒ… ìƒˆë¡œìš´ í•˜ë£¨ë¥¼ ì‹œì‘í•˜ëŠ” ë‹¹ì‹ ì—ê²Œ íŠ¹ë³„í•œ ë©”ì‹œì§€ë¥¼ ì „í•´ë“œë¦½ë‹ˆë‹¤.",
            afternoon: "â˜€ï¸ í•˜ë£¨ ì¤‘ë°˜, ì—ë„ˆì§€ë¥¼ ì¶©ì „í•  ìˆ˜ ìˆëŠ” ë©”ì‹œì§€ë¥¼ ë°›ì•„ë³´ì„¸ìš”.",
            evening: "ğŸŒ™ í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•˜ë©° ë§ˆìŒì„ í¸ì•ˆí•˜ê²Œ í•´ì¤„ ë©”ì‹œì§€ì…ë‹ˆë‹¤.",
            night: "âœ¨ ê¹Šì€ ë°¤, ë‚´ì¼ì„ ìœ„í•œ í¬ë§ì˜ ë©”ì‹œì§€ë¥¼ ì „í•´ë“œë¦½ë‹ˆë‹¤."
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            loadDailyData();
            loadSavedCards();
            updateTimeMessage();
            renderSavedCards();
        });
        
        function updateTimeMessage() {
            const hour = new Date().getHours();
            let timeKey;
            
            if (hour >= 6 && hour < 12) {
                timeKey = 'morning';
            } else if (hour >= 12 && hour < 18) {
                timeKey = 'afternoon';
            } else if (hour >= 18 && hour < 22) {
                timeKey = 'evening';
            } else {
                timeKey = 'night';
            }
            
            document.getElementById('timeMessage').textContent = timeBasedMessages[timeKey];
        }
        
        function loadDailyData() {
            const today = getCurrentDate();
            const dailyData = loadFromLocalStorage('dailyCardData') || {};
            
            if (dailyData.date === today) {
                dailyDrawCount = dailyData.drawCount || 0;
            } else {
                dailyDrawCount = 0;
                saveToLocalStorage('dailyCardData', { date: today, drawCount: 0 });
            }
            
            updateDrawButton();
        }
        
        function updateDrawButton() {
            const drawButton = document.getElementById('drawButton');
            const drawCountSpan = document.getElementById('drawCount');
            
            drawCountSpan.textContent = dailyDrawCount;
            
            if (dailyDrawCount >= 5) {
                drawButton.disabled = true;
                drawButton.innerHTML = '<i class="fas fa-clock"></i> ë‚´ì¼ ë‹¤ì‹œ ë½‘ì•„ë³´ì„¸ìš”';
            } else {
                drawButton.disabled = false;
                drawButton.innerHTML = '<i class="fas fa-magic"></i> ì¹´ë“œ ë½‘ê¸°';
            }
        }
        
        function drawCard() {
            if (dailyDrawCount >= 5) {
                showMessage('í•˜ë£¨ì— ìµœëŒ€ 5ì¥ê¹Œì§€ë§Œ ë½‘ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const hour = new Date().getHours();
            let messagePool;
            
            if (hour >= 6 && hour < 12) {
                messagePool = healingMessages.morning;
            } else if (hour >= 12 && hour < 18) {
                messagePool = healingMessages.afternoon;
            } else if (hour >= 18 && hour < 24) {
                messagePool = healingMessages.evening;
            } else {
                messagePool = healingMessages.general;
            }
            
            // ì¼ë°˜ ë©”ì‹œì§€ë„ í¬í•¨
            const allMessages = [...messagePool, ...healingMessages.general];
            currentCard = getRandomItem(allMessages);
            
            displayCard(currentCard);
            
            // ë½‘ê¸° íšŸìˆ˜ ì¦ê°€
            dailyDrawCount++;
            const today = getCurrentDate();
            saveToLocalStorage('dailyCardData', { date: today, drawCount: dailyDrawCount });
            updateDrawButton();
        }
        
        function displayCard(card) {
            const cardElement = document.getElementById('healingCard');
            
            cardElement.innerHTML = `
                <div class="card-icon">
                    <i class="${card.icon}"></i>
                </div>
                <div class="card-category">${card.category}</div>
                <div class="card-message">${card.message}</div>
                <div class="card-actions">
                    <button class="save-card-btn" onclick="saveCurrentCard()">
                        <i class="fas fa-bookmark"></i> ì €ì¥í•˜ê¸°
                    </button>
                    <button class="new-card-btn" onclick="drawCard()">
                        <i class="fas fa-sync-alt"></i> ìƒˆ ì¹´ë“œ ë½‘ê¸°
                    </button>
                </div>
            `;
            
            cardElement.classList.add('show');
        }
        
        async function saveCurrentCard() {
            if (!currentCard) return;
            
            const savedCard = {
                ...currentCard,
                id: Date.now().toString(),
                savedAt: new Date().toISOString()
            };
            
            savedCards.unshift(savedCard);
            
            // ë¡œì»¬ ì €ì¥
            saveToLocalStorage('savedHealingCards', savedCards);
            
            // Firebase ì €ì¥ (ë¡œê·¸ì¸ëœ ê²½ìš°)
            if (currentUser) {
                await saveToFirestore('savedCards', savedCard.id, savedCard);
            }
            
            renderSavedCards();
            showMessage('ì¹´ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        function loadSavedCards() {
            const localCards = loadFromLocalStorage('savedHealingCards');
            if (localCards) {
                savedCards = localCards;
            }
        }
        
        function renderSavedCards() {
            const savedCardsList = document.getElementById('savedCardsList');
            
            if (savedCards.length === 0) {
                savedCardsList.innerHTML = `
                    <div class="empty-saved">
                        <i class="fas fa-bookmark"></i>
                        <p>ì•„ì§ ì €ì¥í•œ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë§ˆìŒì— ë“œëŠ” ì¹´ë“œë¥¼ ì €ì¥í•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }
            
            savedCardsList.innerHTML = savedCards.map(card => `
                <div class="saved-card-item">
                    <div class="saved-card-message">${card.message}</div>
                    <div class="saved-card-meta">
                        <span><i class="${card.icon}"></i> ${card.category}</span>
                        <span>
                            ${formatSavedDate(card.savedAt)}
                            <button class="delete-saved-btn" onclick="deleteSavedCard('${card.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        function formatSavedDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                return 'ì˜¤ëŠ˜';
            } else if (diffDays === 2) {
                return 'ì–´ì œ';
            } else if (diffDays <= 7) {
                return `${diffDays - 1}ì¼ ì „`;
            } else {
                return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
            }
        }
        
        async function deleteSavedCard(cardId) {
            savedCards = savedCards.filter(card => card.id !== cardId);
            saveToLocalStorage('savedHealingCards', savedCards);
            
            // Firebaseì—ì„œë„ ì‚­ì œ (ë¡œê·¸ì¸ëœ ê²½ìš°)
            if (currentUser) {
                try {
                    await db.collection('savedCards').doc(cardId).delete();
                } catch (error) {
                    console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
                }
            }
            
            renderSavedCards();
            showMessage('ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        function clearAllSavedCards() {
            if (savedCards.length === 0) {
                showMessage('ì‚­ì œí•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (confirm('ì €ì¥ëœ ëª¨ë“  ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                savedCards = [];
                saveToLocalStorage('savedHealingCards', savedCards);
                renderSavedCards();
                showMessage('ëª¨ë“  ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
    </script>
</body>
</html>
